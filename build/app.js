import{LX as e}from"lexgui";import"lexgui/extensions/CodeEditor.js";const t="data:image/gif;base64,R0lGODlhAQABAPcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAAP8ALAAAAAABAAEAAAgEAP8FBAA7",n=["All","Multipass","Compute","Keyboard","Sound"],a=["Popular","Trending","Recent"],o={popular:{field:"like_count",direction:"desc"},trending:{field:"view_count",direction:"desc"},recent:{field:"$createdAt",direction:"desc"}},s=[{name:"iTime",type:{webgpu:"f32",webgl:"float"},info:"Shader playback time (s)"},{name:"iTimeDelta",type:{webgpu:"f32",webgl:"float"},info:"Render time (s)"},{name:"iFrame",type:{webgpu:"i32",webgl:"int"},info:"Shader playback frame"},{name:"iResolution",type:{webgpu:"vec2f",webgl:"vec2"},info:"Viewport resolution (px)"},{name:"iMouse",type:{webgpu:"MouseData",webgl:"MouseData"},info:"{ pos, start, delta, press, click }"},{name:"iChannel0..3",type:{webgpu:"texture_2d<f32>",webgl:"sampler2D"},info:"Texture input channel",skipBindings:!0}],i=s.map(e=>e.name),r={iMouse:[{name:"pos",size:2},{name:"start",size:2},{name:"delta",size:2},{name:"press",size:1},{name:"click",size:1}]},l={f32:"float",i32:"int",u32:"uint",vec2f:"vec2",vec3f:"vec3",vec4f:"vec4",vec2i:"ivec2",vec3i:"ivec3",vec4i:"ivec4",vec2u:"uvec2",vec3u:"uvec3",vec4u:"uvec4",mat2x2f:"mat2",mat2x3f:"mat2x3",mat2x4f:"mat2x4",mat3x2f:"mat3x2",mat3x3f:"mat3",mat3x4f:"mat3x4",mat4x2f:"mat4x2",mat4x3f:"mat4x3",mat4x4f:"mat4",sampler:"sampler",sampler_comparison:"samplerShadow",texture_2d:"sampler2D",texture_2d_array:"sampler2DArray",texture_cube:"samplerCube"};class c{static PROJECT_ID="68b709f30027f98a667b";static END_POINT="https://cloud.appwrite.io/v1";static DATABASE_ID="68b70c8f002d2fe08d90";static BUCKET_ID="68b70c6b0004ae91e454";static SHADERS_COLLECTION_ID="shaders";static USERS_COLLECTION_ID="users";static ASSETS_COLLECTION_ID="assets";static INTERACTIONS_COLLECTION_ID="interactions";constructor(){this.client=(new Appwrite.Client).setEndpoint(c.END_POINT).setProject(c.PROJECT_ID),this.account=new Appwrite.Account(this.client),this.databases=new Appwrite.Databases(this.client),this.storage=new Appwrite.Storage(this.client),this._assetsCache=new Map}getUserId(){return this.user.$id}async detectAutoLogin(){try{this.user=await this.account.get(),this.session=await this.account.getSession("current"),console.log("Autologged",this.user)}catch(e){console.warn("No current session")}}async createAccount(e,t,n,a,o){console.assert(e&&t&&n),await this.account.create({userId:"unique()",email:e,password:t,name:n}).then(e=>{a&&a(e)}).catch(e=>{console.error(e),o&&o(e?.message)})}async login(e,t,n,a){await this.account.createEmailPasswordSession({email:e,password:t}).then(async e=>{this.user=await this.account.get(),this.session=e,console.log("Login",this.user),n&&n(this.user,this.session)}).catch(e=>{a&&a(e?.message)})}async logout(){if(this.user)try{const e=await this.account.getSession("current");await this.account.deleteSession({sessionId:e.$id}),this.user=null,console.log("Logged out!")}catch(e){console.error(e)}}async listDocuments(e,t=[]){const n=t.join("_");if(e===c.ASSETS_COLLECTION_ID&&t.length&&this._assetsCache.has(n))return this._assetsCache.get(n);const a=await this.databases.listDocuments({databaseId:c.DATABASE_ID,collectionId:e,queries:t});return e===c.ASSETS_COLLECTION_ID&&this._assetsCache.set(n,a),a}async getDocument(e,t){if(e===c.ASSETS_COLLECTION_ID&&this._assetsCache.has(t))return this._assetsCache.get(t);const n=await this.databases.getDocument({databaseId:c.DATABASE_ID,collectionId:e,documentId:t});return e===c.ASSETS_COLLECTION_ID&&this._assetsCache.set(t,n),n}async createDocument(e,t){return await this.databases.createDocument({databaseId:c.DATABASE_ID,collectionId:e,documentId:"unique()",data:t})}async updateDocument(e,t,n){return await this.databases.updateDocument({databaseId:c.DATABASE_ID,collectionId:e,documentId:t,data:n})}async deleteDocument(e,t){return await this.databases.deleteDocument({databaseId:c.DATABASE_ID,collectionId:e,documentId:t})}async listFiles(e=[]){return await this.storage.listFiles({bucketId:c.BUCKET_ID,queries:e})}async getFile(e){return await this.storage.getFile({bucketId:c.BUCKET_ID,fileId:e})}async getFileUrl(e){return await this.storage.getFileView({bucketId:c.BUCKET_ID,fileId:e})}async getFileContent(e){const t=await this.getFileUrl(e);return await this.requestFile(t)}async createFile(e,t){return await this.storage.createFile({bucketId:c.BUCKET_ID,fileId:t??"unique()",file:e})}async deleteFile(e){return await this.storage.deleteFile({bucketId:c.BUCKET_ID,fileId:e})}async getImagePreview(e,t){return await this.storage.getFilePreview({bucketId:c.BUCKET_ID,fileId:e,...t})}async requestFile(e,t,n){return new Promise((a,o)=>{const s="arraybuffer"===(t=t??"arraybuffer")?"application/octet-stream":void 0;var i=new XMLHttpRequest;return i.open("GET",e,!0),i.responseType=t,s&&i.overrideMimeType(s),n&&i.setRequestHeader("Cache-Control","no-cache"),i.onload=function(e){var t=this.response;if(200==this.status)a(t);else{var n="Error "+this.status;o(n)}},i.onerror=function(e){o(e)},i.send(),i})}logDebug(e,...t){console.log(`%cAppwrite%c ${e}`,"background:#111827;color:#60a5fa;padding:2px 6px;border-radius:4px;font-weight:600","color:#9ca3af;font-weight:500",...t)}logResponse(e,t){t?this.logSuccess(e,t):this.logError(e,t)}logSuccess(e,...t){console.log(`%cAppwrite%c ${e}`,"background:#112718;color:#60faa5;padding:2px 6px;border-radius:4px;font-weight:600","color:#34d399;font-weight:500",...t)}logError(e,...t){console.log(`%cAppwrite%c ${e}`,"background:#271811;color:#60a5fa;padding:2px 6px;border-radius:4px;font-weight:600","color:#ef4444;font-weight:500",...t)}async _downloadDatabasesBackup(){const e=[{id:c.SHADERS_COLLECTION_ID,name:"shaders"},{id:c.USERS_COLLECTION_ID,name:"users"},{id:c.ASSETS_COLLECTION_ID,name:"assets"},{id:c.INTERACTIONS_COLLECTION_ID,name:"interactions"}],t={timestamp:(new Date).toISOString(),database:c.DATABASE_ID,collections:{}};for(const n of e){console.log(`Backing up ${n.name}...`);const e=[],a=100;let o=0,s=1/0;for(;o<s;){const t=await this.databases.listDocuments({databaseId:c.DATABASE_ID,collectionId:n.id,queries:[Appwrite.Query.limit(a),Appwrite.Query.offset(o)]});s=t.total,e.push(...t.documents),o+=a}t.collections[n.name]={total:e.length,documents:e},console.log(`  ${n.name}: ${e.length} documents`)}const n=JSON.stringify(t,null,2),a=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=`shaderhub-dbs-${(new Date).toISOString().slice(0,10)}.json`,s.click(),URL.revokeObjectURL(o),console.log("DB backup downloaded!")}async _downloadFilesBackup(){const e=new JSZip,t=[];let n=0,a=1/0;for(;n<a;){const e=await this.storage.listFiles({bucketId:c.BUCKET_ID,queries:[Appwrite.Query.limit(100),Appwrite.Query.offset(n)]});a=e.total,t.push(...e.files),n+=100}console.log(`  Found ${t.length} files, downloading...`);for(let n=0;n<t.length;n++){const a=t[n];console.log(`  [${n+1}/${t.length}] ${a.name}`);try{const t=await this.storage.getFileDownload({bucketId:c.BUCKET_ID,fileId:a.$id});e.file(a.name,t)}catch(e){console.error(`  Failed to download ${a.name}:`,e.message)}}const o=await e.generateAsync({type:"blob"}),s=URL.createObjectURL(o),i=document.createElement("a");i.href=s,i.download=`shaderhub-files-${(new Date).toISOString().slice(0,10)}.zip`,i.click(),URL.revokeObjectURL(s),console.log("Storage backup downloaded!")}_downloadBackup(){if(!this.user||!this.user.$id)return alert("You must be logged in to download backups.");this._downloadDatabasesBackup(),this._downloadFilesBackup()}}class d{constructor(e,t){this.backend=t,this.canvas=e,this.lang="WGSL",this.gpuTextures={},this.gpuBuffers={}}async init(){this.nearestSampler=this.createSampler(),this.bilinearSampler=this.createSampler({magFilter:"linear",minFilter:"linear"}),this.trilinearSampler=this.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),this.nearestRepeatSampler=this.createSampler({addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat"}),this.bilinearRepeatSampler=this.createSampler({magFilter:"linear",minFilter:"linear",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat"}),this.trilinearRepeatSampler=this.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",addressModeU:"repeat",addressModeV:"repeat",addressModeW:"repeat"})}createBuffer(e={}){}createSampler(e={}){}createTexture(e={}){}async createTextureFromImage(e,t,n="",a={}){return null}async createCubemapTextureFromImage(e,t,n="",a={}){return null}updateTexture(e,t){}updateFrame(e,t,n,a){}updateResolution(e,t,n){}updateMouse(e,t){}generateMipmaps(e,t){}fail(t,n){new e.Dialog(n??`❌ ${this.backend} Error`,e=>{e.root.classList.add("p-4"),e.root.innerHTML=t},{modal:!0})}}const u={magFilter:{nearest:WebGL2RenderingContext.NEAREST,linear:WebGL2RenderingContext.LINEAR},minFilter:{nearest:WebGL2RenderingContext.NEAREST,linear:WebGL2RenderingContext.LINEAR,"nearest-mipmap-nearest":WebGL2RenderingContext.NEAREST_MIPMAP_NEAREST,"linear-mipmap-nearest":WebGL2RenderingContext.LINEAR_MIPMAP_NEAREST,"nearest-mipmap-linear":WebGL2RenderingContext.NEAREST_MIPMAP_LINEAR,"linear-mipmap-linear":WebGL2RenderingContext.LINEAR_MIPMAP_LINEAR},addressMode:{"clamp-to-edge":WebGL2RenderingContext.CLAMP_TO_EDGE,repeat:WebGL2RenderingContext.REPEAT,"mirror-repeat":WebGL2RenderingContext.MIRRORED_REPEAT}};class p extends d{constructor(e,t){super(e,t),this.lang="GLSL"}async init(){if(this.gl=this.canvas.getContext("webgl2",{alpha:!1,antialias:!0,depth:!0,stencil:!1,preserveDrawingBuffer:!1}),1===this.quitIfWebGLNotAvailable())return;const e=this.gl,t=window.devicePixelRatio;this.canvas.width=this.canvas.clientWidth*t,this.canvas.height=this.canvas.clientHeight*t,e.viewport(0,0,this.canvas.width,this.canvas.height),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.BLEND);const n=new Float32Array([-1,-1,3,-1,-1,3]);this.fullscreenVBO=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.fullscreenVBO),e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),super.init()}createBuffer(e={}){const t=this.gl,n=t.createBuffer();return t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,e.size??0,t.DYNAMIC_DRAW),t.bindBuffer(t.UNIFORM_BUFFER,null),n}createSampler(e={}){const t=this.gl,n=t.createSampler(),a=u.magFilter[e.magFilter??"nearest"],o=u.minFilter[e.minFilter??"nearest"],s=u.addressMode[e.addressModeU??"clamp-to-edge"],i=u.addressMode[e.addressModeV??"clamp-to-edge"];if(t.samplerParameteri(n,t.TEXTURE_MAG_FILTER,a),t.samplerParameteri(n,t.TEXTURE_MIN_FILTER,o),t.samplerParameteri(n,t.TEXTURE_WRAP_S,s),t.samplerParameteri(n,t.TEXTURE_WRAP_T,i),e.addressModeW&&void 0!==t.TEXTURE_WRAP_R){const a=u.addressMode[e.addressModeW];t.samplerParameteri(n,t.TEXTURE_WRAP_R,a)}return n}createTexture(e={}){const t=this.gl,n=e.size?.[0]??1,a=e.size?.[1]??1,o=e.format??"rgba8unorm",s=t.RGBA8,i=t.UNSIGNED_BYTE,r=t.RGBA,l=t.createTexture();t.bindTexture(t.TEXTURE_2D,l),t.texImage2D(t.TEXTURE_2D,0,s,n,a,0,r,i,null);let c=null;if(e.usage&GPUTextureUsage.RENDER_ATTACHMENT){t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),c=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,c),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,l,0);const e=t.checkFramebufferStatus(t.FRAMEBUFFER);e!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer incomplete:",e),t.bindFramebuffer(t.FRAMEBUFFER,null)}return t.bindTexture(t.TEXTURE_2D,null),{texture:l,framebuffer:c,width:n,height:a,depthOrArrayLayers:1,format:o}}updateTexture(e,t){const n=this.gl;return n.bindTexture(n.TEXTURE_2D,e),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.bindTexture(n.TEXTURE_2D,null),e}async createTextureFromImage(e,t,n="",a={}){a.flipY=a.flipY??!0,a.useMipmaps=a.useMipmaps??!0;const o=this.gl,s=await createImageBitmap(await new Blob([e]),{imageOrientation:a.flipY?"flipY":"none"}),i=o.createTexture();return i.depthOrArrayLayers=1,o.bindTexture(o.TEXTURE_2D,i),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,s),a.useMipmaps?o.generateMipmap(o.TEXTURE_2D):o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.bindTexture(o.TEXTURE_2D,null),this.gpuTextures[t]=i,i}async createCubemapTextureFromImage(e,t,n="",a={}){a.flipY=a.flipY??!1,a.useMipmaps=a.useMipmaps??!0;const o=this.gl,s=await JSZip.loadAsync(e),i=["px","nx","ny","py","pz","nz"],r=[];for(const e of i){const t=s.file(`${e}.png`)||s.file(`${e}.jpg`);if(!t)throw new Error(`Missing cubemap face: ${e}`);const n=await t.async("blob"),o=await createImageBitmap(n,{imageOrientation:a.flipY?"flipY":"none"});r.push(o)}const l=o.createTexture();l.depthOrArrayLayers=6,o.bindTexture(o.TEXTURE_CUBE_MAP,l);for(let e=0;e<r.length;++e){const t=r[e];o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,t)}return a.useMipmaps?o.generateMipmap(o.TEXTURE_CUBE_MAP):o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_R,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.bindTexture(o.TEXTURE_CUBE_MAP,null),this.gpuTextures[t]=l,l}updateFrame(e,t,n,a){const o=this.gl;if(o)for(const s of a.passes)s.setUniform(o,"iTime",t),s.setUniform(o,"iTimeDelta",e),s.setUniform(o,"iFrame",n)}updateResolution(e,t,n){const a=this.gl;if(a)for(const o of n.passes)o.setUniform(a,"iResolution",[e??this.canvas.offsetWidth,t??this.canvas.offsetHeight])}updateMouse(e,t){const n=this.gl;if(!n)return;const a={};let o=0;for(const t of r.iMouse)1===t.size?a[t.name]=e[o]:a[t.name]=e.slice(o,o+t.size),o+=t.size;for(const e of t.passes)e.setUniform(n,"iMouse",a)}generateMipmaps(e,t){const n=this.device.createCommandEncoder();for(let a=0;a<t-1;a++){const t=e.createView({baseMipLevel:a,mipLevelCount:1}),o=e.createView({baseMipLevel:a+1,mipLevelCount:1}),s=this.device.createBindGroup({layout:this.mipmapPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:t},{binding:1,resource:o}]}),i=n.beginComputePass();i.setPipeline(this.mipmapPipeline),i.setBindGroup(0,s);const r=Math.max(1,e.width>>a+1),l=Math.max(1,e.height>>a+1);i.dispatchWorkgroups(Math.ceil(r/8),Math.ceil(l/8)),i.end()}this.device.queue.submit([n.finish()])}quitIfWebGLNotAvailable(){return this.gl?0:(this.fail("WebGL2 not available"),1)}}class m{constructor(e,t,n){this.shader=e,this.name=n.name,this.renderer=t,this.device=t.device,this.type=n.type??"image",this.resolution=[n.resolutionX??0,n.resolutionY??0],this.codeLines=[...n.codeLines??this.shader.getDefaultCode(this)],this.channels=[...n.channels??[]],this.uniforms=[...n.uniforms??[]],this.channelTextures=[],this.uniformBuffers=[],this.defines={},this.pipeline=null,this.bindGroup=null,this.uniformsDirty=!1,this.frameCount=0;for(let e=0;e<this.channels.length;++e){let t=this.channels[e];t&&(t.constructor!==Object&&(this.channels[e]={id:t,category:"empty"},t=this.channels[e]),t.filter=t.filter??"linear",t.wrap=t.wrap??"clamp")}"buffer"===this.type?this.textures=[t.createTexture({label:"Buffer Pass Texture A",size:[this.resolution[0],this.resolution[1],1],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),t.createTexture({label:"Buffer Pass Texture B",size:[this.resolution[0],this.resolution[1],1],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})]:"compute"===this.type&&(this.computePipelines=[],this.storageBuffers={},this.textures=[t.createTexture({label:"Compute Pass Texture A",size:[this.resolution[0],this.resolution[1],1],format:"rgba16float",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC}),t.createTexture({label:"Compute Pass Texture B",size:[this.resolution[0],this.resolution[1],1],format:"rgba16float",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC})])}async execute(e){if("common"!==this.type){if(this.mustCompile||!this.pipeline&&!(this.computePipelines??[]).length||!this.bindGroup){if(0!==await this.compile(e))return}if("image"===this.type){const t=this.device.createCommandEncoder(),n={colorAttachments:[{view:e.webGPUContext.getCurrentTexture().createView(),clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"}]},a=t.beginRenderPass(n);a.setPipeline(this.pipeline),this.bindGroup&&a.setBindGroup(0,this.bindGroup),a.draw(6),a.end(),this.device.queue.submit([t.finish()])}else if("buffer"===this.type){if(!this.textures[0]||!this.textures[1])return;const e=this.device.createCommandEncoder(),t={colorAttachments:[{view:this.textures[(this.frameCount+1)%2].createView(),clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"}]},n=e.beginRenderPass(t);n.setPipeline(this.pipeline);const a=this.frameCount%2==0?this.bindGroup:this.bindGroupB;a&&n.setBindGroup(0,a),n.draw(6),n.end(),this.device.queue.submit([e.finish()]),this.frameCount++}else if("compute"===this.type){if(!this.textures[0]||!this.textures[1])return;const e=this.device.createCommandEncoder();for(const t of this.computePipelines){if(t.executeOnce&&t.executionDone)continue;const n=e.beginComputePass();n.setPipeline(t.pipeline);const a=this.frameCount%2==0?t.bindGroup:t.bindGroupB;a&&n.setBindGroup(0,a);const o=this.frameCount%2==0?t.storageBindGroupB:t.storageBindGroup;o&&n.setBindGroup(1,o);const s=t.workGroupSize[0],i=t.workGroupSize[1],r=t.workGroupSize[2]??1,l=t.workGroupCount[0]??Math.ceil(this.resolution[0]/s),c=t.workGroupCount[1]??Math.ceil(this.resolution[1]/i),d=t.workGroupCount[2]??r;n.dispatchWorkgroups(l,c,d),n.end(),t.executionDone=!0}this.device.queue.submit([e.finish()]),this.frameCount++}}}async createPipeline(e){if("common"!==this.type){if("image"!==this.type&&"buffer"!==this.type){const e=this.extractComputeFunctions(this.codeLines);this.computePipelines=[];let t=this.codeLines.join("\n"),n="";for(const[n,a]of Object.entries(e))t=t.replace(a,"");t=t.trim();for(const[a,o]of Object.entries(e)){const e=a.replace("mainCompute","compute_main"),s=`${t}\n${o.includes("mainCompute")?"":"fn mainCompute(id: vec3u) { }"}`,i=await this.validate(e,`${s}\n${o}`);if(!i.valid)return i;const r=await this.device.createComputePipeline({label:`Compute Pipeline Entry: ${e}`,layout:"auto",compute:{module:i.module,entryPoint:e}});r.defaultBindings=i.defaultBindings,r.customBindings=i.customBindings,r.textureBindings=i.textureBindings,r.samplerBindings=i.samplerBindings,r.storageBindings=i.storageBindings,n+=i.code,this.computePipelines.push({pipeline:r,usesComputeScreenTexture:i.usesComputeScreenTexture,executeOnce:i.executeOnce[e]??!1,workGroupSize:i.wgSizes[e]??[16,16,1],workGroupCount:i.wgCounts[e]??[]})}return this.codeContent=n,console.warn("Info: Compute Pipeline created!"),this.computePipelines[0].pipeline}{const t=await this.validate();if(!t.valid)return t;this.pipeline=await this.device.createRenderPipeline({label:`Render Pipeline: ${this.name}`,layout:"auto",vertex:{module:t.module},fragment:{module:t.module,targets:[{format:e}]},primitive:{topology:"triangle-list"}}),this.pipeline.defaultBindings=t.defaultBindings,this.pipeline.customBindings=t.customBindings,this.pipeline.textureBindings=t.textureBindings,this.pipeline.samplerBindings=t.samplerBindings,this.codeContent=t.code,console.warn("Info: Render Pipeline created!")}return this.pipeline}}async createBindGroup(e,t){const n=e.pipeline??e;if(!n)return;let a=0;const o=[];console.assert(n.defaultBindings,"Pipeline does not have a default bindings list!"),console.assert(n.customBindings,"Pipeline does not have a custom bindings list!"),console.assert(n.textureBindings,"Pipeline does not have a texture bindings list!"),console.assert(n.samplerBindings,"Pipeline does not have a sampler bindings list!"),Object.entries(n.defaultBindings).forEach(e=>{const[s,i]=e,r=a++;console.assert(r===i,`Default binding indices do not match in pipeline: ${n.label}`),o.push({binding:r,resource:{buffer:t[s]}})});this.uniforms.length&&this.uniforms.forEach((e,t)=>{if(void 0===n.customBindings[e.name])return;const s=a++;console.assert(s===n.customBindings[e.name],`Custom binding indices do not match in pipeline: ${n.label}`);const i=this.uniformBuffers[t];this.device.queue.writeBuffer(i,0,new Float32Array([e.value])),o.push({binding:s,resource:{buffer:i}})});const s=Object.keys(n.textureBindings).length>0;let i=a,r=[...o];return s&&(o.push(...this.channels.map((e,t)=>{if(!e)return;if(!n.textureBindings[e.id])return;let o=this.channelTextures[t];if(!o)return;const s=a++;console.assert(s===n.textureBindings[e.id],`Texture binding indices do not match in pipeline: ${n.label}`),o=o instanceof Array?o[0]:o;return{binding:s,resource:o.depthOrArrayLayers>1?o.createView({dimension:"cube"}):o.createView()}}).filter(e=>void 0!==e)),Object.entries(n.samplerBindings).forEach(e=>{const[t,s]=e,i=a++;console.assert(i===s,`Sampler binding indices do not match in pipeline: ${n.label}`),o.push({binding:i,resource:this.renderer[t]})})),"compute"===this.type&&e.usesComputeScreenTexture&&o.push({binding:a++,resource:this.textures[0].createView()}),this.bindGroup=await this.device.createBindGroup({label:"Bind Group A",layout:n.getBindGroupLayout(0),entries:o}),"buffer"!==this.type&&"compute"!==this.type||(s&&(r.push(...this.channels.map((e,t)=>{if(!e)return;if(!n.textureBindings[e.id])return;let a=this.channelTextures[t];if(!a)return;const o=i++;console.assert(o===n.textureBindings[e.id],`Texture binding indices do not match in pipeline: ${n.label}`),a=a instanceof Array?a[1]:a;return{binding:o,resource:a.depthOrArrayLayers>1?a.createView({dimension:"cube"}):a.createView()}}).filter(e=>void 0!==e)),Object.entries(n.samplerBindings).forEach(e=>{const[t,a]=e,o=i++;console.assert(o===a,`Sampler binding indices do not match in pipeline: ${n.label}`),r.push({binding:o,resource:this.renderer[t]})})),"compute"===this.type&&e.usesComputeScreenTexture&&r.push({binding:i++,resource:this.textures[1].createView()}),this.bindGroupB=await this.device.createBindGroup({label:"Bind Group B",layout:n.getBindGroupLayout(0),entries:r})),console.warn("Info: Bind Group created!"),this.bindGroup}async createStorageBindGroup(e,t){if(!e)return;const n=[];for(const[a,o]of Object.entries(e.storageBindings)){const e=this.storageBuffers[a];console.assert(e,`Storage buffer '${a}' not created!`);const s=t?e.resourceB:e.resource;n.push({binding:o,resource:{buffer:s}})}const a=await this.device.createBindGroup({label:"Storage Bind Group "+(t?"B":"A"),layout:e.getBindGroupLayout(1),entries:n});return this["storageBindGroup"+(t?"B":"")]=a,console.warn("Info: Storage Bind Group created!"),a}async compile(e){const t=e.presentationFormat,n=e.gpuBuffers;this.defines={SCREEN_WIDTH:this.resolution[0],SCREEN_HEIGHT:this.resolution[1]},"compute"===this.type&&(this.storageBuffers={});const a=await this.createPipeline(t);if(a?.constructor!==GPURenderPipeline&&a?.constructor!==GPUComputePipeline)return a;const o=[this.pipeline,...this.computePipelines??[]];for(const e of o){if(!e)continue;const t=await this.createBindGroup(e,n);if(e.bindGroup=this.bindGroup,e.bindGroupB=this.bindGroupB,t?.constructor!==GPUBindGroup)return 1}if("compute"===this.type){const e=this.computePipelines??[];for(const t of e){const e=await this.createStorageBindGroup(t.pipeline);if(t.storageBindGroup=e,e?.constructor!==GPUBindGroup)return 1;const n=await this.createStorageBindGroup(t.pipeline,!0);if(t.storageBindGroupB=n,n?.constructor!==GPUBindGroup)return 1}}return this.frameCount=0,this.mustCompile=!1,0}async validate(e,t){const n=this.getShaderCode(!0,e,t),a=this.device.createShaderModule({code:n.code}),o=await a.getCompilationInfo();if(o.messages.length>0){let e=[];for(const t of o.messages)"error"===t.type&&e.push(t);if(e.length>0)return console.log(t??""),{valid:!1,code:n.code,messages:e}}return{valid:!0,module:a,...n}}resetExecution(){(this.computePipelines??[]).forEach(e=>e.executionDone=!1),this.frameCount=0}extractComputeFunctions(e){let t={},n=null;for(const a of e)if(a.startsWith("@compute")||a.startsWith("fn mainCompute")){if(n){const e=n.join("\n"),a=/(@compute[\s\S]*?fn\s+([A-Za-z_]\w*)\s*\(|fn\s+(mainCompute)\s*\()/g;let o;for(;null!==(o=a.exec(e));)t[o[2]||o[3]]=e}n=[a]}else if(n){if(a.startsWith("#")){const e=n.join("\n"),a=/(@compute[\s\S]*?fn\s+([A-Za-z_]\w*)\s*\(|fn\s+(mainCompute)\s*\()/g;let o;for(;null!==(o=a.exec(e));)t[o[2]||o[3]]=e;continue}n.push(a)}if(n){const e=n.join("\n"),a=/(@compute[\s\S]*?fn\s+([A-Za-z_]\w*)\s*\(|fn\s+(mainCompute)\s*\()/g;let o;for(;null!==(o=a.exec(e));)t[o[2]||o[3]]=e}return t}isBindingUsed(e,t){let n=[...[..."compute"===this.type?h.COMPUTER_SHADER_TEMPLATE:h.RENDER_SHADER_TEMPLATE],...t.split("\n")].join("\n");n=n.replace(/\/\*[\s\S]*?\*\//g,""),n=n.replace(/\/\/.*$/gm,"");return new RegExp(`\\b${e}\\b`).test(n)}getShaderCode(e=!0,t,n){const a=[..."compute"===this.type?h.COMPUTER_SHADER_TEMPLATE:h.RENDER_SHADER_TEMPLATE],o=[...n?n.split("\n"):this.codeLines],i={},r={},l={},c={},d={};{const e=a.indexOf("$vs_flip_y");if(e>-1){const t=["buffer"===this.type?"  output.fragUV.y = 1.0 - output.fragUV.y;":""];a.splice(e,1,...t)}}{const e=this.shader.getFeatures(),t=a.indexOf("$wgsl_utils");if(t>-1){const n=[...e.includes("keyboard")?h.WGSL_KEYBOARD_UTILS:[]];a.splice(t,1,...n)}}{const e=this.shader.passes.find(e=>"common"===e.type),t=e?.codeLines??[],n=a.indexOf("$common");console.assert(n>-1),a.splice(n,1,...t)}{const e=a.indexOf("$main_entry");console.assert(e>-1),a.splice(e,1,...o)}for(this._pLine=0;this._pLine<a.length;)this._parseShaderLine(a);if(delete this._pLine,"compute"===this.type){this.structs=this._parseStructs(a.join("\n")),this.workGroupSizes={},this.workGroupCounts={},this.executeOnce={};for(let e=0;e<a.length;++e)a[e]=this._parseComputeLine(a[e],t,n,d);const e=a.indexOf("$compute_entry");console.assert(e>-1),a.splice(e,1,`@compute @workgroup_size(${this.workGroupSizes[t]??[16,16,1]})`)}const u=a.join("\n");if(e){let e=0;{const t=a.indexOf("$default_bindings");console.assert(t>-1),a.splice(t,1,...s.map((t,n)=>{if(t.skipBindings)return;if(!this.isBindingUsed(t.name,u))return;const a=e++;i[t.name]=a;const o=t.type[this.renderer.backend]??"f32";return`@group(0) @binding(${a}) var<uniform> ${t.name} : ${o};`}).filter(e=>void 0!==e))}{if(this.uniforms.length!==this.uniformBuffers.length){this.uniformBuffers.length=this.uniforms.length;for(let e=0;e<this.uniformBuffers.length;++e){const t=this.uniforms[e];this.uniformBuffers[e]||(this.uniformBuffers[e]=this.device.createBuffer({size:h.GetUniformSize(t.type??"f32"),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}))}}const t=a.indexOf("$custom_bindings");console.assert(t>-1),a.splice(t,1,...this.uniforms.map((t,n)=>{if(!t)return;if(!this.isBindingUsed(t.name,u))return;const a=e++;return r[t.name]=a,`@group(0) @binding(${a}) var<uniform> ${t.name} : ${t.type};`}).filter(e=>void 0!==e))}{const t=a.indexOf("$texture_bindings");console.assert(t>-1);const n=this.channels.map((t,n)=>{if(!t)return;const a=`iChannel${n}`;if(!this.isBindingUsed(a,u))return;const o=e++;l[t.id]=o;return`@group(0) @binding(${o}) var ${a} : ${this.channelTextures[n].depthOrArrayLayers>1?"texture_cube":"texture_2d"}<f32>;`}).filter(e=>void 0!==e);a.splice(t,1,...n.length?[...n,...["nearestSampler","bilinearSampler","trilinearSampler","nearestRepeatSampler","bilinearRepeatSampler","trilinearRepeatSampler"].map(t=>{if(!this.isBindingUsed(t,u))return;const n=e++;return c[t]=n,`@group(0) @binding(${n}) var ${t} : sampler;`}).filter(e=>void 0!==e)]:[])}if("compute"===this.type){const t=a.indexOf("$output_binding");console.assert(t>-1),this.usesComputeScreenTexture=this.isBindingUsed("screen",u),a.splice(t,1,this.usesComputeScreenTexture?`@group(0) @binding(${e++}) var screen: texture_storage_2d<rgba16float,write>;`:void 0)}}const p={code:a.join("\n"),defaultBindings:i,customBindings:r,textureBindings:l,samplerBindings:c,storageBindings:d,executeOnce:this.executeOnce,wgSizes:this.workGroupSizes,wgCounts:this.workGroupCounts,usesComputeScreenTexture:this.usesComputeScreenTexture};return delete this.structs,delete this.executeOnce,delete this.workGroupSizes,delete this.workGroupCounts,delete this.usesComputeScreenTexture,p}_computeStructSize(e){let t=0,n=1;for(const a of e){const e=h.GetUniformAlign(a.type),o=h.GetUniformSize(a.type);t=Math.ceil(t/e)*e,a.offset=t,t+=o,n=Math.max(n,e)}const a=Math.ceil(t/n)*n;return{size:a,stride:16*Math.ceil(a/16)}}_parseStructs(e){const t={},n=/struct\s+(\w+)\s*{([^}]*)}/g;let a;for(;null!==(a=n.exec(e));){const e=a[1],n=a[2].trim(),o=[],s=/(\w+)\s*:\s*([\w<>\s]+)(,|\\n)/g;let i;for(;null!==(i=s.exec(n));)o.push({name:i[1],type:i[2].trim()});const{size:r,stride:l}=this._computeStructSize(o);t[e]={name:e,members:o,size:r,stride:l}}return t}_parseStorageType(e){const t=e.match(/^array\s*<\s*(.+)\s*,\s*([A-Za-z0-9_]+)\s*>\s*$/i);if(t){const e=this._parseStorageType(t[1]),n=t[2];return{kind:"array",elem:e,count:isNaN(n)?this.defines[n]??0:parseInt(n)}}let n=e,a=h.GetUniformSize(n);return 0===a&&(a=this.structs[n]?.size??0),{kind:"base",type:n,size:a}}_getBufferSize(e){if("base"===e.kind)return e.size;if("array"===e.kind){return this._getBufferSize(e.elem)*(e.count??1)}return 0}_replaceDefines(e){for(const[t,n]of Object.entries(this.defines)){const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp("\\b"+a+"\\b","g");e=e.replace(o,n)}return e}_parseIfDirective(e){const t=e.match(/^\s*#\s*(?:ELSE)?IF\s+(.+?)\s*$/i);if(!t)return null;const n=t[1].trim(),a=e=>/^[-+]?\d+(\.\d+)?$/.test(e),o=e=>/^(true|false)$/i.test(e),s=e=>/^[A-Za-z_]\w*$/.test(e);if(a(n))return{raw:n,type:"literal",kind:"number",value:Number(n)};if(o(n))return{raw:n,type:"literal",kind:"boolean",value:"true"===n.toLowerCase()};if(s(n))return{raw:n,type:"identifier",name:n};const i=n.match(/^(.+?)\s*(==|!=|<=|>=|<|>)\s*(.+)$/);if(i){const r=i[1].trim(),l=i[2],c=i[3].trim();function d(e){return a(e)?{raw:e,type:"literal",kind:"number",value:Number(e)}:o(e)?{raw:e,type:"literal",kind:"boolean",value:"true"===e.toLowerCase()}:s(e)?{raw:e,type:"identifier",name:e}:{raw:e,type:"unknown"}}return{raw:n,type:"comparison",op:l,left:d(r),right:d(c)}}return{raw:n,type:"unknown"}}_evaluateParsedCondition(e){if(!e)return!1;if("literal"===e.type)return"number"===e.kind?0!==e.value:(e.kind,Boolean(e.value));if("identifier"===e.type){const t=this.defines[e.name];return"boolean"==typeof t?t:0!==Number(t)}if("comparison"===e.type){const t=e=>{if("literal"===e.type)return e.value;if("identifier"===e.type)return this.defines[e.name];if("raw"===e.type){const t=Number(e.raw);return Number.isFinite(t)?t:e.raw}},n=t(e.left),a=t(e.right);switch(e.op){case"==":return n==a;case"!=":return n!=a;case"<=":return Number(n)<=Number(a);case">=":return Number(n)>=Number(a);case"<":return Number(n)<Number(a);case">":return Number(n)>Number(a);default:throw new Error(`Unsupported operator ${e.op}`)}}return!1}_parseShaderLine(e){const t=e[this._pLine],n=t.split(" "),a=(t,n)=>{for(let a=t;a<=n;a++)e[a]=""},o=(t,...n)=>{let a=t,o=0;for(;a<e.length;){const t=e[a];if(t.startsWith("#if")&&!n.some(e=>t.startsWith(e)))o++;else if(t.startsWith("#endif"))if(o>0)o--;else{let e=n.find(e=>t.startsWith(e));if(e)return[a,e,t]}else if(0===o){let e=n.find(e=>t.startsWith(e));if(e)return[a,e,t]}a++}return[-1,null,null]},s=t=>{e[this._pLine++]="";const n=this._parseIfDirective(t);if(console.assert(n,`No If directive in line: ${t}`),this._evaluateParsedCondition(n)){const[t,n]=o(this._pLine,"#elseif","#else","#endif");if("#endif"===n)e[t]="";else{const[e]=o(t+1,"#endif");a(t,e)}}else{const[t,n,i]=o(this._pLine,"#elseif","#else","#endif");if(a(this._pLine,t-1),"#endif"===n)e[t]="",this._pLine=t+1;else if("#else"===n){e[t]="",this._pLine=t+1;const[n]=o(this._pLine,"#endif");e[n]=""}else"#elseif"===n&&(this._pLine=t,s(i))}};if(t.startsWith("#include"))e[this._pLine++]="";else{if(t.startsWith("#define")){const t=n[1];let a=n.slice(2).join(" ");for(e[this._pLine++]="";a.endsWith("\\")&&this._pLine<e.length;)a=a.slice(0,-1)+" "+e[this._pLine].trim(),e[this._pLine++]="";return void(this.defines[t]=a)}t.startsWith("#if")||t.startsWith("#elseif")?s(t):e[this._pLine++]=this._replaceDefines(t)}}_parseComputeStorageLine(e,t,n,a){const o=e.match(/^\s*#\s*storage\s+([A-Za-z_]\w*)\s+(.+)\s*$/i);if(!o)return"";const s=o[1],i=o[2].trim(),r=this._parseStorageType(i),l=n.replace(e,"");if(!this.isBindingUsed(s,l))return"";if(!this.storageBuffers[s]){const e=this._getBufferSize(r),t=this.device.createBuffer({label:`${s} (storage)`,size:e,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),n=this.device.createBuffer({label:`${s} (storage B)`,size:e,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});this.storageBuffers[s]={name:s,size:e,resource:t,resourceB:n}}const c=Object.keys(a).length;return a[s]=c,`@group(1) @binding(${c}) var<storage, read_write> ${s}: ${i};`}_parseComputeLine(e,t,n,a){const o=e.split(" ");if(e.includes("@workgroup_size")){const n=e.match(/@workgroup_size\s*\(\s*(\d+)(?:\s*,\s*(\d+))?(?:\s*,\s*(\d+))?\s*\)/);if(n){const[,e,a,o]=n;this.workGroupSizes[t]=[parseInt(e??16),parseInt(a??16),parseInt(o??1)]}}else{if(e.startsWith("#workgroup_count")){const e=o[1];return this.workGroupCounts[e]=[parseInt(o[2]),parseInt(o[3]??"16"),parseInt(o[4]??"1")],""}if(e.startsWith("#dispatch_once")){const e=o[1];return this.executeOnce[e]=!0,""}if(e.startsWith("#storage"))return this._parseComputeStorageLine(e,t,n,a)}return e}setChannelTexture(e,t){this.channelTextures[e]=t}updateUniforms(){0!==this.uniforms.length&&(this.uniforms.map((e,t)=>{this.uniformBuffers[t]||(this.uniformBuffers[t]=this.device.createBuffer({size:h.GetUniformSize(e.type??"f32"),usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM})),this.device.queue.writeBuffer(this.uniformBuffers[t],0,new Float32Array([].concat(e.value)))}),this.uniformsDirty=!1)}resizeBuffer(e,t){const n=this.resolution;if(n[0]!==e&&n[1]!==t)if(this.resolution=[e,t],"buffer"===this.type){const n=navigator.gpu?navigator.gpu.getPreferredCanvasFormat():"bgra8unorm";this.textures=[this.renderer.createTexture({label:"Buffer Pass Texture A",size:[e,t,1],format:n,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.renderer.createTexture({label:"Buffer Pass Texture B",size:[e,t,1],format:n,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})]}else"compute"===this.type&&(this.textures=[this.renderer.createTexture({label:"Compute Pass Texture A",size:[e,t,1],format:"rgba16float",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC}),this.renderer.createTexture({label:"Compute Pass Texture B",size:[e,t,1],format:"rgba16float",usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC})])}}class h{constructor(e){this.name=e.name??"",this.uid=e.uid,this.url=e.url,this.passes=e.passes??[],this.type="render",this.tags=e.tags??[],this.backend=e.backend,this.author=e.author??"anonymous",this.authorId=e.authorId,this.originalId=e.originalId,this.anonAuthor=e.anonAuthor??!1,this.description=e.description??"",this.creationDate=e.creationDate??"",this.hasPreview=e.hasPreview??!1}static GetUniformSize=function(e){if("f16"===e)return 2;if("f32"===e||"i32"===e||"u32"===e||"atomic<i32>"===e||"atomic<u32>"===e)return 4;const t=e.includes("f16")||e.includes("h>")?2:4;if(e.startsWith("vec2"))return 2*t;if(e.startsWith("vec3"))return 3*t;if(e.startsWith("vec4"))return 4*t;if(e.startsWith("mat")){const n=e.match(/mat(\d)x(\d)/);if(n){return parseInt(n[1])*parseInt(n[2])*t}}return 0};static GetUniformAlign=function(e){return"f16"===e?2:"f32"===e||"i32"===e||"u32"===e||"atomic<i32>"===e||"atomic<u32>"===e?4:e.startsWith("vec2")?8:e.startsWith("vec3")||e.startsWith("vec4")||e.startsWith("mat")?16:0};getDefaultCode(e){return"buffer"===e.type?h.RENDER_BUFFER_TEMPLATE:"compute"===e.type?h.COMPUTE_MAIN_TEMPLATE:h.RENDER_COMMON_TEMPLATE}getFeatures(){const e=[];this.passes.filter(e=>"buffer"===e.type).length&&e.push("multipass");return this.passes.filter(e=>"compute"===e.type).length&&e.push("compute"),this.passes.some(t=>t.channels.filter(e=>"Keyboard"===e?.id).length?(e.push("keyboard"),!0):t.channels.filter(e=>"sound"===e?.category).length?(e.push("sound"),!0):void 0),e.join(",")}}h.WGSL_KEYBOARD_UTILS="fn keyDown( texture: texture_2d<f32>, code : i32 ) -> f32 { return textureLoad( texture, vec2i(code, 0), 0 ).x; }\nfn keyState( texture: texture_2d<f32>, code : i32 ) -> f32 { return textureLoad( texture, vec2i(code, 1), 0 ).x; }\nfn keyPressed( texture: texture_2d<f32>, code : i32 ) -> f32 { return textureLoad( texture, vec2i(code, 2), 0 ).x; }".split("\n"),h.COMMON="struct MouseData {\n    pos : vec2f,\n    start : vec2f,\n    delta : vec2f,\n    press : f32,\n    click : f32,\n}\n",h.RENDER_SHADER_TEMPLATE=`${h.COMMON}$default_bindings\n$custom_bindings\n$texture_bindings\n\nstruct VertexOutput {\n    @builtin(position) Position : vec4f,\n    @location(0) fragUV : vec2f,\n    @location(1) fragCoord : vec2f,\n}\n\n@vertex\nfn vert_main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\n    const pos = array(\n        vec2(-1.0, -1.0),\n        vec2( 1.0, -1.0),\n        vec2(-1.0,  1.0),\n        vec2(-1.0,  1.0),\n        vec2( 1.0, -1.0),\n        vec2( 1.0,  1.0),\n    );\n    var output : VertexOutput;\n    output.Position = vec4(pos[VertexIndex], 0.0, 1.0);\n    output.fragUV = (output.Position.xy * 0.5) + vec2(0.5, 0.5);\n$vs_flip_y\n    output.fragCoord = output.fragUV * iResolution + vec2f(0.5);\n    return output;\n}\n\n$wgsl_utils\n// Common pass code\n$common\n$main_entry\n\n@fragment\nfn frag_main(@location(0) fragUV : vec2f, @location(1) fragCoord : vec2f) -> @location(0) vec4f {\n    return mainImage(fragUV, fragCoord);\n}`.split("\n"),h.RENDER_MAIN_TEMPLATE="fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Normalized pixel coordinates (from 0 to 1)\n    let uv : vec2f = fragUV; // The same as: fragCoord/iResolution.xy;\n\n    // Time varying pixel color\n    let color : vec3f = 0.5 + 0.5 * cos(iTime + uv.xyx + vec3f(0,2,4));\n\n    // Output to screen\n    return vec4f(color, 1.0);\n}".split("\n"),h.RENDER_TEXTURE_TEMPLATE={channels:[{index:0,id:"68bdc7df000157b32148",category:"texture"}],code:"fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Normalized pixel coordinates (from 0 to 1)\n    let uv : vec2f = fragUV; // The same as: fragCoord/iResolution.xy;\n\n    // Sample from texture channel 0\n    let color : vec4f = textureSample(iChannel0, bilinearSampler, uv);\n\n    // Output to screen\n    return vec4f(color.rgb, 1.0);\n}".split("\n")},h.RENDER_MOUSE_TEMPLATE="fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Normalized pixel coordinates (from 0 to 1)\n    let uv : vec2f = fragCoord / iResolution.y;\n\n    // Get mouse position in normalized coordinates\n    let mousePos : vec2f = iMouse.pos / iResolution.y;\n\n    // Calculate distance from mouse\n    let dist : f32 = length(uv - mousePos);\n\n    // Create a smooth circle around the mouse\n    let radius : f32 = 0.2;\n    let circle : f32 = smoothstep(radius, radius - 0.05, dist);\n\n    // Add a glow effect\n    let glow : f32 = exp(-dist * 5.0) * 0.5;\n\n    // Color based on mouse click state\n    let color : vec3f = mix(\n        vec3f(0.2, 0.5, 1.0),  // Default blue\n        vec3f(1.0, 0.3, 0.5),  // Pink when clicked\n        iMouse.click\n    );\n\n    // Combine circle and glow\n    let finalColor : vec3f = color * (circle + glow);\n\n    // Output to screen\n    return vec4f(finalColor, 1.0);\n}".split("\n"),h.RENDER_ANIMATED_TEMPLATE="fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Centered coordinates (from -0.5 to 0.5)\n    var uv : vec2f = fragUV - 0.5;\n\n    // Make aspect ratio square\n    uv.x *= iResolution.x / iResolution.y;\n\n    // Convert to polar coordinates\n    let angle : f32 = atan2(uv.y, uv.x);\n    let radius : f32 = length(uv);\n\n    // Rotating pattern\n    let pattern : f32 = sin(angle * 6.0 - iTime * 2.0) * 0.5 + 0.5;\n\n    // Pulsing rings\n    let rings : f32 = sin(radius * 20.0 - iTime * 3.0) * 0.5 + 0.5;\n\n    // Combine patterns\n    let combined : f32 = pattern * rings;\n\n    // Create color gradient based on angle and time\n    let color1 : vec3f = vec3f(1.0, 0.3, 0.5);\n    let color2 : vec3f = vec3f(0.2, 0.8, 1.0);\n    var color : vec3f = mix(color1, color2, sin(angle + iTime) * 0.5 + 0.5);\n\n    // Apply pattern\n    color *= combined * 2.0;\n\n    // Add vignette\n    color *= 1.0 - radius * 0.5;\n\n    // Output to screen\n    return vec4f(color, 1.0);\n}".split("\n"),h.RENDER_KEYBOARD_TEMPLATE={channels:[{index:0,id:"Keyboard",category:"misc"}],code:"fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Connect iChannel0 to: Keyboard\n    //\n    // Keyboard utility functions (auto-injected when Keyboard channel is connected):\n    //   keyDown(iChannel0, key)    → 1.0 while the key is held\n    //   keyState(iChannel0, key)   → toggles each time the key is pressed\n    //   keyPressed(iChannel0, key) → 1.0 for one frame when the key is pressed\n\n    // Key codes (ASCII / DOM KeyEvent codes)\n    let KEY_LEFT  : i32 = 37; let KEY_RIGHT : i32 = 39;\n    let KEY_UP    : i32 = 38; let KEY_DOWN  : i32 = 40;\n    let KEY_W : i32 = 87; let KEY_A : i32 = 65;\n    let KEY_S : i32 = 83; let KEY_D : i32 = 68;\n    let KEY_SPACE : i32 = 32;\n\n    // State (held): is the key currently held down?\n    let l = clamp(keyDown(iChannel0, KEY_LEFT)  + keyDown(iChannel0, KEY_A), 0.0, 1.0);\n    let r = clamp(keyDown(iChannel0, KEY_RIGHT) + keyDown(iChannel0, KEY_D), 0.0, 1.0);\n    let u = clamp(keyDown(iChannel0, KEY_UP)    + keyDown(iChannel0, KEY_W), 0.0, 1.0);\n    let d = clamp(keyDown(iChannel0, KEY_DOWN)  + keyDown(iChannel0, KEY_S), 0.0, 1.0);\n\n    // Press (one-frame): fires once the moment the key is pressed\n    let press  = keyPressed(iChannel0, KEY_SPACE);\n\n    // Toggle: flips each time the key is pressed\n    let toggle = keyState(iChannel0, KEY_SPACE);\n\n    let aspect = iResolution.x / iResolution.y;\n    let uv = fragCoord / iResolution;\n    let dir = vec2f(r - l, u - d);\n\n    // Scrolling grid driven by held arrow keys / WASD\n    let gv = (uv * vec2f(aspect, 1.0) + dir * iTime * 2.0) * 10.0;\n    let grid = smoothstep(0.05, 0.0, min(fract(gv.x), fract(gv.y)));\n\n    // Space toggles color palette\n    let colA = vec3f(0.15, 0.45, 1.0);\n    let colB = vec3f(1.0, 0.30, 0.60);\n    let pal  = mix(colA, colB, toggle);\n\n    var col = vec3f(0.04, 0.04, 0.08) + grid * pal * 0.6;\n\n    // Space press flashes the screen\n    col += press * 0.4;\n\n    return vec4f(col, 1.0);\n}".split("\n")},h.RENDER_COMMON_TEMPLATE="fn someFunc(a: f32, b: f32) -> f32 {\n    return a + b;\n}".split("\n"),h.RENDER_BUFFER_TEMPLATE="fn mainImage(fragUV : vec2f, fragCoord : vec2f) -> vec4f {\n    // Output to screen\n    return vec4f(0.0, 0.0, 1.0, 1.0);\n}".split("\n"),h.COMPUTER_SHADER_TEMPLATE=`${h.COMMON}// struct DispatchInfo {\n//     id: u32\n// }\n\n$default_bindings\n$custom_bindings\n$texture_bindings\n$output_binding\n\n// fn passStore(pass_index: int, coord: int2, value: float4) {\n//     textureStore(pass_out, coord, pass_index, value);\n// }\n\n// fn passLoad(pass_index: int, coord: int2, lod: int) -> float4 {\n//     return textureLoad(pass_in, coord, pass_index, lod);\n// }\n\n// Common pass code\n$common\n$main_entry\n\n$compute_entry\nfn compute_main(@builtin(global_invocation_id) id: vec3u) {\n    mainCompute(id);\n}`.split("\n"),h.COMPUTE_MAIN_TEMPLATE="fn mainCompute(id: vec3u) {\n    // Viewport resolution (in pixels)\n    let screen_size = textureDimensions(screen);\n\n    // Prevent overdraw for workgroups on the edge of the viewport\n    if (id.x >= screen_size.x || id.y >= screen_size.y) { return; }\n\n    // Pixel coordinates (centre of pixel, origin at bottom left)\n    let fragCoord = vec2f(f32(id.x) + 0.5, f32(screen_size.y - id.y) - 0.5);\n\n    // Normalised pixel coordinates (from 0 to 1)\n    let uv = fragCoord / vec2f(screen_size);\n\n    // Time varying pixel colour\n    var col = 0.5 + 0.5 * cos(iTime + uv.xyx + vec3f(0.,2.,4.));\n\n    // Output to screen (gamma colour space, will be auto-converted later)\n    textureStore(screen, id.xy, vec4f(col, 1.0));\n}".split("\n"),h.MIMAP_GENERATION_WGSL="@group(0) @binding(0) var src_texture : texture_2d<f32>;\n@group(0) @binding(1) var dst_texture : texture_storage_2d<rgba8unorm, write>;\n@compute @workgroup_size(8, 8)\nfn main(@builtin(global_invocation_id) id : vec3u)\n{\n    let dst_dize : vec2u = textureDimensions(dst_texture);\n    // check out of bounds \n    if(id.x >= dst_dize.x || id.y >= dst_dize.y) { return; }\n    // Corresponding top-left pixel in source mip\n    let src_base: vec2u = vec2u(id.xy * 2u);\n    // Clamp to avoid reading outside for NPOT textures\n    let src_size : vec2u = textureDimensions(src_texture, 0);\n    let maxCoord = src_size - vec2u(1);\n    let offset = vec2u(0, 1);\n    let color = (\n        textureLoad(src_texture, clamp( src_base + offset.xx, vec2u(0), maxCoord ), 0) +\n        textureLoad(src_texture, clamp( src_base + offset.xy, vec2u(0), maxCoord ), 0) +\n        textureLoad(src_texture, clamp( src_base + offset.yx, vec2u(0), maxCoord ), 0) +\n        textureLoad(src_texture, clamp( src_base + offset.yy, vec2u(0), maxCoord ), 0)\n    ) * 0.25;\n    textureStore(dst_texture, id.xy, color);\n}";class f extends m{constructor(e,t,n){super(e,t,n),this.uniformLocations={}}async execute(e){if("common"===this.type)return;if(this.mustCompile||!this.program){if(0!==await this.compile(e))return}const t=e.gl;if("image"===this.type){t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,e.canvas.width,e.canvas.height),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.useProgram(this.program);for(let e=0;e<this.channelTextures.length;e++){const n=this.channels[e];if(!n)continue;const a=n.id;let o=this.channelTextures[e];o.constructor===Array&&(o=o[this.frameCount%2].texture),t.activeTexture(t.TEXTURE0+e),t.bindTexture("cubemap"===n.category?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,o),t.uniform1i(this.uniformLocations[a],e)}t.bindBuffer(t.ARRAY_BUFFER,e.fullscreenVBO),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,3),this.frameCount++}else if("buffer"===this.type){if(!this.textures[0]||!this.textures[1])return;const n=this.textures[(this.frameCount+1)%2];t.bindFramebuffer(t.FRAMEBUFFER,n.framebuffer),t.viewport(0,0,e.canvas.width,e.canvas.height),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.useProgram(this.program);for(let e=0;e<this.channelTextures.length;e++){const n=this.channels[e];if(!n)continue;const a=n.id;let o=this.channelTextures[e];o.constructor===Array&&(o=o[this.frameCount%2].texture),t.activeTexture(t.TEXTURE0+e),t.bindTexture("cubemap"===n.category?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,o),t.uniform1i(this.uniformLocations[a],e)}t.bindBuffer(t.ARRAY_BUFFER,e.fullscreenVBO),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,3),this.frameCount++}}compileShaderCode(e,t,n){const a=e.createShader(t);e.shaderSource(a,n),e.compileShader(a);if(!e.getShaderParameter(a,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(a);console.error(t),e.deleteShader(a);return{log:t.replace("\0","").split("\n").map(e=>e.trim()).filter(Boolean).map(e=>{const t=e.match(/0:(\d+):\s*(.*)/);if(t){return{linePos:0,lineNum:parseInt(t[1],10),message:t[2],type:"error"}}return{linePos:0,lineNum:0,message:e,type:"error"}})}}return{shader:a,log:[]}}async createProgram(e){const t=await this.validate();if(!t.valid)return t;const n=t.vs,a=t.fs;if(!n||!a)return null;const o=e.createProgram();if(e.attachShader(o,n.shader),e.attachShader(o,a.shader),e.linkProgram(o),e.deleteShader(n.shader),e.deleteShader(a.shader),!e.getProgramParameter(o,e.LINK_STATUS))return console.error("Program link error:",e.getProgramInfoLog(o)),e.deleteProgram(o),null;this.defaultBindings=t.defaultBindings,this.customBindings=t.customBindings,this.textureBindings=t.textureBindings,this.codeContent=t.code.replace("$fs$","\n"),this.uniformLocations={};const s={...this.defaultBindings,...this.customBindings,...this.textureBindings};for(const t in s){const n=s[t],a=e.getUniformLocation(o,n);this.uniformLocations[t]=a;const i=r[t];if(i?.length)for(const n of i){const a=e.getUniformLocation(o,`${t}.${n.name}`);a&&(this.uniformLocations[`${t}.${n.name}`]=a)}}return o}async compile(e){const t=e.gl;this.defines={SCREEN_WIDTH:this.resolution[0],SCREEN_HEIGHT:this.resolution[1]};const n=await this.createProgram(t);return n?.constructor!==WebGLProgram?n:(this.attribs={position:t.getAttribLocation(n,"a_position")},this.program=n,this.frameCount=0,this.mustCompile=!1,this.updateUniforms(),0)}async validate(e,t){const n=this.getShaderCode(!0,e,t),a=this.renderer.gl,o=this.compileShaderCode(a,a.VERTEX_SHADER,n.vs_code),s=this.compileShaderCode(a,a.FRAGMENT_SHADER,n.fs_code),i=[...o.log,...s.log];return i.length>0?(console.log(t??""),{valid:!1,code:n.fs_code,messages:i}):{valid:!0,...n,vs:o,fs:s}}getShaderCode(e=!0,t,n){const a=[...g.RENDER_SHADER_TEMPLATE],o=[...n?n.split("\n"):this.codeLines],i={},r={},c={};{const e=a.indexOf("$vs_flip_y");if(e>-1){const t=["buffer"===this.type?"  v_uv.y = 1.0 - v_uv.y;":""];a.splice(e,1,...t)}}{const e=this.shader.getFeatures(),t=a.indexOf("$glsl_utils");if(t>-1){const n=[...e.includes("keyboard")?g.GLSL_KEYBOARD_UTILS:[]];a.splice(t,1,...n)}}{const e=this.shader.passes.find(e=>"common"===e.type),t=e?.codeLines??[],n=a.indexOf("$common");console.assert(n>-1),a.splice(n,1,...t)}{const e=a.indexOf("$main_entry");console.assert(e>-1),a.splice(e,1,...o)}for(this._pLine=0;this._pLine<a.length;)this._parseShaderLine(a);delete this._pLine;const d=a.join("\n");if(e){{const e=a.indexOf("$default_bindings");console.assert(e>-1),a.splice(e,1,...s.map((e,t)=>{if(e.skipBindings)return;if(!this.isBindingUsed(e.name,d))return;i[e.name]=e.name;return`uniform ${e.type[this.renderer.backend]??"float"} ${e.name};`}).filter(e=>void 0!==e))}{const e=a.indexOf("$custom_bindings");console.assert(e>-1),a.splice(e,1,...this.uniforms.map((e,t)=>{if(!e)return;if(!this.isBindingUsed(e.name,d))return;r[e.name]=e.name;return`uniform ${l[e.type[this.renderer.backend]??"f32"]} ${e.name};`}).filter(e=>void 0!==e))}{const e=a.indexOf("$texture_bindings");console.assert(e>-1);const t=this.channels.map((e,t)=>{if(!e)return;const n=`iChannel${t}`;if(!this.isBindingUsed(n,d))return;c[e.id]=n;return`uniform ${this.channelTextures[t].depthOrArrayLayers>1?"samplerCube":"sampler2D"} ${n};`}).filter(e=>void 0!==e);a.splice(e,1,...t)}}const u=a.join("\n"),p=u.split("$fs$"),m={code:u,vs_code:p[0].trim(),fs_code:p[1].trim(),defaultBindings:i,customBindings:r,textureBindings:c,samplerBindings:{},executeOnce:this.executeOnce};return delete this.structs,m}updateUniforms(){0!==this.uniforms.length&&(this.uniforms.map((e,t)=>{this.setUniform(null,e.name,e.value)}),this.uniformsDirty=!1)}setUniform(e,t,n){if("common"===this.type)return;if((e=e??this.renderer.gl).useProgram(this.program),"object"==typeof n&&!Array.isArray(n)&&void 0===n?.length){for(const a in n)this.setUniform(e,`${t}.${a}`,n[a]);return}const a=this.uniformLocations[t];a&&("number"==typeof n?e.uniform1f(a,n):2===n.length?e.uniform2fv(a,n):3===n.length?e.uniform3fv(a,n):4===n.length&&e.uniform4fv(a,n))}}class g extends h{constructor(e){super(e)}static GetUniformSize=function(e){if("float"===e||"int"===e||"uint"===e||"bool"===e||e.startsWith("sampler"))return 4;if(e.includes("vec2"))return 8;if(e.includes("vec3"))return 12;if(e.includes("vec4"))return 16;if(e.startsWith("mat")){const t=e.match(/mat(\d)(?:x(\d))?/);if(t){const e=parseInt(t[1]);return e*(2===(t[2]?parseInt(t[2]):e)?8:16)}}return 0};static GetUniformAlign=function(e){return"float"===e||"int"===e||"uint"===e||"bool"===e||e.startsWith("sampler")?4:e.includes("vec2")?8:e.includes("vec3")||e.includes("vec4")||e.startsWith("mat")?16:0};getDefaultCode(e){return"buffer"===e.type?g.RENDER_BUFFER_TEMPLATE:g.RENDER_COMMON_TEMPLATE}getFeatures(){const e=[];return this.passes.filter(e=>"buffer"===e.type).length&&e.push("multipass"),this.passes.some(t=>t.channels.filter(e=>"Keyboard"===e?.id).length?(e.push("keyboard"),!0):t.channels.filter(e=>"sound"===e?.category).length?(e.push("sound"),!0):void 0),e.join(",")}}g.GLSL_KEYBOARD_UTILS="".split("\n"),g.COMMON="struct MouseData {\n    vec2 pos;\n    vec2 start;\n    vec2 delta;\n    float press;\n    float click;\n};",g.RENDER_VS_SHADER_TEMPLATE="#version 300 es\n\nlayout(location = 0) in vec2 a_position;\n\nout vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0.0, 1.0);\n    v_uv = a_position * 0.5 + 0.5;\n$vs_flip_y\n}".split("\n"),g.RENDER_FS_SHADER_TEMPLATE=`$fs$#version 300 es\nprecision highp float;\n\n${g.COMMON}\n\n$default_bindings\n$custom_bindings\n$texture_bindings\n\nin vec2 v_uv;\nout vec4 fragColor;\n\n$glsl_utils\n// Common pass code\n$common\n$main_entry\n\nvoid main()\n{\n    vec2 fragCoord = v_uv * iResolution + vec2(0.5);\n    fragColor = mainImage(v_uv, fragCoord);\n}`.split("\n"),g.RENDER_SHADER_TEMPLATE=[...g.RENDER_VS_SHADER_TEMPLATE,...g.RENDER_FS_SHADER_TEMPLATE],g.RENDER_MAIN_TEMPLATE="vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Normalized pixel coordinates (from 0 to 1)\n    vec2 uv = fragUV; // The same as: fragCoord/iResolution.xy;\n\n    // Time varying pixel color\n    vec3 color = 0.5 + 0.5 * cos(iTime + uv.xyx + vec3(0,2,4));\n\n    // Output to screen\n    return vec4(color, 1.0);\n}".split("\n"),g.RENDER_TEXTURE_TEMPLATE={channels:[{index:0,id:"68bdc7df000157b32148",category:"texture"}],code:"vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Normalized pixel coordinates (from 0 to 1)\n    vec2 uv = fragUV; // The same as: fragCoord/iResolution.xy;\n\n    // Sample from texture channel 0\n    vec4 color = texture(iChannel0, uv);\n\n    // Output to screen\n    return vec4(color.rgb, 1.0);\n}".split("\n")},g.RENDER_MOUSE_TEMPLATE="vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Normalized pixel coordinates (from 0 to 1)\n    vec2 uv = fragCoord/iResolution.y;\n\n    // Get mouse position in normalized coordinates\n    vec2 mousePos = iMouse.pos / iResolution.y;\n\n    // Calculate distance from mouse\n    float dist = length(uv - mousePos);\n\n    // Create a smooth circle around the mouse\n    float radius = 0.2;\n    float circle = smoothstep(radius, radius - 0.05, dist);\n\n    // Add a glow effect\n    float glow = exp(-dist * 5.0) * 0.5;\n\n    // Color based on mouse click state\n    vec3 color = mix(\n        vec3(0.2, 0.5, 1.0),  // Default blue\n        vec3(1.0, 0.3, 0.5),  // Pink when clicked\n        iMouse.click\n    );\n\n    // Combine circle and glow\n    vec3 finalColor = color * (circle + glow);\n\n    // Output to screen\n    return vec4(finalColor, 1.0);\n}".split("\n"),g.RENDER_ANIMATED_TEMPLATE="vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Centered coordinates (from -0.5 to 0.5)\n    vec2 uv = fragUV - 0.5;\n\n    // Make aspect ratio square\n    uv.x *= iResolution.x / iResolution.y;\n\n    // Convert to polar coordinates\n    float angle = atan(uv.y, uv.x);\n    float radius = length(uv);\n\n    // Rotating pattern\n    float pattern = sin(angle * 6.0 - iTime * 2.0) * 0.5 + 0.5;\n\n    // Pulsing rings\n    float rings = sin(radius * 20.0 - iTime * 3.0) * 0.5 + 0.5;\n\n    // Combine patterns\n    float combined = pattern * rings;\n\n    // Create color gradient based on angle and time\n    vec3 color1 = vec3(1.0, 0.3, 0.5);\n    vec3 color2 = vec3(0.2, 0.8, 1.0);\n    vec3 color = mix(color1, color2, sin(angle + iTime) * 0.5 + 0.5);\n\n    // Apply pattern\n    color *= combined * 2.0;\n\n    // Add vignette\n    color *= 1.0 - radius * 0.5;\n\n    // Output to screen\n    return vec4(color, 1.0);\n}".split("\n"),g.RENDER_KEYBOARD_TEMPLATE={channels:[{index:0,id:"Keyboard",category:"misc"}],code:"vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Connect iChannel0 to: Keyboard\n    // Keyboard texture layout (256 x 3):\n    //   Row 0 — state  : is the key currently held down\n    //   Row 1 — press  : one-frame pulse when the key is pressed\n    //   Row 2 — toggle : flips each time the key is pressed\n\n    const int KEY_LEFT  = 37, KEY_RIGHT = 39, KEY_UP = 38, KEY_DOWN = 40;\n    const int KEY_W = 87, KEY_A = 65, KEY_S = 83, KEY_D = 68;\n    const int KEY_SPACE = 32;\n\n    // State (held): is the key currently held down?\n    float l = clamp(\n        texelFetch(iChannel0, ivec2(KEY_LEFT, 0), 0).r +\n        texelFetch(iChannel0, ivec2(KEY_A, 0), 0).r, 0.0, 1.0);\n    float r = clamp(\n        texelFetch(iChannel0, ivec2(KEY_RIGHT, 0), 0).r +\n        texelFetch(iChannel0, ivec2(KEY_D, 0), 0).r, 0.0, 1.0);\n    float u = clamp(\n        texelFetch(iChannel0, ivec2(KEY_UP, 0), 0).r +\n        texelFetch(iChannel0, ivec2(KEY_W, 0), 0).r, 0.0, 1.0);\n    float d = clamp(\n        texelFetch(iChannel0, ivec2(KEY_DOWN, 0), 0).r +\n        texelFetch(iChannel0, ivec2(KEY_S, 0), 0).r, 0.0, 1.0);\n\n    // Toggle: flips each time the key is pressed\n    float toggle  = texelFetch(iChannel0, ivec2(KEY_SPACE, 1), 0).r;\n    \n    // Press (one-frame): fires once the moment the key is pressed\n    float press = texelFetch(iChannel0, ivec2(KEY_SPACE, 2), 0).r;\n\n    vec2 uv = fragCoord / iResolution.xy;\n    float aspect = iResolution.x / iResolution.y;\n    vec2 dir = vec2(r - l, u - d);\n\n    // Scrolling grid driven by held arrow keys / WASD\n    vec2 gv = (uv * vec2(aspect, 1.0) + dir * iTime * 2.0) * 10.0;\n    float grid = smoothstep(0.05, 0.0, min(fract(gv.x), fract(gv.y)));\n\n    // Space toggles color palette\n    vec3 colA = vec3(0.15, 0.45, 1.0);\n    vec3 colB = vec3(1.0, 0.30, 0.60);\n    vec3 pal  = mix(colA, colB, toggle);\n\n    vec3 col = vec3(0.04, 0.04, 0.08) + grid * pal * 0.6;\n\n    // Space press flashes the screen\n    col += press * 0.4;\n\n    return vec4(col, 1.0);\n}".split("\n")},g.RENDER_COMMON_TEMPLATE="float someFunc(float a, float b) {\n    return a + b;\n}".split("\n"),g.RENDER_BUFFER_TEMPLATE="vec4 mainImage(vec2 fragUV, vec2 fragCoord) {\n    // Output to screen\n    return vec4(0.0, 0.0, 1.0, 1.0);\n}".split("\n");class v extends d{constructor(e,t){super(e,t)}async init(){if(this.adapter=await(navigator.gpu?.requestAdapter({featureLevel:"compatibility"})),this.device=await(this.adapter?.requestDevice()),1===this.quitIfWebGPUNotAvailable())return;this.webGPUContext=this.canvas.getContext("webgpu");const e=window.devicePixelRatio,t=this.canvas.clientWidth*e,n=this.canvas.clientHeight*e;t>0&&n>0&&(this.canvas.width=t,this.canvas.height=n),this.presentationFormat=navigator.gpu.getPreferredCanvasFormat(),this.webGPUContext.configure({device:this.device,format:this.presentationFormat}),this.mipmapPipeline=this.device.createComputePipeline({layout:"auto",compute:{module:this.device.createShaderModule({code:h.MIMAP_GENERATION_WGSL}),entryPoint:"main"}}),this.gpuBuffers.iTime=this.createBuffer({size:4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.gpuBuffers.iTimeDelta=this.createBuffer({size:4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.gpuBuffers.iFrame=this.createBuffer({size:4,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.gpuBuffers.iResolution=this.createBuffer({size:8,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),this.gpuBuffers.iMouse=this.createBuffer({size:32,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM}),super.init()}createBuffer(e={}){return this.device.createBuffer(e)}createSampler(e={}){return this.device.createSampler(e)}createTexture(e={}){const t=this.device.createTexture(e);return e.bitmap&&this.device.queue.copyExternalImageToTexture({source:e.bitmap},{texture:t},[e.bitmap.width,e.bitmap.height]),t}updateTexture(e,t){return this.device.queue.copyExternalImageToTexture({source:t},{texture:e},[t.width,t.height]),e}async createTextureFromImage(e,t,n="",a={}){a.flipY=a.flipY??!0,a.useMipmaps=a.useMipmaps??!0;const o=await createImageBitmap(await new Blob([e])),s=a.useMipmaps?Math.floor(Math.log2(Math.max(o.width,o.height)))+1:void 0,i=[o.width,o.height],r=this.createTexture({label:n,size:[o.width,o.height,1],mipLevelCount:s,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT});return this.device.queue.copyExternalImageToTexture({source:o,...a},{texture:r,mipLevel:0},i),a.useMipmaps&&this.generateMipmaps(r,s),this.gpuTextures[t]=r,r}async createCubemapTextureFromImage(e,t,n="",a={}){a.flipY=a.flipY??!0;const o=await JSZip.loadAsync(e),s=["px","nx","ny","py","pz","nz"],i=[];for(const e of s){const t=o.file(`${e}.png`)||o.file(`${e}.jpg`);if(!t)throw new Error(`Missing cubemap face: ${e}`);const n=await t.async("blob"),a=await createImageBitmap(n);i.push(a)}const{width:r,height:l}=i[0],c=this.device.createTexture({label:n,size:[r,l,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT,dimension:"2d"});for(let e=0;e<6;e++)this.device.queue.copyExternalImageToTexture({source:i[e],...a},{texture:c,origin:[0,0,e]},[r,l]);return this.gpuTextures[t]=c,c}updateFrame(e,t,n,a){this.device&&(this.device.queue.writeBuffer(this.gpuBuffers.iTimeDelta,0,new Float32Array([e])),this.device.queue.writeBuffer(this.gpuBuffers.iTime,0,new Float32Array([t])),this.device.queue.writeBuffer(this.gpuBuffers.iFrame,0,new Int32Array([n])))}updateResolution(e,t,n){this.device&&this.device.queue.writeBuffer(this.gpuBuffers.iResolution,0,new Float32Array([e??this.canvas.offsetWidth,t??this.canvas.offsetHeight]))}updateMouse(e,t){this.device&&this.device.queue.writeBuffer(this.gpuBuffers.iMouse,0,new Float32Array(e))}generateMipmaps(e,t){const n=this.device.createCommandEncoder();for(let a=0;a<t-1;a++){const t=e.createView({baseMipLevel:a,mipLevelCount:1}),o=e.createView({baseMipLevel:a+1,mipLevelCount:1}),s=this.device.createBindGroup({layout:this.mipmapPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:t},{binding:1,resource:o}]}),i=n.beginComputePass();i.setPipeline(this.mipmapPipeline),i.setBindGroup(0,s);const r=Math.max(1,e.width>>a+1),l=Math.max(1,e.height>>a+1);i.dispatchWorkgroups(Math.ceil(r/8),Math.ceil(l/8)),i.end()}this.device.queue.submit([n.finish()])}quitIfWebGPUNotAvailable(){return this.device?(this.device.lost.then(e=>{this.fail(`Device lost ("${e.reason}"):\n${e.message}`)}),0):this.quitIfAdapterNotAvailable()}quitIfAdapterNotAvailable(){return"gpu"in navigator?this.adapter?this.fail("Unable to get WebGPU device for an unknown reason."):this.fail("No adapter found after calling 'requestAdapter'."):this.fail("'navigator.gpu' is not defined - WebGPU not available in this browser"),1}}const x=[{name:"PI",description:"π — ratio of circumference to diameter",code:"#define PI         3.14159265359"},{name:"TAU",description:"2π — full circle in radians",code:"#define TAU        6.28318530718"},{name:"Common",description:"PI, TAU, HPI, square roots",code:"#define PI         3.14159265359\n#define TAU        6.28318530718\n#define HPI        1.57079632679\n#define SQRT_HALF  0.70710678118\n#define SQRT2      1.41421356237\n#define SQRT_THIRD 0.57735026919"},{name:"Simplex",description:"Skew / unskew factors for simplex noise (2D–4D)",code:"#define SQRT_3_4  0.86602540378 // sqrt(0.75)\n#define SQRT_HALF 0.70710678118 // sqrt(0.5)\n\n// Simplex skew:   (sqrt(N+1)-1)/N\n// Simplex unskew: (1-1/sqrt(N+1))/N\n#define F2 0.36602540378\n#define G2 0.21132486541\n#define F3 0.33333333333\n#define G3 0.16666666667\n#define F4 0.30901699437\n#define G4 0.13819660113"}],b=[{name:"Constants",icon:"Pi",snippets:[...x,{name:"Golden Ratio",description:"PHI, golden angle, 2D & 3D rotation matrices",code:"#define PHI          1.61803398875\n#define GOLDEN_ANGLE 2.39996322972\n\nconst GOLDEN_ROT2: mat2x2f = mat2x2f(\n    -0.73736887808,  0.67549029426,\n    -0.67549029426, -0.73736887808);\n\nconst GOLDEN_ROT3: mat3x3f = mat3x3f(\n    -0.571464913,  0.814921382, 0.096597072,\n    -0.278044873, -0.303026659, 0.911518454,\n     0.772087367,  0.494042493, 0.399753815);"}]},{name:"Noise",icon:"Hash",snippets:[{name:"Hash (1D → 1D)",description:"Simple pseudorandom hash from a float",code:"fn hash_11(s: f32) -> f32\n{\n    var p: f32 = fract(s * 0.1031);\n    p *= p + 33.33;\n    p *= p + p;\n    return fract(p);\n}"},{name:"Hash (2D → 1D)",description:"Pseudorandom float from a vec2 seed",code:"fn hash_21(p: vec2f) -> f32\n{\n    var p3: vec3f = fract(vec3f(p.xyx) * 0.1031);\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.x + p3.y) * p3.z);\n}"},{name:"Hash (2D → 2D)",description:"Pseudorandom vec2 from a vec2 seed",code:"fn hash_22(p: vec2f) -> vec2f\n{\n    var p3: vec3f = fract(vec3f(p.xyx) * vec3f(0.1031, 0.1030, 0.0973));\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.xx + p3.yz) * p3.zy);\n}"},{name:"Value Noise 2D",description:"Smooth interpolated value noise",code:"fn value_noise(p: vec2f) -> f32\n{\n    let i: vec2f = floor(p);\n    var f: vec2f = fract(p);\n    f = f * f * (3.0 - 2.0 * f);\n    let a: f32 = hash_21(i);\n    let b: f32 = hash_21(i + vec2(1.0, 0.0));\n    let c: f32 = hash_21(i + vec2(0.0, 1.0));\n    let d: f32 = hash_21(i + vec2(1.0, 1.0));\n    return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);\n}"},{name:"Simplex Noise 2D",description:"Classic 2D simplex noise",author:"Ashima Arts, Stefan Gustavson (webgl-noise)",code:"fn mod_289_3(x: vec3f) -> vec3f { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nfn mod_289_2(x: vec2f) -> vec2f { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nfn permute(x: vec3f) -> vec3f { return mod_289_3(((x * 34.0) + 1.0) * x); }\n\nfn simplex_noise(v: vec2f) -> f32\n{\n    const C: vec4f = vec4f(0.211324865405187, 0.366025403784439,\n                       -0.577350269189626, 0.024390243902439);\n    var i: vec2f = floor(v + dot(v, C.yy));\n    let x0: vec2f = v - i + dot(i, C.xx);\n    let i1: vec2f = select(vec2f(0.0, 1.0), vec2f(1.0, 0.0), x0.x > x0.y);\n    var x12: vec4f = x0.xyxy + C.xxzz;\n    x12.x -= i1.x;\n    x12.y -= i1.y;\n    i = mod_289_2(i);\n    let p: vec3f = permute(permute(i.y + vec3f(0.0, i1.y, 1.0))\n                            + i.x + vec3f(0.0, i1.x, 1.0));\n    var m: vec3f = max(0.5 - vec3f(dot(x0, x0), dot(x12.xy, x12.xy),\n                            dot(x12.zw, x12.zw)), vec3f(0.0));\n    m = m * m;\n    m = m * m;\n    let x: vec3f = 2.0 * fract(p * C.www) - 1.0;\n    let h: vec3f = abs(x) - 0.5;\n    let ox: vec3f = floor(x + 0.5);\n    let a0: vec3f = x - ox;\n    m *= 1.79284291400159 - 0.85373472095314 * (a0 * a0 + h * h);\n    var g: vec3f;\n    g.x = a0.x * x0.x + h.x * x0.y;\n    let Gyz: vec2f = a0.yz * x12.xz + h.yz * x12.yw; \n    g.y = Gyz.x;\n    g.z = Gyz.y;\n    return 130.0 * dot(m, g);\n}"},{name:"FBM (Fractal Brownian Motion)",description:"Layered noise with configurable octaves",code:"fn fbm(p: vec2f) -> f32\n{\n    var value: f32 = 0.0;\n    var amplitude: f32 = 0.5;\n    var frequency: f32 = 1.0;\n    for (var i: i32 = 0; i < 6; i++)\n    {\n        value += amplitude * value_noise(p * frequency);\n        frequency *= 2.0;\n        amplitude *= 0.5;\n    }\n    return value;\n}"},{name:"Voronoi / Worley Noise",description:"Cell noise with distance to nearest point",code:"fn voronoi(p: vec2f) -> f32\n{\n    let i: vec2f = floor(p);\n    let f: vec2f = fract(p);\n    var min_dist: f32 = 1.0;\n    for (var y: i32 = -1; y <= 1; y++)\n    {\n        for (var x: i32 = -1; x <= 1; x++)\n        {\n            let neighbor: vec2f = vec2f(f32(x), f32(y));\n            let point: vec2f = hash_22(i + neighbor);\n            let diff: vec2f = neighbor + point - f;\n            let dist: f32 = length(diff);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}"},{name:"Turbulence",description:"Fake fluid dynamics via layered rotated sine waves",author:"Xor (mini.gmshaders.com/p/turbulence)",code:"// Turbulence: approximate fluid motion by layering\n// rotated sine‑wave displacements.\n//\n// Parameters\n//   TURB_NUM   – number of octaves (more = finer detail)\n//   TURB_AMP   – overall wave amplitude (0–1)\n//   TURB_SPEED – scroll speed (set 0 for static)\n//   TURB_FREQ  – starting frequency\n//   TURB_EXP   – frequency multiplier per octave\n\n#define TURB_NUM   10\n#define TURB_AMP   0.7\n#define TURB_SPEED 0.3\n#define TURB_FREQ  2.0\n#define TURB_EXP   1.4\n\nfn turbulence(p: vec2f, time: f32) -> vec2f\n{\n    var freq: f32 = TURB_FREQ;\n    var rot: mat2x2f = mat2x2f(0.6, -0.8, 0.8, 0.6);\n    var pos: vec2f = p;\n\n    for (var i: i32 = 0; i < TURB_NUM; i++)\n    {\n        let phase: f32 = freq * (pos * rot).y + TURB_SPEED * time + f32(i);\n        pos += TURB_AMP * rot[0] * sin(phase) / freq;\n        rot *= mat2x2f(0.6, -0.8, 0.8, 0.6);\n        freq *= TURB_EXP;\n    }\n    return pos;\n}"},{name:"Dot Noise 3D",description:"Cheap aperiodic 3D noise using golden‑ratio gyroids",author:"Xor (mini.gmshaders.com/p/dot-noise)",code:"// Dot Noise: a fast alternative to 3D value / Perlin / simplex\n// noise.  Uses a gyroid formula with golden‑ratio rotation so\n// the pattern never repeats.  Returns a value in [‑3, +3].\n\nfn dot_noise(p: vec3f) -> f32\n{\n    const PHI: f32 = 1.618033988;\n\n    // Golden‑angle rotation on the vec3(1, φ, φ²) axis\n    const GOLD: mat3x3f = mat3x3f(\n        -0.571464913,  0.814921382,  0.096597072,\n        -0.278044873, -0.303026659,  0.911518454,\n         0.772087367,  0.494042493,  0.399753815);\n\n    return dot(cos(GOLD * p), sin(PHI * p * GOLD));\n}\n\n// Fractal layering for richer detail (returns ~[‑1, +1])\nfn dot_noise_fbm(p: vec3f) -> f32\n{\n    const PHI: f32 = 1.618033988;\n    const GOLD: mat3x3f = mat3x3f(\n        -0.571464913,  0.814921382,  0.096597072,\n        -0.278044873, -0.303026659,  0.911518454,\n         0.772087367,  0.494042493,  0.399753815);\n\n    var value: f32 = 0.0;\n    var amplitude: f32 = 0.5;\n    var pos: vec3f = p;\n    for (var i: i32 = 0; i < 5; i++)\n    {\n        value += amplitude * dot(cos(GOLD * pos), sin(PHI * pos * GOLD)) / 3.0;\n        pos = GOLD * pos * 2.0;\n        amplitude *= 0.5;\n    }\n    return value;\n}"}]},{name:"Color",icon:"Contrast",snippets:[{name:"HSV to RGB",description:"Convert hue/saturation/value to RGB",code:"vec3 hsv_to_rgb(vec3 c)\n{\n    vec3 p = abs(fract(c.xxx + vec3(1.0, 2.0/3.0, 1.0/3.0)) * 6.0 - 3.0);\n    return c.z * mix(vec3(1.0), clamp(p - 1.0, 0.0, 1.0), c.y);\n}"},{name:"RGB to HSV",description:"Convert RGB to hue/saturation/value",author:"Sam Hocevar",code:"vec3 rgb_to_hsv(vec3 c)\n{\n    vec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = 1.0e-10;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}"},{name:"Cosine Palette",description:"Cosine gradient palette (4 vec3 parameters)",author:"Inigo Quilez (iquilezles.org/articles/palettes)",code:"vec3 palette(float t, vec3 a, vec3 b, vec3 c, vec3 d)\n{\n    return a + b * cos(TAU * (c * t + d));\n}\n\n// Example presets:\n// Rainbow:   palette(t, vec3(0.5), vec3(0.5), vec3(1.0), vec3(0.0, 0.33, 0.67))\n// Warm:      palette(t, vec3(0.5), vec3(0.5), vec3(1.0), vec3(0.0, 0.1, 0.2))\n// Cool:      palette(t, vec3(0.5), vec3(0.5), vec3(1.0, 1.0, 0.5), vec3(0.8, 0.9, 0.3))"},{name:"sRGB Conversion",description:"Accurate linear ↔ sRGB with the piecewise IEC 61966-2-1 transfer curve",code:"vec3 linear_to_srgb(vec3 c)\n{\n    vec3 lo = 12.92 * c;\n    vec3 hi = 1.055 * pow(c, vec3(1.0 / 2.4)) - 0.055;\n    return mix(lo, hi, step(vec3(0.0031308), c));\n}\n\nvec3 srgb_to_linear(vec3 c)\n{\n    vec3 lo = c / 12.92;\n    vec3 hi = pow((c + 0.055) / 1.055, vec3(2.4));\n    return mix(lo, hi, step(vec3(0.04045), c));\n}"},{name:"Tonemapping",description:"ACES filmic and Reinhard tonemapping operators for HDR → LDR",code:"// ACES filmic tone mapping (Krzysztof Narkowicz fit)\nvec3 tonemap_aces(vec3 x)\n{\n    float a = 2.51;\n    float b = 0.03;\n    float c = 2.43;\n    float d = 0.59;\n    float e = 0.14;\n    return clamp((x * (a * x + b)) / (x * (c * x + d) + e), 0.0, 1.0);\n}\n\n// Reinhard tonemapping\nvec3 tonemap_reinhard(vec3 x)\n{\n    return x / (1.0 + x);\n}\n\n// Extended Reinhard with white point control\nvec3 tonemap_reinhard_ext(vec3 x, float white)\n{\n    vec3 num = x * (1.0 + x / (white * white));\n    return num / (1.0 + x);\n}",author:"Krzysztof Narkowicz (ACES), Erik Reinhard et al."},{name:"Hue Rotation",description:"Rotate the hue of an RGB color",author:"W3C CSS Filters (hue-rotate matrix)",code:"vec3 hue_rotate(vec3 col, float angle)\n{\n    float s = sin(angle);\n    float c = cos(angle);\n    mat3 m = mat3(\n        0.299 + 0.701*c + 0.168*s,  0.587 - 0.587*c + 0.330*s,  0.114 - 0.114*c - 0.497*s,\n        0.299 - 0.299*c - 0.328*s,  0.587 + 0.413*c + 0.035*s,  0.114 - 0.114*c + 0.292*s,\n        0.299 - 0.300*c + 1.250*s,  0.587 - 0.588*c - 1.050*s,  0.114 + 0.886*c - 0.203*s\n    );\n    return m * col;\n}"},{name:"Luminance",description:"Perceived brightness of an RGB color",author:"ITU-R BT.709 coefficients",code:"float luminance(vec3 col)\n{\n    return dot(col, vec3(0.2126, 0.7152, 0.0722));\n}"},{name:"OKLab (Linear RGB ↔ L,a,b)",description:"Perceptually uniform color space; use linear RGB (srgbToLinear first)",author:"Björn Ottosson (bottosson.github.io/posts/oklab)",code:"float ok_cbrt(float x)\n{\n    return sign(x) * pow(abs(x), 1.0 / 3.0);\n}\n\nvec3 rgb_to_oklab(vec3 c)\n{\n    float l = 0.4122214708 * c.r + 0.5363325363 * c.g + 0.0514459929 * c.b;\n    float m = 0.2119034982 * c.r + 0.6806995451 * c.g + 0.1073969566 * c.b;\n    float s = 0.0883024619 * c.r + 0.2817188376 * c.g + 0.6299787005 * c.b;\n    float l_ = ok_cbrt(l), m_ = ok_cbrt(m), s_ = ok_cbrt(s);\n    return vec3(\n        0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_,\n        1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_,\n        0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_\n    );\n}\n\nvec3 oklab_to_rgb(vec3 c)\n{\n    float l_ = c.r + 0.3963377774 * c.g + 0.2158037573 * c.b;\n    float m_ = c.r - 0.1055613458 * c.g - 0.0638541728 * c.b;\n    float s_ = c.r - 0.0894841775 * c.g - 1.2914855480 * c.b;\n    float l = l_ * l_ * l_, m = m_ * m_ * m_, s = s_ * s_ * s_;\n    return vec3(\n        4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s,\n        -1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s,\n        -0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s\n    );\n}"},{name:"OKLch (Lightness, Chroma, Hue)",description:"Cylindrical OKLab; L=lightness, C=chroma, H=hue in radians",author:"Björn Ottosson (bottosson.github.io/posts/oklab)",code:"vec3 oklab_to_oklch(vec3 ok)\n{\n    float L = ok.r;\n    float C = sqrt(ok.g * ok.g + ok.b * ok.b);\n    float H = atan(ok.b, ok.g);\n    return vec3(L, C, H);\n}\n\nvec3 oklch_to_oklab(vec3 lch)\n{\n    float L = lch.r, C = lch.g, H = lch.b;\n    return vec3(L, C * cos(H), C * sin(H));\n}\n\n// Full pipeline: sRGB → linear → OKLab → OKLch\n// vec3 lab = rgb_to_oklab(srgb_to_linear(col));\n// vec3 lch = oklab_to_oklch(lab);"}]},{name:"Math",icon:"Function",snippets:[{name:"2D Rotation",description:"Rotate a vec2 by an angle in radians",code:"mat2 rotate_2d(float angle)\n{\n    float s = sin(angle);\n    float c = cos(angle);\n    return mat2(c, -s, s, c);\n}\n\n// Usage: p.xy *= rotate_2d(angle);"},{name:"3D Rotation (Euler Angles)",description:"Rotate a vec3 with roll, pitch, and yaw via successive 2D rotations",author:"Xor (mini.gmshaders.com/p/3d-rotation)",code:"mat2 rot2d(float a) { return mat2(cos(a), -sin(a), sin(a), cos(a)); }\n\nvec3 euler_rotate(vec3 v, float roll, float pitch, float yaw)\n{\n    v.yz *= rot2d(roll);\n    v.xz *= rot2d(pitch);\n    v.xy *= rot2d(yaw);\n    return v;\n}"},{name:"3D Rotation (Axis-Angle)",description:"Rotate a vec3 by an angle around an arbitrary unit axis",author:"Xor / Fabrice Neyret (mini.gmshaders.com/p/3d-rotation)",code:"vec3 axis_rotate(vec3 v, vec3 axis, float angle)\n{\n    return mix(dot(v, axis) * axis, v, cos(angle))\n         + sin(angle) * cross(v, axis);\n}"},{name:"Remap",description:"Map a value from one range to another",code:"float remap(float value, float in_min, float in_max, float out_min, float out_max)\n{\n    return out_min + (out_max - out_min) * (value - in_min) / (in_max - in_min);\n}"},{name:"Smooth Min / Max",description:"Smooth minimum and maximum blending",author:"Inigo Quilez (iquilezles.org/articles/smin)",code:"float smin(float a, float b, float k)\n{\n    float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);\n    return mix(b, a, h) - k * h * (1.0 - h);\n}\n\nfloat smax(float a, float b, float k)\n{\n    float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);\n    return mix(a, b, h) + k * h * (1.0 - h);\n}"},{name:"Smootherstep",description:"Improved smoothstep (C2 continuous)",author:"Ken Perlin",code:"float smootherstep(float edge0, float edge1, float x)\n{\n    x = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);\n    return x * x * x * (x * (x * 6.0 - 15.0) + 10.0);\n}"},{name:"Polar Coordinates",description:"Convert between cartesian and polar coords",code:"vec2 to_polar(vec2 p)\n{\n    return vec2(length(p), atan(p.y, p.x));\n}\n\nvec2 to_cartesian(vec2 polar)\n{\n    return vec2(polar.x * cos(polar.y), polar.x * sin(polar.y));\n}"},{name:"Repeat / Tile",description:"Repeat space for infinite tiling",code:"vec2 repeat(vec2 p, vec2 size)\n{\n    return mod(p + size * 0.5, size) - size * 0.5;\n}\n\n// Mirror repeat (ping-pong)\nvec2 mirror_repeat(vec2 p, vec2 size)\n{\n    vec2 half = size * 0.5;\n    vec2 q = mod(p + half, size * 2.0) - size;\n    return half - abs(q);\n}"},{name:"Anti-Aliasing (SDF)",description:"Smooth edges for SDFs by matching gradient to pixel scale",author:"Xor (mini.gmshaders.com/p/antialiasing)",code:"// For SDFs with a known pixel scale (texel size).\n// Blends 0→1 over the width of one pixel at the edge.\nfloat antialias_sdf(float dist, float texel)\n{\n    return clamp(dist / texel + 0.5, 0.0, 1.0);\n}"},{name:"Anti-Aliasing (Derivative)",description:"Smooth edges from any continuous function using fwidth / derivatives",author:"Xor (mini.gmshaders.com/p/antialiasing)",code:"// Automatic edge smoothing via fwidth (cheap, handles most cases)\nfloat antialias(float d)\n{\n    float w = fwidth(d);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.5 * scale * d, 0.0, 1.0);\n}\n\n// Higher-quality variant using gradient length (L2 norm)\nfloat antialias_l2(float d)\n{\n    vec2 dxy = vec2(dFdx(d), dFdy(d));\n    float w = length(dxy);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.7 * scale * d, 0.0, 1.0);\n}\n\n// Manual derivatives version (for discontinuous gradients)\nfloat antialias_l2_dxy(float d, vec2 dxy)\n{\n    float w = length(dxy);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.7 * scale * d, 0.0, 1.0);\n}"}]},{name:"2D Shapes",icon:"Hexagon",snippets:[{name:"Circle",description:"Signed distance to a circle",author:"Inigo Quilez (iquilezles.org)",code:"float sd_circle(vec2 p, float r)\n{\n    return length(p) - r;\n}"},{name:"Box",description:"Signed distance to an axis-aligned box",author:"Inigo Quilez (iquilezles.org)",code:"float sd_box(vec2 p, vec2 b)\n{\n    vec2 d = abs(p) - b;\n    return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0);\n}"},{name:"Rounded Box",description:"Box with individually rounded corners",author:"Inigo Quilez (iquilezles.org)",code:"float sd_rounded_box(vec2 p, vec2 b, vec4 r)\n{\n    r.xy = (p.x > 0.0) ? r.xy : r.zw;\n    r.x  = (p.y > 0.0) ? r.x  : r.y;\n    vec2 q = abs(p) - b + r.x;\n    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r.x;\n}"},{name:"Line Segment",description:"Distance to a line segment between two points",author:"Inigo Quilez (iquilezles.org)",code:"float sd_segment(vec2 p, vec2 a, vec2 b)\n{\n    vec2 pa = p - a, ba = b - a;\n    float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n    return length(pa - ba * h);\n}"},{name:"Equilateral Triangle",description:"SDF for an equilateral triangle",author:"Inigo Quilez (iquilezles.org)",code:"float sd_triangle(vec2 p, float r)\n{\n    const float k = sqrt(3.0);\n    p.x = abs(p.x) - r;\n    p.y = p.y + r / k;\n    if (p.x + k * p.y > 0.0) p = vec2(p.x - k * p.y, -k * p.x - p.y) / 2.0;\n    p.x -= clamp(p.x, -2.0 * r, 0.0);\n    return -length(p) * sign(p.y);\n}"},{name:"Ring",description:"Signed distance to a ring (annulus)",author:"Inigo Quilez (iquilezles.org)",code:"float sd_ring(vec2 p, float r, float thickness)\n{\n    return abs(length(p) - r) - thickness;\n}"},{name:"Capsule",description:"Segment with radius (pill shape)",author:"Inigo Quilez (iquilezles.org)",code:"float sd_capsule(vec2 p, vec2 a, vec2 b, float r)\n{\n    vec2 pa = p - a, ba = b - a;\n    float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n    return length(pa - ba * h) - r;\n}"},{name:"Vesica",description:"Lens shape from two overlapping circles; w = width, h = height",author:"Inigo Quilez (iquilezles.org)",code:"float sd_vesica(vec2 p, float w, float h)\n{\n    vec2 p2 = abs(p);\n    float d = 0.5 * (w * w - h * h) / h;\n    vec3 c = (w * p2.y < d * (p2.x - w))\n        ? vec3(0.0, w, 0.0)\n        : vec3(-d, 0.0, d + h);\n    return length(p2 - c.yx) - c.z;\n}"},{name:"Hexagon",description:"Regular hexagon (flat-top), r = half-width",author:"Inigo Quilez (iquilezles.org)",code:"float sd_hexagon(vec2 p, float r)\n{\n    const vec3 k = vec3(-0.866025404, 0.5, 0.577350269);\n    p = abs(p);\n    p -= 2.0 * min(dot(k.xy, p), 0.0) * k.xy;\n    p -= vec2(clamp(p.x, -k.z * r, k.z * r), r);\n    return length(p) * sign(p.y);\n}"},{name:"Pentagon",description:"Regular pentagon",author:"Inigo Quilez (iquilezles.org)",code:"float sd_pentagon(vec2 p, float r)\n{\n    const vec3 k = vec3(0.809016994, 0.587785252, 0.726542528);\n    p.x = abs(p.x);\n    p -= 2.0 * min(dot(vec2(-k.x, k.y), p), 0.0) * vec2(-k.x, k.y);\n    p -= 2.0 * min(dot(vec2(k.x, k.y), p), 0.0) * vec2(k.x, k.y);\n    p -= vec2(clamp(p.x, -r * k.z, r * k.z), r);\n    return length(p) * sign(p.y);\n}"},{name:"Star (5-point)",description:"Regular 5-point star (pentagram)",author:"Inigo Quilez (iquilezles.org)",code:"float sd_pentagram(vec2 p, float r)\n{\n    const float k1 = 0.809016994;\n    const float k2 = 0.309016994;\n    const vec2 v1 = vec2(k1, -0.587785252);\n    const vec2 v2 = vec2(-k1, -0.587785252);\n    const vec2 v3 = vec2(k2, -0.951056516);\n    p.x = abs(p.x);\n    p -= 2.0 * max(dot(v1, p), 0.0) * v1;\n    p -= 2.0 * max(dot(v2, p), 0.0) * v2;\n    p.x = abs(p.x);\n    p.y -= r;\n    return length(p - v3 * clamp(dot(p, v3), 0.0, 0.726542528 * r)) * sign(p.y * v3.x - p.x * v3.y);\n}"},{name:"Arc",description:"Circular arc; sc = sin/cos of half aperture, ra = radius, rb = thickness",author:"Inigo Quilez (iquilezles.org)",code:"float sd_arc(vec2 p, vec2 sc, float ra, float rb)\n{\n    p.x = abs(p.x);\n    return ((sc.y * p.x > sc.x * p.y)\n        ? length(p - sc * ra)\n        : abs(length(p) - ra)) - rb;\n}"},{name:"Ellipse",description:"Axis-aligned ellipse; ab = semi-axes",author:"Inigo Quilez (iquilezles.org)",code:"float sd_ellipse(vec2 p, vec2 ab)\n{\n    p = abs(p);\n    if (p.x > p.y) { p = p.yx; ab = ab.yx; }\n    float l = ab.y * ab.y - ab.x * ab.x;\n    float m = ab.x * p.x / l;\n    float m2 = m * m;\n    float n = ab.y * p.y / l;\n    float n2 = n * n;\n    float c = (m2 + n2 - 1.0) / 3.0;\n    float c3 = c * c * c;\n    float q = c3 + m2 * n2 * 2.0;\n    float d = c3 + m2 * n2;\n    float g = m + m * n2;\n    float co;\n    if (d < 0.0) {\n        float h = acos(q / c3) / 3.0;\n        float s = cos(h), t = sin(h) * sqrt(3.0);\n        float rx = sqrt(-c * (s + t + 2.0) + m2);\n        float ry = sqrt(-c * (s - t + 2.0) + m2);\n        co = (ry + sign(l) * rx + abs(g) / (rx * ry) - m) * 0.5;\n    } else {\n        float h = 2.0 * m * n * sqrt(d);\n        float s = sign(q + h) * pow(abs(q + h), 1.0 / 3.0);\n        float u = sign(q - h) * pow(abs(q - h), 1.0 / 3.0);\n        float rx = -s - u - c * 4.0 + 2.0 * m2;\n        float ry = (s - u) * sqrt(3.0);\n        float rm = sqrt(rx * rx + ry * ry);\n        co = (ry / sqrt(rm - rx) + 2.0 * g / rm - m) * 0.5;\n    }\n    vec2 r = ab * vec2(co, sqrt(1.0 - co * co));\n    return length(r - p) * sign(p.y - r.y);\n}"},{name:"SDF Operations",description:"Union, intersection, subtraction, and smooth variants",author:"Inigo Quilez (iquilezles.org)",code:"float op_union(float d1, float d2) { return min(d1, d2); }\nfloat op_intersect(float d1, float d2) { return max(d1, d2); }\nfloat op_subtract(float d1, float d2) { return max(-d1, d2); }\n\nfloat op_smooth_union(float d1, float d2, float k)\n{\n    float h = clamp(0.5 + 0.5 * (d2 - d1) / k, 0.0, 1.0);\n    return mix(d2, d1, h) - k * h * (1.0 - h);\n}\n\nfloat op_smooth_intersect(float d1, float d2, float k)\n{\n    float h = clamp(0.5 - 0.5 * (d2 - d1) / k, 0.0, 1.0);\n    return mix(d2, d1, h) + k * h * (1.0 - h);\n}\n\nfloat op_smooth_subtract(float d1, float d2, float k)\n{\n    float h = clamp(0.5 - 0.5 * (d2 + d1) / k, 0.0, 1.0);\n    return mix(d2, -d1, h) + k * h * (1.0 - h);\n}"}]}],A=[{name:"Constants",icon:"Pi",snippets:[...x,{name:"Golden Ratio",description:"PHI, golden angle, 2D & 3D rotation matrices",code:"#define PHI          1.61803398875\n#define GOLDEN_ANGLE 2.39996322972\n\nconst mat2 GOLDEN_ROT2 = mat2(\n    -0.73736887808,  0.67549029426,\n    -0.67549029426, -0.73736887808);\n\nconst mat3 GOLDEN_ROT3 = mat3(\n    -0.571464913, +0.814921382, +0.096597072,\n    -0.278044873, -0.303026659, +0.911518454,\n    +0.772087367, +0.494042493, +0.399753815);"}]},{name:"Noise",icon:"Hash",snippets:[{name:"Random",description:"Pseudorandom number from float/vec2/vec3/vec4 seed",options:[{label:"1D → 1D",code:"float rand1(float p)\n{\n    p = fract(p * 0.1031);\n    p *= p + 33.33;\n    p *= p + p;\n    return fract(p);\n}"},{label:"2D → 1D",code:"float rand1(vec2 p)\n{\n    vec3 p3 = fract(vec3(p.xyx) * 0.1031);\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.x + p3.y) * p3.z);\n}"},{label:"2D → 2D",code:"vec2 rand2(vec2 p)\n{\n    vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.xx + p3.yz) * p3.zy);\n}"},{label:"2D → 3D",code:"vec3 rand3(vec2 p)\n{\n    vec4 p4 = fract(vec4(p.xyx, p.y) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract((p4.xxz + p4.yww) * p4.zyx);\n}"},{label:"3D → 1D",code:"float rand1(vec3 p)\n{\n    vec4 p4 = fract(vec4(p.xyzx) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract((p4.x + p4.y + p4.z) * p4.w);\n}"},{label:"3D → 2D",code:"vec2 rand2(vec3 p)\n{\n    vec4 p4 = fract(vec4(p.xyzx) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract((p4.xx + p4.yz) * p4.zy);\n}"},{label:"3D → 3D",code:"vec3 rand3(vec3 p)\n{\n    vec4 p4 = fract(vec4(p.xyzx) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract((p4.xxz + p4.yww) * p4.zyx);\n}"},{label:"1D → 4D",code:"vec4 rand4(float p)\n{\n    vec4 p4 = fract(vec4(p) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract(vec4(\n        (p4.x + p4.y) * p4.z,\n        (p4.y + p4.z) * p4.w,\n        (p4.z + p4.w) * p4.x,\n        (p4.w + p4.x) * p4.y\n    ));\n}"},{label:"4D → 4D",code:"vec4 rand4(vec4 p)\n{\n    vec4 p4 = fract(p * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract(vec4(\n        (p4.x + p4.y) * p4.z,\n        (p4.y + p4.z) * p4.w,\n        (p4.z + p4.w) * p4.x,\n        (p4.w + p4.x) * p4.y\n    ));\n}"}]},{name:"Integer Hash",description:"Pseudorandom from int/ivec2/ivec3 seed (GLSL 300 es)",options:[{label:"int → float",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nfloat hash_i(int n)\n{\n    return float(hash_u(uint(n))) / 4294967295.0;\n}"},{label:"ivec2 → float",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nfloat hash_i(ivec2 p)\n{\n    uint n = hash_u(uint(p.x)) + hash_u(uint(p.y)) * 57u;\n    return float(hash_u(n)) / 4294967295.0;\n}"},{label:"ivec2 → vec2",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nvec2 hash_i2(ivec2 p)\n{\n    uint n = hash_u(uint(p.x)) + hash_u(uint(p.y)) * 57u;\n    return vec2(\n        float(hash_u(n)) / 4294967295.0,\n        float(hash_u(n + 1u)) / 4294967295.0\n    );\n}"},{label:"ivec3 → float",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nfloat hash_i(ivec3 p)\n{\n    uint n = hash_u(uint(p.x)) + hash_u(uint(p.y)) * 57u + hash_u(uint(p.z)) * 131u;\n    return float(hash_u(n)) / 4294967295.0;\n}"},{label:"ivec3 → vec2",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nvec2 hash_i2(ivec3 p)\n{\n    uint n = hash_u(uint(p.x)) + hash_u(uint(p.y)) * 57u + hash_u(uint(p.z)) * 131u;\n    return vec2(\n        float(hash_u(n)) / 4294967295.0,\n        float(hash_u(n + 1u)) / 4294967295.0\n    );\n}"},{label:"ivec3 → vec3",code:"uint hash_u(uint n)\n{\n    n = (n ^ 61u) ^ (n >> 16u);\n    n *= 9u;\n    n = n ^ (n >> 4u);\n    n *= 0x27d4eb2du;\n    return n ^ (n >> 15u);\n}\n\nvec3 hash_i3(ivec3 p)\n{\n    uint n = hash_u(uint(p.x)) + hash_u(uint(p.y)) * 57u + hash_u(uint(p.z)) * 131u;\n    return vec3(\n        float(hash_u(n)) / 4294967295.0,\n        float(hash_u(n + 1u)) / 4294967295.0,\n        float(hash_u(n + 2u)) / 4294967295.0\n    );\n}"}]},{name:"Value Noise",description:"Smooth interpolated value noise",options:[{label:"2D",code:"float rand1(vec2 p)\n{\n    vec3 p3 = fract(vec3(p.xyx) * 0.1031);\n    p3 += dot(p3, p3.yzx + 33.33);\n    return fract((p3.x + p3.y) * p3.z);\n}\n\nfloat value_noise(vec2 p)\n{\n    vec2 i = floor(p);\n    vec2 f = fract(p);\n    f = f * f * (3.0 - 2.0 * f);\n    float a = rand1(i);\n    float b = rand1(i + vec2(1.0, 0.0));\n    float c = rand1(i + vec2(0.0, 1.0));\n    float d = rand1(i + vec2(1.0, 1.0));\n    return mix(mix(a, b, f.x), mix(c, d, f.x), f.y);\n}"},{label:"3D",code:"float rand1(vec3 p)\n{\n    vec4 p4 = fract(vec4(p.xyzx) * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract((p4.x + p4.y + p4.z) * p4.w);\n}\n\nfloat value_noise(vec3 p)\n{\n    vec3 i = floor(p);\n    vec3 f = fract(p);\n    f = f * f * (3.0 - 2.0 * f);\n    float a = rand1(i);\n    float b = rand1(i + vec3(1.0, 0.0, 0.0));\n    float c = rand1(i + vec3(0.0, 1.0, 0.0));\n    float d = rand1(i + vec3(1.0, 1.0, 0.0));\n    float e = rand1(i + vec3(0.0, 0.0, 1.0));\n    float f0 = rand1(i + vec3(1.0, 0.0, 1.0));\n    float g = rand1(i + vec3(0.0, 1.0, 1.0));\n    float h = rand1(i + vec3(1.0, 1.0, 1.0));\n    return mix(\n        mix(mix(a, b, f.x), mix(c, d, f.x), f.y),\n        mix(mix(e, f0, f.x), mix(g, h, f.x), f.y),\n        f.z\n    );\n}"},{label:"4D",code:"vec4 rand4(vec4 p)\n{\n    vec4 p4 = fract(p * vec4(0.1031, 0.1030, 0.0973, 0.1099));\n    p4 += dot(p4, p4.wzxy + 33.33);\n    return fract(vec4(\n        (p4.x + p4.y) * p4.z,\n        (p4.y + p4.z) * p4.w,\n        (p4.z + p4.w) * p4.x,\n        (p4.w + p4.x) * p4.y\n    ));\n}\n\nfloat value_noise(vec4 p)\n{\n    vec4 i = floor(p);\n    vec4 f = fract(p);\n    f = f * f * (3.0 - 2.0 * f);\n    float n0000 = rand4(i).x;\n    float n1000 = rand4(i + vec4(1, 0, 0, 0)).x;\n    float n0100 = rand4(i + vec4(0, 1, 0, 0)).x;\n    float n1100 = rand4(i + vec4(1, 1, 0, 0)).x;\n    float n0010 = rand4(i + vec4(0, 0, 1, 0)).x;\n    float n1010 = rand4(i + vec4(1, 0, 1, 0)).x;\n    float n0110 = rand4(i + vec4(0, 1, 1, 0)).x;\n    float n1110 = rand4(i + vec4(1, 1, 1, 0)).x;\n    float n0001 = rand4(i + vec4(0, 0, 0, 1)).x;\n    float n1001 = rand4(i + vec4(1, 0, 0, 1)).x;\n    float n0101 = rand4(i + vec4(0, 1, 0, 1)).x;\n    float n1101 = rand4(i + vec4(1, 1, 0, 1)).x;\n    float n0011 = rand4(i + vec4(0, 0, 1, 1)).x;\n    float n1011 = rand4(i + vec4(1, 0, 1, 1)).x;\n    float n0111 = rand4(i + vec4(0, 1, 1, 1)).x;\n    float n1111 = rand4(i + vec4(1, 1, 1, 1)).x;\n    return mix(\n        mix(mix(mix(n0000, n1000, f.x), mix(n0100, n1100, f.x), f.y),\n            mix(mix(n0010, n1010, f.x), mix(n0110, n1110, f.x), f.y), f.z),\n        mix(mix(mix(n0001, n1001, f.x), mix(n0101, n1101, f.x), f.y),\n            mix(mix(n0011, n1011, f.x), mix(n0111, n1111, f.x), f.y), f.z),\n        f.w\n    );\n}"}]},{name:"Simplex Noise",description:"Classic simplex noise",author:"Ashima Arts, Stefan Gustavson (webgl-noise)",options:[{label:"2D",code:"vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x * 34.0) + 1.0) * x); }\n\nfloat simplex_noise(vec2 v)\n{\n    const vec4 C = vec4(0.211324865405187, 0.366025403784439,\n                       -0.577350269189626, 0.024390243902439);\n    vec2 i = floor(v + dot(v, C.yy));\n    vec2 x0 = v - i + dot(i, C.xx);\n    vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n    vec4 x12 = x0.xyxy + C.xxzz;\n    x12.xy -= i1;\n    i = mod289(i);\n    vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0))\n                            + i.x + vec3(0.0, i1.x, 1.0));\n    vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy),\n                            dot(x12.zw, x12.zw)), 0.0);\n    m = m * m;\n    m = m * m;\n    vec3 x = 2.0 * fract(p * C.www) - 1.0;\n    vec3 h = abs(x) - 0.5;\n    vec3 ox = floor(x + 0.5);\n    vec3 a0 = x - ox;\n    m *= 1.79284291400159 - 0.85373472095314 * (a0 * a0 + h * h);\n    vec3 g;\n    g.x = a0.x * x0.x + h.x * x0.y;\n    g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n    return 130.0 * dot(m, g);\n}"},{label:"3D",code:"vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec4 permute(vec4 x) { return mod289(((x * 34.0) + 1.0) * x); }\nvec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }\n\nfloat simplex_noise(vec3 v)\n{\n    const vec2 C = vec2(1.0 / 6.0, 1.0 / 3.0);\n    const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);\n    vec3 i = floor(v + dot(v, C.yyy));\n    vec3 x0 = v - i + dot(i, C.xxx);\n    vec3 g = step(x0.yzx, x0.xyz);\n    vec3 l = 1.0 - g;\n    vec3 i1 = min(g.xyz, l.zxy);\n    vec3 i2 = max(g.xyz, l.zxy);\n    vec3 x1 = x0 - i1 + C.xxx;\n    vec3 x2 = x0 - i2 + C.yyy;\n    vec3 x3 = x0 - D.yyy;\n    i = mod289(i);\n    vec4 p = permute(permute(permute(\n        i.z + vec4(0.0, i1.z, i2.z, 1.0))\n        + i.y + vec4(0.0, i1.y, i2.y, 1.0))\n        + i.x + vec4(0.0, i1.x, i2.x, 1.0));\n    float n_ = 0.142857142857;\n    vec3 ns = n_ * D.wyz - D.xzx;\n    vec4 j = p - 49.0 * floor(p * ns.z * ns.z);\n    vec4 x_ = floor(j * ns.z);\n    vec4 y_ = floor(j - 7.0 * x_);\n    vec4 x = x_ * ns.x + ns.yyyy;\n    vec4 y = y_ * ns.x + ns.yyyy;\n    vec4 h = 1.0 - abs(x) - abs(y);\n    vec4 b0 = vec4(x.xy, y.xy);\n    vec4 b1 = vec4(x.zw, y.zw);\n    vec4 s0 = floor(b0) * 2.0 + 1.0;\n    vec4 s1 = floor(b1) * 2.0 + 1.0;\n    vec4 sh = -step(h, vec4(0.0));\n    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;\n    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;\n    vec3 p0 = vec3(a0.xy, h.x);\n    vec3 p1 = vec3(a0.zw, h.y);\n    vec3 p2 = vec3(a1.xy, h.z);\n    vec3 p3 = vec3(a1.zw, h.w);\n    vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n    vec4 m = max(0.5 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);\n    m = m * m;\n    return 105.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));\n}"},{label:"4D",code:"vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nfloat mod289(float x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec4 permute(vec4 x) { return mod289(((x * 34.0) + 1.0) * x); }\nfloat permute(float x) { return mod289(((x * 34.0) + 1.0) * x); }\nvec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }\nfloat taylorInvSqrt(float r) { return 1.79284291400159 - 0.85373472095314 * r; }\n\nvec4 grad4(float j, vec4 ip)\n{\n    const vec4 ones = vec4(1.0, 1.0, 1.0, -1.0);\n    vec4 p, s;\n    p.xyz = floor(fract(vec3(j) * ip.xyz) * 7.0) * ip.z - 1.0;\n    p.w = 1.5 - dot(abs(p.xyz), ones.xyz);\n    s = vec4(lessThan(p, vec4(0.0)));\n    p.xyz = p.xyz + (s.xyz * 2.0 - 1.0) * s.www;\n    return p;\n}\n\nfloat simplex_noise(vec4 v)\n{\n    const float F4 = 0.309016994374947451;\n    const vec4 C = vec4(0.138196601125011, 0.276393202250021, 0.414589803375032, -0.447213595499958);\n    vec4 i = floor(v + dot(v, vec4(F4)));\n    vec4 x0 = v - i + dot(i, C.xxxx);\n    vec4 i0;\n    vec3 isX = step(x0.yzw, x0.xxx);\n    vec3 isYZ = step(x0.zww, x0.yyz);\n    i0.x = isX.x + isX.y + isX.z;\n    i0.yzw = 1.0 - isX;\n    i0.y += isYZ.x + isYZ.y;\n    i0.zw += 1.0 - isYZ.xy;\n    i0.z += isYZ.z;\n    i0.w += 1.0 - isYZ.z;\n    vec4 i3 = clamp(i0, 0.0, 1.0);\n    vec4 i2 = clamp(i0 - 1.0, 0.0, 1.0);\n    vec4 i1 = clamp(i0 - 2.0, 0.0, 1.0);\n    vec4 x1 = x0 - i1 + C.xxxx;\n    vec4 x2 = x0 - i2 + C.yyyy;\n    vec4 x3 = x0 - i3 + C.zzzz;\n    vec4 x4 = x0 + C.wwww;\n    i = mod289(i);\n    float j0 = permute(permute(permute(permute(i.w) + i.z) + i.y) + i.x);\n    vec4 j1 = permute(permute(permute(permute(\n        i.w + vec4(i1.w, i2.w, i3.w, 1.0))\n        + i.z + vec4(i1.z, i2.z, i3.z, 1.0))\n        + i.y + vec4(i1.y, i2.y, i3.y, 1.0))\n        + i.x + vec4(i1.x, i2.x, i3.x, 1.0));\n    vec4 ip = vec4(1.0 / 294.0, 1.0 / 49.0, 1.0 / 7.0, 0.0);\n    vec4 p0 = grad4(j0, ip);\n    vec4 p1 = grad4(j1.x, ip);\n    vec4 p2 = grad4(j1.y, ip);\n    vec4 p3 = grad4(j1.z, ip);\n    vec4 p4 = grad4(j1.w, ip);\n    vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n    p4 *= taylorInvSqrt(dot(p4, p4));\n    vec3 m0 = max(0.6 - vec3(dot(x0, x0), dot(x1, x1), dot(x2, x2)), 0.0);\n    vec2 m1 = max(0.6 - vec2(dot(x3, x3), dot(x4, x4)), 0.0);\n    m0 = m0 * m0;\n    m1 = m1 * m1;\n    return 49.0 * (dot(m0 * m0, vec3(dot(p0, x0), dot(p1, x1), dot(p2, x2)))\n        + dot(m1 * m1, vec2(dot(p3, x3), dot(p4, x4))));\n}"}]},{name:"FBM (Fractal Brownian Motion)",description:"Layered noise with configurable octaves",options:[{label:"2D",code:"float fbm(vec2 p)\n{\n    float value = 0.0;\n    float amplitude = 0.5;\n    float frequency = 1.0;\n    for (int i = 0; i < 6; i++)\n    {\n        value += amplitude * value_noise(p * frequency);\n        frequency *= 2.0;\n        amplitude *= 0.5;\n    }\n    return value;\n}"},{label:"3D",code:"float fbm(vec3 p)\n{\n    float value = 0.0;\n    float amplitude = 0.5;\n    float frequency = 1.0;\n    for (int i = 0; i < 6; i++)\n    {\n        value += amplitude * value_noise(p * frequency);\n        frequency *= 2.0;\n        amplitude *= 0.5;\n    }\n    return value;\n}"}]},{name:"Voronoi",description:"Distance to nearest cell center; Voronoi diagram–style cell noise",author:"Georgy Voronoi (Voronoi diagrams)",options:[{label:"2D",code:"float voronoi(vec2 p)\n{\n    vec2 i = floor(p);\n    vec2 f = fract(p);\n    float min_dist = 1.0;\n    for (int y = -1; y <= 1; y++)\n    {\n        for (int x = -1; x <= 1; x++)\n        {\n            vec2 neighbor = vec2(float(x), float(y));\n            vec2 point = rand2(i + neighbor);\n            vec2 diff = neighbor + point - f;\n            float dist = length(diff);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}"},{label:"3D",code:"float voronoi(vec3 p)\n{\n    vec3 i = floor(p);\n    vec3 f = fract(p);\n    float min_dist = 1.0;\n    for (int z = -1; z <= 1; z++)\n    {\n        for (int y = -1; y <= 1; y++)\n        {\n            for (int x = -1; x <= 1; x++)\n            {\n                vec3 neighbor = vec3(float(x), float(y), float(z));\n                vec3 point = rand3(i + neighbor);\n                vec3 diff = neighbor + point - f;\n                float dist = length(diff);\n                min_dist = min(min_dist, dist);\n            }\n        }\n    }\n    return min_dist;\n}"}]},{name:"Worley Noise",description:"Cellular texture basis function; F1 distance to nearest feature point",author:"Steven Worley (SIGGRAPH 1996)",options:[{label:"2D",code:"float worley(vec2 p)\n{\n    vec2 i = floor(p);\n    vec2 f = fract(p);\n    float min_dist = 1.0;\n    for (int y = -1; y <= 1; y++)\n    {\n        for (int x = -1; x <= 1; x++)\n        {\n            vec2 neighbor = vec2(float(x), float(y));\n            vec2 point = rand2(i + neighbor);\n            vec2 diff = neighbor + point - f;\n            float dist = length(diff);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}"},{label:"3D",code:"float worley(vec3 p)\n{\n    vec3 i = floor(p);\n    vec3 f = fract(p);\n    float min_dist = 1.0;\n    for (int z = -1; z <= 1; z++)\n    {\n        for (int y = -1; y <= 1; y++)\n        {\n            for (int x = -1; x <= 1; x++)\n            {\n                vec3 neighbor = vec3(float(x), float(y), float(z));\n                vec3 point = rand3(i + neighbor);\n                vec3 diff = neighbor + point - f;\n                float dist = length(diff);\n                min_dist = min(min_dist, dist);\n            }\n        }\n    }\n    return min_dist;\n}"}]},{name:"Turbulence",description:"Fake fluid dynamics via layered rotated sine waves",author:"Xor (mini.gmshaders.com/p/turbulence)",options:[{label:"2D",code:"// Turbulence: layered sine-wave displacements with golden-ratio rotation.\n// TURB_NUM, TURB_AMP, TURB_SPEED, TURB_FREQ, TURB_EXP – see Constants.\n#define TURB_NUM   10.0\n#define TURB_AMP   0.7\n#define TURB_SPEED 0.3\n#define TURB_FREQ  2.0\n#define TURB_EXP   1.4\n\nconst mat2 GOLDEN_ROT2 = mat2(\n    -0.73736887808,  0.67549029426,\n    -0.67549029426, -0.73736887808);\n\nvec2 turbulence(vec2 pos, float time)\n{\n    float freq = TURB_FREQ;\n    mat2 rot = GOLDEN_ROT2;\n    for (float i = 0.0; i < TURB_NUM; i++)\n    {\n        float phase = freq * (pos * rot).y + TURB_SPEED * time + i;\n        pos += TURB_AMP * rot[0] * sin(phase) / freq;\n        rot *= GOLDEN_ROT2;\n        freq *= TURB_EXP;\n    }\n    return pos;\n}"},{label:"3D",code:"// Turbulence 3D: layered sine-wave displacements with golden-ratio rotation.\n#define TURB_NUM   10.0\n#define TURB_AMP   0.7\n#define TURB_SPEED 0.3\n#define TURB_FREQ  2.0\n#define TURB_EXP   1.4\n\nconst mat3 GOLDEN_ROT3 = mat3(\n    -0.571464913, +0.814921382, +0.096597072,\n    -0.278044873, -0.303026659, +0.911518454,\n    +0.772087367, +0.494042493, +0.399753815);\n\nvec3 turbulence(vec3 pos, float time)\n{\n    float freq = TURB_FREQ;\n    mat3 rot = GOLDEN_ROT3;\n    for (float i = 0.0; i < TURB_NUM; i++)\n    {\n        float phase = freq * (pos * rot).y + TURB_SPEED * time + i;\n        pos += TURB_AMP * rot[0] * sin(phase) / freq;\n        rot *= GOLDEN_ROT3;\n        freq *= TURB_EXP;\n    }\n    return pos;\n}"}]},{name:"Dot Noise 3D",description:"Cheap aperiodic 3D noise using golden‑ratio gyroids",author:"Xor (mini.gmshaders.com/p/dot-noise)",code:"// Dot Noise: a fast alternative to 3D value / Perlin / simplex\n// noise.  Uses a gyroid formula with golden‑ratio rotation so\n// the pattern never repeats.  Returns a value in [‑3, +3].\n\nfloat dot_noise(vec3 p)\n{\n    const float PHI = 1.618033988;\n\n    // Golden‑angle rotation on the vec3(1, φ, φ²) axis\n    const mat3 GOLD = mat3(\n        -0.571464913, +0.814921382, +0.096597072,\n        -0.278044873, -0.303026659, +0.911518454,\n        +0.772087367, +0.494042493, +0.399753815);\n\n    return dot(cos(GOLD * p), sin(PHI * p * GOLD));\n}\n\n// Fractal layering for richer detail (returns ~[‑1, +1])\nfloat dot_noise_fbm(vec3 p)\n{\n    const float PHI = 1.618033988;\n    const mat3 GOLD = mat3(\n        -0.571464913, +0.814921382, +0.096597072,\n        -0.278044873, -0.303026659, +0.911518454,\n        +0.772087367, +0.494042493, +0.399753815);\n\n    float value = 0.0;\n    float amplitude = 0.5;\n    for (int i = 0; i < 5; i++)\n    {\n        value += amplitude * dot(cos(GOLD * p), sin(PHI * p * GOLD)) / 3.0;\n        p = GOLD * p * 2.0;\n        amplitude *= 0.5;\n    }\n    return value;\n}"}]},{name:"Color",icon:"Contrast",snippets:[{name:"HSV ↔ RGB",description:"Convert between HSV and RGB color spaces",author:"Sam Hocevar (RGB→HSV)",options:[{label:"HSV → RGB",code:"vec3 hsv_to_rgb(vec3 c)\n{\n    vec3 p = abs(fract(c.xxx + vec3(1.0, 2.0/3.0, 1.0/3.0)) * 6.0 - 3.0);\n    return c.z * mix(vec3(1.0), clamp(p - 1.0, 0.0, 1.0), c.y);\n}"},{label:"RGB → HSV",code:"vec3 rgb_to_hsv(vec3 c)\n{\n    vec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = 1.0e-10;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}"}]},{name:"Cosine Palette",description:"Cosine gradient palette (4 vec3 parameters)",author:"Inigo Quilez (iquilezles.org/articles/palettes)",code:"vec3 palette(float t, vec3 a, vec3 b, vec3 c, vec3 d)\n{\n    return a + b * cos(TAU * (c * t + d));\n}\n\n// Example presets:\n// Rainbow:   palette(t, vec3(0.5), vec3(0.5), vec3(1.0), vec3(0.0, 0.33, 0.67))\n// Warm:      palette(t, vec3(0.5), vec3(0.5), vec3(1.0), vec3(0.0, 0.1, 0.2))\n// Cool:      palette(t, vec3(0.5), vec3(0.5), vec3(1.0, 1.0, 0.5), vec3(0.8, 0.9, 0.3))"},{name:"Linear ↔ sRGB",description:"Linear ↔ sRGB with IEC 61966-2-1 transfer curve",options:[{label:"Linear → sRGB",code:"vec3 linear_to_srgb(vec3 c)\n{\n    vec3 lo = 12.92 * c;\n    vec3 hi = 1.055 * pow(c, vec3(1.0 / 2.4)) - 0.055;\n    return mix(lo, hi, step(vec3(0.0031308), c));\n}"},{label:"sRGB → Linear",code:"vec3 srgb_to_linear(vec3 c)\n{\n    vec3 lo = c / 12.92;\n    vec3 hi = pow((c + 0.055) / 1.055, vec3(2.4));\n    return mix(lo, hi, step(vec3(0.04045), c));\n}"}]},{name:"Tonemapping",description:"HDR → LDR tonemapping operators",author:"Krzysztof Narkowicz (ACES), Erik Reinhard et al.",options:[{label:"ACES",code:"vec3 tonemap_aces(vec3 x)\n{\n    float a = 2.51;\n    float b = 0.03;\n    float c = 2.43;\n    float d = 0.59;\n    float e = 0.14;\n    return clamp((x * (a * x + b)) / (x * (c * x + d) + e), 0.0, 1.0);\n}"},{label:"Reinhard",code:"vec3 tonemap_reinhard(vec3 x)\n{\n    return x / (1.0 + x);\n}"},{label:"Reinhard (white point)",code:"vec3 tonemap_reinhard_ext(vec3 x, float white)\n{\n    vec3 num = x * (1.0 + x / (white * white));\n    return num / (1.0 + x);\n}"}]},{name:"Hue Rotation",description:"Rotate the hue of an RGB color",author:"W3C CSS Filters (hue-rotate matrix)",code:"vec3 hue_rotate(vec3 col, float angle)\n{\n    float s = sin(angle);\n    float c = cos(angle);\n    mat3 m = mat3(\n        0.299 + 0.701*c + 0.168*s,  0.587 - 0.587*c + 0.330*s,  0.114 - 0.114*c - 0.497*s,\n        0.299 - 0.299*c - 0.328*s,  0.587 + 0.413*c + 0.035*s,  0.114 - 0.114*c + 0.292*s,\n        0.299 - 0.300*c + 1.250*s,  0.587 - 0.588*c - 1.050*s,  0.114 + 0.886*c - 0.203*s\n    );\n    return m * col;\n}"},{name:"Luminance",description:"Perceived brightness of an RGB color",author:"ITU-R BT.709 coefficients",code:"float luminance(vec3 col)\n{\n    return dot(col, vec3(0.2126, 0.7152, 0.0722));\n}"},{name:"OKLab - OKLch",description:"Perceptually uniform color space; OKLch = cylindrical OKLab",author:"Björn Ottosson (bottosson.github.io/posts/oklab)",options:[{label:"RGB → OKLab",code:"float ok_cbrt(float x)\n{\n    return sign(x) * pow(abs(x), 1.0 / 3.0);\n}\n\nvec3 rgb_to_oklab(vec3 c)\n{\n    float l = 0.4122214708 * c.r + 0.5363325363 * c.g + 0.0514459929 * c.b;\n    float m = 0.2119034982 * c.r + 0.6806995451 * c.g + 0.1073969566 * c.b;\n    float s = 0.0883024619 * c.r + 0.2817188376 * c.g + 0.6299787005 * c.b;\n    float l_ = ok_cbrt(l), m_ = ok_cbrt(m), s_ = ok_cbrt(s);\n    return vec3(\n        0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_,\n        1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_,\n        0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_\n    );\n}"},{label:"OKLab → RGB",code:"vec3 oklab_to_rgb(vec3 c)\n{\n    float l_ = c.r + 0.3963377774 * c.g + 0.2158037573 * c.b;\n    float m_ = c.r - 0.1055613458 * c.g - 0.0638541728 * c.b;\n    float s_ = c.r - 0.0894841775 * c.g - 1.2914855480 * c.b;\n    float l = l_ * l_ * l_, m = m_ * m_ * m_, s = s_ * s_ * s_;\n    return vec3(\n        4.0767416621 * l - 3.3077115913 * m + 0.2309699292 * s,\n        -1.2684380046 * l + 2.6097574011 * m - 0.3413193965 * s,\n        -0.0041960863 * l - 0.7034186147 * m + 1.7076147010 * s\n    );\n}"},{label:"OKLab → OKLch",code:"vec3 oklab_to_oklch(vec3 ok)\n{\n    float L = ok.r;\n    float C = sqrt(ok.g * ok.g + ok.b * ok.b);\n    float H = atan(ok.b, ok.g);\n    return vec3(L, C, H);\n}"},{label:"OKLch → OKLab",code:"vec3 oklch_to_oklab(vec3 lch)\n{\n    float L = lch.r, C = lch.g, H = lch.b;\n    return vec3(L, C * cos(H), C * sin(H));\n}"},{label:"OKLab Mix",author:"Inigo Quilez",code:"// Perceptually uniform mix via LMS cone space. Compact, no separate conversion helpers.\n// https://bottosson.github.io/posts/oklab\n\nvec3 oklab_mix(vec3 colA, vec3 colB, float h)\n{\n    const mat3 kCONEtoLMS = mat3(\n         0.4121656120,  0.5362752080,  0.0514575653,\n         0.2118591070,  0.6807189584,  0.1074065790,\n         0.0883097947,  0.2818474174,  0.6302613616);\n    const mat3 kLMStoCONE = mat3(\n         4.0767245293, -3.3072168827,  0.2307590544,\n        -1.2681437731,  2.6093323231, -0.3411344290,\n        -0.0041119885, -0.7034763098,  1.7068625689);\n    vec3 lmsA = pow(kCONEtoLMS * colA, vec3(1.0 / 3.0));\n    vec3 lmsB = pow(kCONEtoLMS * colB, vec3(1.0 / 3.0));\n    vec3 lms = mix(lmsA, lmsB, h);\n    return kLMStoCONE * (lms * lms * lms);\n}"}]},{name:"Saturation",description:"Adjust color saturation; s=0 grayscale, s=1 original, s>1 oversaturated",code:"vec3 saturation(vec3 col, float sat)\n{\n    float luminance = dot(col, vec3(0.2126, 0.7152, 0.0722));\n    return mix(vec3(luminance), col, sat);\n}"}]},{name:"Coordinates",icon:"Grid3x2",snippets:[{name:"Rotation",description:"Rotate vec2 or vec3 by angle(s)",options:[{label:"2D",code:"mat2 rotate_2d(float angle)\n{\n    float s = sin(angle);\n    float c = cos(angle);\n    return mat2(c, -s, s, c);\n}\n\n// Usage: p.xy *= rotate_2d(angle);"},{label:"3D (Euler)",code:"mat2 rotate_2d(float a)\n{\n    return mat2(cos(a), -sin(a), sin(a), cos(a));\n}\nvec3 euler_rotate(vec3 v, float roll, float pitch, float yaw)\n{\n    v.yz *= rotate_2d(roll);\n    v.xz *= rotate_2d(pitch);\n    v.xy *= rotate_2d(yaw);\n    return v;\n}"},{label:"3D (Axis-Angle)",author:"Xor / Fabrice Neyret (mini.gmshaders.com/p/3d-rotation)",code:"vec3 axis_rotate(vec3 v, vec3 axis, float angle)\n{\n    return mix(dot(v, axis) * axis, v, cos(angle))\n         + sin(angle) * cross(v, axis);\n}"}]},{name:"Quaternions",description:"Quaternion rotation (vec4: x,y,z,w)",options:[{label:"Multiply",code:"vec4 qmul(vec4 a, vec4 b)\n{\n    return vec4(\n        a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,\n        a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,\n        a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w,\n        a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z\n    );\n}"},{label:"Slerp",code:"vec4 qslerp(vec4 a, vec4 b, float t)\n{\n    float d = dot(a, b);\n    if (d < 0.0) { b = -b; d = -d; }\n    if (d > 0.9995) return normalize(mix(a, b, t));\n    float theta = acos(d);\n    float st = sin(theta);\n    return (sin((1.0 - t) * theta) / st) * a + (sin(t * theta) / st) * b;\n}"},{label:"From Axis-Angle",code:"vec4 qfrom_axis_angle(vec3 axis, float angle)\n{\n    float ha = angle * 0.5;\n    float s = sin(ha);\n    return vec4(normalize(axis) * s, cos(ha));\n}"},{label:"To Mat3",code:"mat3 qto_mat3(vec4 q)\n{\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    return mat3(\n        1.0 - 2.0*(y*y + z*z), 2.0*(x*y - z*w), 2.0*(x*z + y*w),\n        2.0*(x*y + z*w), 1.0 - 2.0*(x*x + z*z), 2.0*(y*z - x*w),\n        2.0*(x*z - y*w), 2.0*(y*z + x*w), 1.0 - 2.0*(x*x + y*y)\n    );\n}"},{label:"Rotate Vec3",code:"vec3 qrotate(vec4 q, vec3 v)\n{\n    return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}"}]},{name:"Polar Coordinates",description:"Convert between cartesian and polar/spherical coords",options:[{label:"2D: Cartesian → Polar",code:"vec2 to_polar(vec2 p)\n{\n    return vec2(length(p), atan(p.y, p.x));\n}"},{label:"2D: Polar → Cartesian",code:"vec2 to_cartesian(vec2 polar)\n{\n    return vec2(polar.x * cos(polar.y), polar.x * sin(polar.y));\n}"},{label:"3D: Cartesian → Spherical",code:"// spherical = (r, theta, phi): r=radius, theta=azimuth (xy), phi=polar from +z.\n\nvec3 to_spherical(vec3 p)\n{\n    float r = length(p);\n    float theta = atan(p.y, p.x);\n    float phi = (r > 0.0) ? acos(clamp(p.z / r, -1.0, 1.0)) : 0.0;\n    return vec3(r, theta, phi);\n}"},{label:"3D: Spherical → Cartesian",code:"vec3 to_cartesian(vec3 spherical)\n{\n    float r = spherical.x;\n    float theta = spherical.y;\n    float phi = spherical.z;\n    return r * vec3(sin(phi) * cos(theta), sin(phi) * sin(theta), cos(phi));\n}"}]},{name:"Repeat - Tile",description:"Repeat space for infinite tiling",options:[{label:"Cartesian",code:"vec2 repeat(vec2 p, vec2 size)\n{\n    return mod(p + size * 0.5, size) - size * 0.5;\n}"},{label:"Mirror",code:"vec2 mirror_repeat(vec2 p, vec2 size)\n{\n    vec2 half = size * 0.5;\n    vec2 q = mod(p + half, size * 2.0) - size;\n    return half - abs(q);\n}"},{label:"Angular",code:"// Repeat by angle; n = number of segments (e.g. 6 for hexagon).\n\nvec2 angular_repeat(vec2 p, float n)\n{\n    float a = atan(p.y, p.x);\n    float r = length(p);\n    a = mod(a, 6.28318530718 / n) - 0.5 * 6.28318530718 / n;\n    return vec2(cos(a), sin(a)) * r;\n}"}]},{name:"UV Setup",description:"Centered UV coordinate helpers",author:"Xor (mini.gmshaders.com/p/gm-shaders-mini-scaling)",options:[{label:"Stretched",code:"// Stretched: full resolution to 0–1, non-square screens stretched.\n\nvec2 uv_stretched(vec2 pixel, vec2 res)\n{\n    return (pixel - res * 0.5) / res + 0.5;\n}"},{label:"Fit",code:"// Fit: uniform scale, full area visible (letterboxing).\n\nvec2 uv_fit(vec2 pixel, vec2 res)\n{\n    vec2 center = pixel - res * 0.5;\n    return center / max(res.x, res.y) + 0.5;\n}"},{label:"Fill",code:"// Fill: uniform scale, screen fully covered (edges may crop).\n\nvec2 uv_fill(vec2 pixel, vec2 res)\n{\n    vec2 center = pixel - res * 0.5;\n    return center / min(res.x, res.y) + 0.5;\n}"},{label:"Custom Origin",code:"// Custom origin (e.g. vec2(0.5, 1.0) for middle-bottom).\n\nvec2 uv_center_origin(vec2 pixel, vec2 res, vec2 origin)\n{\n    vec2 center = pixel - res * origin;\n    return center / min(res.x, res.y) + origin;\n}"},{label:"Aspect Ratio",code:"// Correct aspect ratio so circles stay circular.\n\nvec2 uv_aspect(vec2 uv, vec2 res)\n{\n    uv -= 0.5;\n    uv.x *= res.x / res.y;\n    return uv + 0.5;\n}"},{label:"Aspect Centered",code:"// Aspect correction, origin at 0,0.\n\nvec2 uv_aspect_centered(vec2 uv, vec2 res)\n{\n    uv -= 0.5;\n    uv.x *= res.x / res.y;\n    return uv;\n}"},{label:"Fit Texture",code:"// Fit texture with ratio (e.g. vec2(2,1)) to screen, no cropping.\n\nvec2 uv_fit_ratio(vec2 pixel, vec2 res, vec2 ratio)\n{\n    vec2 res_ratio = res / ratio;\n    vec2 origin = vec2(0.5);\n    vec2 center = pixel - res * origin;\n    return center / max(res_ratio.x, res_ratio.y) / ratio + origin;\n}"}]}]},{name:"Math",icon:"Function",snippets:[{name:"Remap",description:"Map a value from one range to another",options:[{label:"Remap",code:"float remap(float value, float in_min, float in_max, float out_min, float out_max)\n{\n    return out_min + (out_max - out_min) * (value - in_min) / (in_max - in_min);\n}"},{label:"To Unit",code:"// Linear map [in_min, in_max] → [0, 1]; no clamp (values outside range extrapolate).\n\nfloat to_unit(float value, float in_min, float in_max)\n{\n    return (value - in_min) / (in_max - in_min);\n}"},{label:"From Unit",code:"// Linear map [0, 1] → [out_min, out_max]; no clamp (values outside range extrapolate).\n\nfloat from_unit(float value, float out_min, float out_max)\n{\n    return out_min + value * (out_max - out_min);\n}"}]},{name:"Smooth Min / Max",description:"Smooth minimum and maximum blending",author:"Inigo Quilez (iquilezles.org/articles/smin)",options:[{label:"Smooth Min",code:"float smin(float a, float b, float k)\n{\n    float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);\n    return mix(b, a, h) - k * h * (1.0 - h);\n}"},{label:"Smooth Max",code:"float smax(float a, float b, float k)\n{\n    float h = clamp(0.5 + 0.5 * (b - a) / k, 0.0, 1.0);\n    return mix(a, b, h) + k * h * (1.0 - h);\n}"}]},{name:"Easing",description:"Easing curves for animations (t in [0,1])",options:[{label:"Quadratic",code:"float ease_in_quad(float t) { return t * t; }\nfloat ease_out_quad(float t) { return t * (2.0 - t); }\nfloat ease_in_out_quad(float t) { return t < 0.5 ? 2.0 * t * t : -1.0 + (4.0 - 2.0 * t) * t; }"},{label:"Cubic",code:"float ease_in_cubic(float t) { return t * t * t; }\nfloat ease_out_cubic(float t) { float u = 1.0 - t; return 1.0 - u * u * u; }\nfloat ease_in_out_cubic(float t) { return t < 0.5 ? 4.0 * t * t * t : 1.0 - pow(-2.0 * t + 2.0, 3.0) * 0.5; }"},{label:"Quartic",code:"float ease_in_quart(float t) { return t * t * t * t; }\nfloat ease_out_quart(float t) { float u = 1.0 - t; return 1.0 - u * u * u * u; }\nfloat ease_in_out_quart(float t) { return t < 0.5 ? 8.0 * t * t * t * t : 1.0 - pow(-2.0 * t + 2.0, 4.0) * 0.5; }"},{label:"Quintic",code:"float ease_in_quint(float t) { return t * t * t * t * t; }\nfloat ease_out_quint(float t) { float u = 1.0 - t; return 1.0 - u * u * u * u * u; }\nfloat ease_in_out_quint(float t) { return t < 0.5 ? 16.0 * t * t * t * t * t : 1.0 - pow(-2.0 * t + 2.0, 5.0) * 0.5; }"},{label:"Exponential",code:"float ease_in_expo(float t) { return t <= 0.0 ? 0.0 : pow(2.0, 10.0 * t - 10.0); }\nfloat ease_out_expo(float t) { return t >= 1.0 ? 1.0 : 1.0 - pow(2.0, -10.0 * t); }\nfloat ease_in_out_expo(float t)\n{\n    if (t <= 0.0) return 0.0;\n    if (t >= 1.0) return 1.0;\n    return t < 0.5 ? pow(2.0, 20.0 * t - 10.0) * 0.5 : 1.0 - pow(2.0, -20.0 * t + 10.0) * 0.5;\n}"},{label:"Sine",code:"float ease_in_sine(float t) { return 1.0 - cos(1.57079632679 * t); }\nfloat ease_out_sine(float t) { return sin(1.57079632679 * t); }\nfloat ease_in_out_sine(float t) { return -0.5 * (cos(3.14159265359 * t) - 1.0); }"},{label:"Circular",code:"float ease_in_circ(float t) { return 1.0 - sqrt(1.0 - t * t); }\nfloat ease_out_circ(float t) { return sqrt(1.0 - (t - 1.0) * (t - 1.0)); }\nfloat ease_in_out_circ(float t)\n{\n    return t < 0.5\n        ? 0.5 * (1.0 - sqrt(1.0 - 4.0 * t * t))\n        : 0.5 * (sqrt(1.0 - (2.0 * t - 2.0) * (2.0 * t - 2.0)) + 1.0);\n}"},{label:"Back",code:"float c1 = 1.70158;\nfloat c3 = c1 + 1.0;\n\nfloat ease_in_back(float t) { return c3 * t * t * t - c1 * t * t; }\nfloat ease_out_back(float t) { float u = 1.0 - t; return 1.0 + c3 * u * u * u + c1 * u * u; }\nfloat ease_in_out_back(float t)\n{\n    float c2 = c1 * 1.525;\n    return t < 0.5\n        ? (pow(2.0 * t, 2.0) * ((c2 + 1.0) * 2.0 * t - c2)) * 0.5\n        : 0.5 * (pow(2.0 * t - 2.0, 2.0) * ((c2 + 1.0) * (2.0 * t - 2.0) + c2) + 2.0);\n}"}]},{name:"Smootherstep",description:"Improved smoothstep (C2 continuous)",author:"Ken Perlin",code:"float smootherstep(float edge0, float edge1, float x)\n{\n    x = clamp((x - edge0) / (edge1 - edge0), 0.0, 1.0);\n    return x * x * x * (x * (x * 6.0 - 15.0) + 10.0);\n}"},{name:"Anti-Aliasing",description:"Smooth edges for SDFs or any continuous function",author:"Xor (mini.gmshaders.com/p/antialiasing)",options:[{label:"SDF",code:"// For SDFs with known pixel scale (texel size).\n\nfloat antialias_sdf(float dist, float texel)\n{\n    return clamp(dist / texel + 0.5, 0.0, 1.0);\n}"},{label:"Derivative (fwidth)",code:"float antialias(float d)\n{\n    float w = fwidth(d);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.5 * scale * d, 0.0, 1.0);\n}"},{label:"Derivative (L2)",code:"float antialias_l2(float d)\n{\n    vec2 dxy = vec2(dFdx(d), dFdy(d));\n    float w = length(dxy);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.7 * scale * d, 0.0, 1.0);\n}"},{label:"Derivative (L2 manual)",code:"float antialias_l2_dxy(float d, vec2 dxy)\n{\n    float w = length(dxy);\n    float scale = w > 0.0 ? 1.0 / w : 1e7;\n    return clamp(0.5 + 0.7 * scale * d, 0.0, 1.0);\n}"}]},{name:"Complex",description:"Complex number arithmetic (vec2 = real + imaginary)",options:[{label:"Multiply / Divide",code:"vec2 cmul(vec2 a, vec2 b)\n{\n    return vec2(a.x * b.x - a.y * b.y,\n                a.x * b.y + a.y * b.x);\n}\n\nvec2 cdiv(vec2 a, vec2 b)\n{\n    float d = dot(b, b);\n    return vec2(dot(a, b), a.y * b.x - a.x * b.y) / d;\n}\n\nvec2 cconj(vec2 z)\n{\n    return vec2(z.x, -z.y);\n}"},{label:"Exp / Log / Power",code:"float cabs(vec2 z) { return length(z); }\nfloat carg(vec2 z) { return atan(z.y, z.x); }\n\nvec2 cexp(vec2 z)\n{\n    return exp(z.x) * vec2(cos(z.y), sin(z.y));\n}\n\nvec2 clog(vec2 z)\n{\n    return vec2(log(length(z)), atan(z.y, z.x));\n}\n\nvec2 cpow(vec2 z, float n)\n{\n    float r = length(z);\n    float theta = atan(z.y, z.x);\n    return pow(r, n) * vec2(cos(n * theta), sin(n * theta));\n}\n\nvec2 csqrt(vec2 z)\n{\n    float r = length(z);\n    float theta = atan(z.y, z.x);\n    return sqrt(r) * vec2(cos(theta * 0.5), sin(theta * 0.5));\n}"},{label:"Trigonometry",code:"vec2 csin(vec2 z)\n{\n    return vec2(sin(z.x) * cosh(z.y), cos(z.x) * sinh(z.y));\n}\n\nvec2 ccos(vec2 z)\n{\n    return vec2(cos(z.x) * cosh(z.y), -sin(z.x) * sinh(z.y));\n}"}]}]},{name:"SDF",icon:"Hexagon",snippets:[{name:"2D Shapes",description:"Signed distance functions for 2D primitives",author:"Inigo Quilez (iquilezles.org)",options:[{label:"Circle",code:"float sd_circle(vec2 p, float r)\n{\n    return length(p) - r;\n}"},{label:"Box",code:"float sd_box(vec2 p, vec2 b)\n{\n    vec2 d = abs(p) - b;\n    return length(max(d, 0.0)) + min(max(d.x, d.y), 0.0);\n}"},{label:"Rounded Box",code:"float sd_rounded_box(vec2 p, vec2 b, vec4 r)\n{\n    r.xy = (p.x > 0.0) ? r.xy : r.zw;\n    r.x  = (p.y > 0.0) ? r.x  : r.y;\n    vec2 q = abs(p) - b + r.x;\n    return min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - r.x;\n}"},{label:"Line Segment",code:"float sd_segment(vec2 p, vec2 a, vec2 b)\n{\n    vec2 pa = p - a, ba = b - a;\n    float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n    return length(pa - ba * h);\n}"},{label:"Triangle",code:"float sd_triangle(vec2 p, float r)\n{\n    const float k = sqrt(3.0);\n    p.x = abs(p.x) - r;\n    p.y = p.y + r / k;\n    if (p.x + k * p.y > 0.0) p = vec2(p.x - k * p.y, -k * p.x - p.y) / 2.0;\n    p.x -= clamp(p.x, -2.0 * r, 0.0);\n    return -length(p) * sign(p.y);\n}"},{label:"Ring",code:"float sd_ring(vec2 p, float r, float thickness)\n{\n    return abs(length(p) - r) - thickness;\n}"},{label:"Capsule",code:"float sd_capsule(vec2 p, vec2 a, vec2 b, float r)\n{\n    vec2 pa = p - a, ba = b - a;\n    float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n    return length(pa - ba * h) - r;\n}"},{label:"Vesica",code:"float sd_vesica(vec2 p, float w, float h)\n{\n    vec2 p2 = abs(p);\n    float d = 0.5 * (w * w - h * h) / h;\n    vec3 c = (w * p2.y < d * (p2.x - w))\n        ? vec3(0.0, w, 0.0)\n        : vec3(-d, 0.0, d + h);\n    return length(p2 - c.yx) - c.z;\n}"},{label:"Hexagon",code:"float sd_hexagon(vec2 p, float r)\n{\n    const vec3 k = vec3(-0.866025404, 0.5, 0.577350269);\n    p = abs(p);\n    p -= 2.0 * min(dot(k.xy, p), 0.0) * k.xy;\n    p -= vec2(clamp(p.x, -k.z * r, k.z * r), r);\n    return length(p) * sign(p.y);\n}"},{label:"Pentagon",code:"float sd_pentagon(vec2 p, float r)\n{\n    const vec3 k = vec3(0.809016994, 0.587785252, 0.726542528);\n    p.x = abs(p.x);\n    p -= 2.0 * min(dot(vec2(-k.x, k.y), p), 0.0) * vec2(-k.x, k.y);\n    p -= 2.0 * min(dot(vec2(k.x, k.y), p), 0.0) * vec2(k.x, k.y);\n    p -= vec2(clamp(p.x, -r * k.z, r * k.z), r);\n    return length(p) * sign(p.y);\n}"},{label:"Star",code:"float sd_pentagram(vec2 p, float r)\n{\n    const float k1 = 0.809016994;\n    const float k2 = 0.309016994;\n    const vec2 v1 = vec2(k1, -0.587785252);\n    const vec2 v2 = vec2(-k1, -0.587785252);\n    const vec2 v3 = vec2(k2, -0.951056516);\n    p.x = abs(p.x);\n    p -= 2.0 * max(dot(v1, p), 0.0) * v1;\n    p -= 2.0 * max(dot(v2, p), 0.0) * v2;\n    p.x = abs(p.x);\n    p.y -= r;\n    return length(p - v3 * clamp(dot(p, v3), 0.0, 0.726542528 * r)) * sign(p.y * v3.x - p.x * v3.y);\n}"},{label:"Arc",code:"float sd_arc(vec2 p, vec2 sc, float ra, float rb)\n{\n    p.x = abs(p.x);\n    return ((sc.y * p.x > sc.x * p.y)\n        ? length(p - sc * ra)\n        : abs(length(p) - ra)) - rb;\n}"},{label:"Ellipse",code:"float sd_ellipse(vec2 p, vec2 ab)\n{\n    p = abs(p);\n    if (p.x > p.y) { p = p.yx; ab = ab.yx; }\n    float l = ab.y * ab.y - ab.x * ab.x;\n    float m = ab.x * p.x / l;\n    float m2 = m * m;\n    float n = ab.y * p.y / l;\n    float n2 = n * n;\n    float c = (m2 + n2 - 1.0) / 3.0;\n    float c3 = c * c * c;\n    float q = c3 + m2 * n2 * 2.0;\n    float d = c3 + m2 * n2;\n    float g = m + m * n2;\n    float co;\n    if (d < 0.0) {\n        float h = acos(q / c3) / 3.0;\n        float s = cos(h), t = sin(h) * sqrt(3.0);\n        float rx = sqrt(-c * (s + t + 2.0) + m2);\n        float ry = sqrt(-c * (s - t + 2.0) + m2);\n        co = (ry + sign(l) * rx + abs(g) / (rx * ry) - m) * 0.5;\n    } else {\n        float h = 2.0 * m * n * sqrt(d);\n        float s = sign(q + h) * pow(abs(q + h), 1.0 / 3.0);\n        float u = sign(q - h) * pow(abs(q - h), 1.0 / 3.0);\n        float rx = -s - u - c * 4.0 + 2.0 * m2;\n        float ry = (s - u) * sqrt(3.0);\n        float rm = sqrt(rx * rx + ry * ry);\n        co = (ry / sqrt(rm - rx) + 2.0 * g / rm - m) * 0.5;\n    }\n    vec2 r = ab * vec2(co, sqrt(1.0 - co * co));\n    return length(r - p) * sign(p.y - r.y);\n}"}]},{name:"3D Shapes",description:"Signed distance functions for 3D primitives",author:"Inigo Quilez (iquilezles.org)",options:[{label:"Sphere",code:"float sd_sphere(vec3 p, float r)\n{\n    return length(p) - r;\n}"},{label:"Box",code:"float sd_box_3d(vec3 p, vec3 b)\n{\n    vec3 q = abs(p) - b;\n    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0);\n}"},{label:"Torus",code:"float sd_torus(vec3 p, vec2 t)\n{\n    vec2 q = vec2(length(p.xz) - t.x, p.y);\n    return length(q) - t.y;\n}"},{label:"Capsule",code:"float sd_capsule(vec3 p, vec3 a, vec3 b, float r)\n{\n    vec3 pa = p - a, ba = b - a;\n    float h = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);\n    return length(pa - ba * h) - r;\n}"},{label:"Cylinder",code:"float sd_capped_cylinder(vec3 p, float r, float h)\n{\n    vec2 d = abs(vec2(length(p.xz), p.y)) - vec2(r, h);\n    return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n}"},{label:"Cone",code:"float sd_cone(vec3 p, vec2 c, float h)\n{\n    vec2 q = h * vec2(c.x / c.y, -1.0);\n    vec2 w = vec2(length(p.xz), p.y);\n    vec2 a = w - q * clamp(dot(w, q) / dot(q, q), 0.0, 1.0);\n    vec2 b = w - q * vec2(clamp(w.x / q.x, 0.0, 1.0), 1.0);\n    float k = sign(q.y);\n    float d = min(dot(a, a), dot(b, b));\n    float s = max(k * (w.x * q.y - w.y * q.x), k * (w.y - q.y));\n    return sqrt(d) * sign(s);\n}"},{label:"Plane",code:"float sd_plane(vec3 p, vec3 n, float h)\n{\n    return dot(p, n) + h;\n}"},{label:"Round Cone",code:"float sd_round_cone(vec3 p, float r1, float r2, float h)\n{\n    float b = (r1 - r2) / h;\n    float a = sqrt(1.0 - b * b);\n    vec2 q = vec2(length(p.xz), p.y);\n    float k = dot(q, vec2(-b, a));\n    if (k < 0.0) return length(q) - r1;\n    if (k > a * h) return length(q - vec2(0.0, h)) - r2;\n    return dot(q, vec2(a, b)) - r1;\n}"},{label:"Hex Prism",code:"float sd_hex_prism(vec3 p, vec2 h)\n{\n    const vec3 k = vec3(-0.8660254, 0.5, 0.57735);\n    p = abs(p);\n    p.xy -= 2.0 * min(dot(k.xy, p.xy), 0.0) * k.xy;\n    vec2 d = vec2(\n        length(p.xy - vec2(clamp(p.x, -k.z * h.x, k.z * h.x), h.x)) * sign(p.y - h.x),\n        p.z - h.y\n    );\n    return min(max(d.x, d.y), 0.0) + length(max(d, 0.0));\n}"},{label:"Round Box",code:"float sd_round_box(vec3 p, vec3 b, float r)\n{\n    vec3 q = abs(p) - b + r;\n    return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - r;\n}"}]},{name:"Operations",description:"Combine SDFs: union, intersection, subtraction, and smooth variants",author:"Inigo Quilez (iquilezles.org)",options:[{label:"Union",code:"float op_union(float d1, float d2) { return min(d1, d2); }"},{label:"Intersect",code:"float op_intersect(float d1, float d2) { return max(d1, d2); }"},{label:"Subtract",code:"float op_subtract(float d1, float d2) { return max(-d1, d2); }"},{label:"Smooth Union",code:"float op_smooth_union(float d1, float d2, float k)\n{\n    float h = clamp(0.5 + 0.5 * (d2 - d1) / k, 0.0, 1.0);\n    return mix(d2, d1, h) - k * h * (1.0 - h);\n}"},{label:"Smooth Intersect",code:"float op_smooth_intersect(float d1, float d2, float k)\n{\n    float h = clamp(0.5 - 0.5 * (d2 - d1) / k, 0.0, 1.0);\n    return mix(d2, d1, h) + k * h * (1.0 - h);\n}"},{label:"Smooth Subtract",code:"float op_smooth_subtract(float d1, float d2, float k)\n{\n    float h = clamp(0.5 - 0.5 * (d2 + d1) / k, 0.0, 1.0);\n    return mix(d2, -d1, h) + k * h * (1.0 - h);\n}"}]},{name:"Ray Marching",description:"Sphere-tracing loop, normals, lighting, camera",options:[{label:"Ray March Loop",code:"#define MAX_STEPS 128\n#define MAX_DIST  100.0\n#define SURF_DIST 0.001\n\nfloat ray_march(vec3 ro, vec3 rd)\n{\n    float t = 0.0;\n    for (int i = 0; i < MAX_STEPS; i++)\n    {\n        vec3 p = ro + rd * t;\n        float d = scene(p);\n        if (d < SURF_DIST) break;\n        t += d;\n        if (t > MAX_DIST) break;\n    }\n    return t;\n}"},{label:"Normal",code:"#define EPSILON 0.0001\n\nvec3 get_normal(vec3 p)\n{\n    vec2 e = vec2(EPSILON, 0.0);\n    return normalize(vec3(\n        scene(p + e.xyy) - scene(p - e.xyy),\n        scene(p + e.yxy) - scene(p - e.yxy),\n        scene(p + e.yyx) - scene(p - e.yyx)\n    ));\n}"},{label:"Lighting",code:"vec3 lighting(vec3 p, vec3 normal, vec3 rd, vec3 light_dir, vec3 col)\n{\n    float diff = max(dot(normal, light_dir), 0.0);\n    vec3 half_dir = normalize(light_dir - rd);\n    float spec = pow(max(dot(normal, half_dir), 0.0), 32.0);\n    vec3 ambient = 0.05 * col;\n    return ambient + col * diff + vec3(1.0) * spec * 0.5;\n}"},{label:"Camera",code:"mat3 camera(vec3 eye, vec3 target, float roll)\n{\n    vec3 cw = normalize(target - eye);\n    vec3 cp = vec3(sin(roll), cos(roll), 0.0);\n    vec3 cu = normalize(cross(cw, cp));\n    vec3 cv = cross(cu, cw);\n    return mat3(cu, cv, cw);\n}"}]}]},{name:"Raytracing",icon:"Globe",snippets:[{name:"Ray Setup",description:"Camera ray generation for raytracing",options:[{label:"Perspective",code:"// ro: ray origin, rd: ray direction (normalized).\n// uv: fragCoord.xy / resolution.xy in [0,1].\n\nvec3 ray_dir(vec2 uv, vec3 ro, vec3 target, float fov)\n{\n    vec3 fwd = normalize(target - ro);\n    vec3 right = normalize(cross(vec3(0.0, 1.0, 0.0), fwd));\n    vec3 up = cross(fwd, right);\n    vec2 ndc = uv * 2.0 - 1.0;\n    float aspect = iResolution.x / iResolution.y;\n    return normalize(fwd + (right * ndc.x * aspect + up * ndc.y) * tan(fov * 0.5));\n}"},{label:"Orthographic",code:"// Orthographic: parallel rays. rd = normalize(target - ro) for all pixels.\n// Ray origin for pixel: ro + ortho_offset(uv, ro, target, scale).\n\nvec3 ortho_offset(vec2 uv, vec3 ro, vec3 target, float scale)\n{\n    vec3 fwd = normalize(target - ro);\n    vec3 right = normalize(cross(vec3(0.0, 1.0, 0.0), fwd));\n    vec3 up = cross(fwd, right);\n    vec2 ndc = uv * 2.0 - 1.0;\n    float aspect = iResolution.x / iResolution.y;\n    return (right * ndc.x * aspect + up * ndc.y) * scale;\n}"}]},{name:"Ray Shapes",description:"Ray-primitive intersections (analytic)",options:[{label:"Sphere",code:"// Returns (t, 1) if hit, (t_max, 0) if miss. t is distance along ray.\n\nvec2 ray_sphere(vec3 ro, vec3 rd, vec3 center, float radius)\n{\n    vec3 oc = ro - center;\n    float b = dot(oc, rd);\n    float c = dot(oc, oc) - radius * radius;\n    float d = b * b - c;\n    if (d < 0.0) return vec2(1e10, 0.0);\n    float t = -b - sqrt(d);\n    if (t < 0.0) t = -b + sqrt(d);\n    if (t < 0.0) return vec2(1e10, 0.0);\n    return vec2(t, 1.0);\n}\n\nvec3 sphere_normal(vec3 p, vec3 center) { return normalize(p - center); }"},{label:"Plane",code:"// Plane: dot(p, n) + d = 0. n is unit normal, d is offset from origin.\n\nvec2 ray_plane(vec3 ro, vec3 rd, vec3 n, float d)\n{\n    float denom = dot(rd, n);\n    if (abs(denom) < 1e-6) return vec2(1e10, 0.0);\n    float t = -(dot(ro, n) + d) / denom;\n    if (t < 0.0) return vec2(1e10, 0.0);\n    return vec2(t, 1.0);\n}"},{label:"Box (AABB)",code:"// Slab method. box_min, box_max = AABB bounds.\n\nvec2 ray_box(vec3 ro, vec3 rd, vec3 box_min, vec3 box_max)\n{\n    vec3 inv_rd = 1.0 / rd;\n    vec3 t0 = (box_min - ro) * inv_rd;\n    vec3 t1 = (box_max - ro) * inv_rd;\n    vec3 tmin = min(t0, t1);\n    vec3 tmax = max(t0, t1);\n    float t_near = max(max(tmin.x, tmin.y), tmin.z);\n    float t_far  = min(min(tmax.x, tmax.y), tmax.z);\n    if (t_near > t_far || t_far < 0.0) return vec2(1e10, 0.0);\n    float t = t_near < 0.0 ? t_far : t_near;\n    return vec2(t, 1.0);\n}"},{label:"Triangle",code:"// Möller–Trumbore. Returns (t, u, v) — t = hit distance, (u,v) barycentrics. Miss: t < 0.\n\nvec3 ray_triangle(vec3 ro, vec3 rd, vec3 v0, vec3 v1, vec3 v2)\n{\n    vec3 e1 = v1 - v0;\n    vec3 e2 = v2 - v0;\n    vec3 h = cross(rd, e2);\n    float a = dot(e1, h);\n    if (abs(a) < 1e-8) return vec3(-1.0, 0.0, 0.0);\n    float f = 1.0 / a;\n    vec3 s = ro - v0;\n    float u = f * dot(s, h);\n    if (u < 0.0 || u > 1.0) return vec3(-1.0, 0.0, 0.0);\n    vec3 q = cross(s, e1);\n    float v = f * dot(rd, q);\n    if (v < 0.0 || u + v > 1.0) return vec3(-1.0, 0.0, 0.0);\n    float t = f * dot(e2, q);\n    if (t < 1e-6) return vec3(-1.0, 0.0, 0.0);\n    return vec3(t, u, v);\n}\n\nvec3 triangle_normal(vec3 v0, vec3 v1, vec3 v2) { return normalize(cross(v1 - v0, v2 - v0)); }"}]}]}],y=[{name:"PI",value:"3.14159265359",detail:"π — ratio of circumference to diameter"},{name:"TAU",value:"6.28318530718",detail:"2π — full circle in radians"},{name:"HPI",value:"1.57079632679",detail:"π/2 — quarter turn"},{name:"SQRT_HALF",value:"0.70710678118",detail:"√(1/2)"},{name:"SQRT2",value:"1.41421356237",detail:"√2"},{name:"SQRT_THIRD",value:"0.57735026919",detail:"√(1/3)"},{name:"PHI",value:"1.61803398875",detail:"Golden ratio (φ)"},{name:"GOLDEN_ANGLE",value:"2.39996322972",detail:"Golden angle in radians ≈ 137.508°"},{name:"SQRT_3_4",value:"0.86602540378",detail:"√(3/4) — simplex height factor"},{name:"F2",value:"0.36602540378",detail:"2D simplex skew: (√3−1)/2"},{name:"G2",value:"0.21132486541",detail:"2D simplex unskew: (3−√3)/6"},{name:"F3",value:"0.33333333333",detail:"3D simplex skew: 1/3"},{name:"G3",value:"0.16666666667",detail:"3D simplex unskew: 1/6"},{name:"F4",value:"0.30901699437",detail:"4D simplex skew: (√5−1)/4"},{name:"G4",value:"0.13819660113",detail:"4D simplex unskew: (1−1/√5)/4"}],w=[{name:"sin",signature:"sin(x)",description:"Sine of angle in radians"},{name:"cos",signature:"cos(x)",description:"Cosine of angle in radians"},{name:"tan",signature:"tan(x)",description:"Tangent of angle in radians"},{name:"asin",signature:"asin(x)",description:"Arc sine, returns radians"},{name:"acos",signature:"acos(x)",description:"Arc cosine, returns radians"},{name:"atan",signature:"atan(y, x)",description:"Arc tangent of y/x"},{name:"radians",signature:"radians(degrees)",description:"Convert degrees to radians"},{name:"degrees",signature:"degrees(radians)",description:"Convert radians to degrees"},{name:"pow",signature:"pow(x, y)",description:"x raised to the power y"},{name:"exp",signature:"exp(x)",description:"e raised to the power x"},{name:"exp2",signature:"exp2(x)",description:"2 raised to the power x"},{name:"log",signature:"log(x)",description:"Natural logarithm"},{name:"log2",signature:"log2(x)",description:"Base-2 logarithm"},{name:"sqrt",signature:"sqrt(x)",description:"Square root"},{name:"inversesqrt",signature:"inversesqrt(x)",description:"1 / sqrt(x)"},{name:"abs",signature:"abs(x)",description:"Absolute value"},{name:"sign",signature:"sign(x)",description:"Returns -1, 0, or 1"},{name:"floor",signature:"floor(x)",description:"Round down to integer"},{name:"ceil",signature:"ceil(x)",description:"Round up to integer"},{name:"fract",signature:"fract(x)",description:"Fractional part (x - floor(x))"},{name:"mod",signature:"mod(x, y)",description:"Modulo (x - y * floor(x/y))"},{name:"min",signature:"min(x, y)",description:"Minimum of x and y"},{name:"max",signature:"max(x, y)",description:"Maximum of x and y"},{name:"clamp",signature:"clamp(x, min, max)",description:"Clamp x between min and max"},{name:"mix",signature:"mix(a, b, t)",description:"Linear interpolation: a*(1-t) + b*t"},{name:"step",signature:"step(edge, x)",description:"0.0 if x < edge, else 1.0"},{name:"smoothstep",signature:"smoothstep(a, b, x)",description:"Hermite interpolation between a and b"},{name:"length",signature:"length(v)",description:"Length of vector"},{name:"distance",signature:"distance(a, b)",description:"Distance between two points"},{name:"dot",signature:"dot(a, b)",description:"Dot product"},{name:"cross",signature:"cross(a, b)",description:"Cross product (vec3)"},{name:"normalize",signature:"normalize(v)",description:"Unit vector in same direction"},{name:"reflect",signature:"reflect(I, N)",description:"Reflection of incident vector"},{name:"refract",signature:"refract(I, N, eta)",description:"Refraction of incident vector"},{name:"faceforward",signature:"faceforward(N, I, Nref)",description:"Flip N if facing away from I"},{name:"texture",signature:"texture(sampler, uv)",description:"Sample a texture at UV coordinates"},{name:"dFdx",signature:"dFdx(p)",description:"Partial derivative in x"},{name:"dFdy",signature:"dFdy(p)",description:"Partial derivative in y"},{name:"fwidth",signature:"fwidth(p)",description:"abs(dFdx(p)) + abs(dFdy(p))"}];function _(e){const t=e.substring(0,10).split("-");return[t[2],t[1],t[0]].join("-")}function C(){const e=new Date,t=`${e.getDate()}`,n=`${e.getMonth()+1}`,a=`${e.getFullYear()}`;return`${"0".repeat(2-t.length)}${t}-${"0".repeat(2-n.length)}${n}-${a}`}const S=e=>e.substring(0,512).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" class="hub-link" rel="noopener noreferrer">$1</a>').replace(/\*\*(.*?)\*\*/g,"<b>$1</b>").replace(/(^|[^*])\*(?!\*)([^*]+)\*(?!\*)/g,"$1<i>$2</i>").replace(/~~(.*?)~~/g,"<u>$1</u>").replace(/\n/g,"<br>").trim(),E={};for(let e=0;e<26;e++)E["Key"+String.fromCharCode(65+e)]=65+e;for(let e=0;e<10;e++)E["Digit"+e]=48+e;for(let e=0;e<10;e++)E["Numpad"+e]=48+e;for(let e=1;e<=12;e++)E["F"+e]=111+e;function T(e){return E[e]}function k(e,t,n){LX.toast(e,t,{position:"top-right",timeout:n})}function L(){document.querySelectorAll(".lextoast").forEach(e=>e.close())}Object.assign(E,{Space:32,Enter:13,Tab:9,Backspace:8,Escape:27,Minus:45,Equal:61,BracketLeft:91,BracketRight:93,Backslash:92,Semicolon:59,Quote:39,Backquote:96,Comma:44,Period:46,Slash:47}),Object.assign(E,{ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,Insert:45,Delete:46,Home:36,End:35,PageUp:33,PageDown:34});const P="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";function D(e){let t=BigInt("0x"+e),n="";for(;t>0;)n=P[t%62n]+n,t/=62n;return n}function R(e=""){let t=window.location.pathname.split(`/${e}/`)[1];if(!t||""===t){t=new URLSearchParams(document.location.search).get(e)}if(t)return function(e){let t=0n;for(const n of e)t=62n*t+BigInt(P.indexOf(n));return t.toString(16).padStart(20,"0")}(t);console.warn(`No ${e} UID specified`)}const I=Appwrite.Query,U=navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i),B={autoCompile:!1,captureInProgress:!1,pageExploreLimit:24,_dbAssetsCache:new Map,async init(t){if(this.fs=t,this.area=await e.init(),this.currentView=null,t.user){const n=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",t.getUserId())]);this.dbUser=n.documents[0];const a=this.dbUser.app_mode;a&&"Auto"!==a&&e.setMode(a.toLowerCase())}e.setThemeColor("orange");const n=new URLSearchParams(document.location.search),a=e.getMode(),o=[];U||o.push({name:"New",callback:(e,t,n)=>this._openShader("new",n)},{name:"Explore",callback:(e,t,n)=>this._openPage(`${e.toLowerCase()}/`,n)},{name:"Docs",callback:(e,t,n)=>this._openPage(`${e.toLowerCase()}/`,n)});const s=this.area.addMenubar(o,{parentClass:"bg-none"});e.addClass(s.root,"[&_.lexmenuentry]:hidden! [&_.lexmenuentry]:md:flex!");const i=n.get("search"),r=new e.TextInput(null,i??"",e=>{e.length&&this._searchShader(e)},{placeholder:"Search...",className:"mx-auto flex-auto-fill max-w-[40%] md:max-w-[25%] 2xl:max-w-[20%]"});s.root.appendChild(r.root);{const t=s.root.querySelector("#Docs span");t&&(e.addClass(t,"flex flex-row gap-2"),t.appendChild(e.badge("new","xs primary",{asElement:!0})))}{const n={headerTitle:t.user?t.user.name:"Guest",headerSubtitle:t.user?t.user.email:void 0,headerImage:this.dbUser?.avatar??`${$.imagesRootPath}/favicon.png`,skipFooter:!0,collapsed:!1,collapsable:!1,displaySelected:!0},a=e=>{t.user?e.add("Profile",{icon:"User",callback:()=>this._openUserProfile(t.getUserId())}):(e.add("Login",{icon:"LogIn",callback:()=>this.openLoginDialog()}),e.add("Create account",{icon:"UserPlus",callback:()=>this.openSignUpDialog()})),e.add("Explore",{icon:"Search",callback:e=>this._openPage(`${e.toLowerCase()}/`)}),e.add("Docs",{icon:"BookOpen",callback:e=>this._openPage(`${e.toLowerCase()}/`)}),t.user&&e.add("Logout",{icon:"LogOut",callback:async()=>{await this.onLogout()}})},o=new e.Area({skipAppend:!0});o.addSidebar(a,n),s.setButtonIcon("Menu","Menu",()=>window.__currentSheet=new e.Sheet("256px",[o],{side:"right"}));const i=s.buttons.Menu.root;e.addClass(i,"md:hidden")}if(!U){const n=e.makeContainer(["auto","auto"],"hidden md:flex flex-row p-1 gap-1 self-center items-center ml-auto","",s.root),a=e.makeContainer(["auto","auto"],"flex flex-row p-1 gap-1 self-center items-center","",n);a.id="signupContainer",a.classList.toggle("hidden",!!t.user);const o=new e.Button(null,"Create account",()=>this.openSignUpDialog(),{buttonClass:"ghost h-8 px-4"});a.appendChild(o.root),e.makeContainer(["auto","0.85rem"],"border-right border-color text-foreground self-center items-center","",a),this.getLoginHtml=async t=>{if(!t)return this._setLoginButtonClass("primary"),"Login";if(!this.dbUser)return this._setLoginButtonClass("primary"),"Login";const n=new e.Avatar({imgSource:this.dbUser.avatar,fallback:this.dbUser.user_name[0].toUpperCase(),className:"mx-2 size-5"});return this._setLoginButtonClass("ghost"),`<span class="hidden md:block decoration-none">${t.email}</span>\n                    ${n.root.outerHTML}\n                    ${e.makeIcon("ChevronsUpDown",{iconClass:"pl-2"}).innerHTML}`};const i=new e.Button(null,"",async()=>{t.user?new e.DropdownMenu(i.root,[t.user.name,null,{name:"Profile",icon:"User",callback:()=>this._openUserProfile(t.getUserId())},null,{name:"Logout",icon:"LogOut",className:"destructive",callback:async()=>{await this.onLogout()}}],{side:"bottom",align:"end",alignOffset:-12}):this.openLoginDialog()},{className:"mx-2 flex-auto-keep",buttonClass:"ghost h-8 px-4"});i.root.id="loginOptionsButton";const r=i.root.querySelector("button");e.doAsync(async()=>{r.innerHTML=await this.getLoginHtml(t.user)},10),n.appendChild(i.root)}s.setButtonImage("ShaderHub",U?`${$.imagesRootPath}/favicon.png`:`${$.imagesRootPath}/icon_${a}.png`,(e,t)=>{this._openPage("",t)},{float:"left"}),e.addSignal("@on_new_color_scheme",(e,t)=>{U||s.setButtonImage("ShaderHub",`${$.imagesRootPath}/icon_${t}.png`,null,{float:"left"})});{this.area=s.siblingArea,e.addClass(this.area.root,"content-area");const t=e.makeContainer(["auto","auto"],"flex-row p-1 gap-1 self-center items-center cursor-pointer",e.badge(`v${$.version}`,"outline border-primary"));e.insertChildAtIndex(s.root,t,1),t.addEventListener("click",()=>this._openPage("docs?p=changelog"))}window.addEventListener("popstate",this.router.bind(this)),this.router();const l="true"===n.get("verifyEmail"),d=n.get("secret"),u=n.get("userId");if(l){await t.account.updateEmailVerification({userId:u,secret:d})&&k("✅ Email verified successfully!",`User: ${t.user.name}`)}else d&&u&&this.openUpdatePasswordRecoverDialog(u,d)},async router(){window.__currentSheet&&window.__currentSheet.destroy();const e=window.location.pathname,t=e=>e.startsWith("/view")||e.startsWith("/create"),n=t(e),a=t("/"+this.currentView);if(this.currentView&&(n||a))window.location.href=window.location.origin+e;else if(e.startsWith("/explore"))this.renderExploreView();else if(e.startsWith("/create"))this.renderShaderView("new");else if(e.startsWith("/view")){const e=R("view");if(!e)return;await this.renderShaderView(e)}else if(e.startsWith("/user")){const e=R("user");if(!e)return;await this.renderUserView(e)}else await this.renderHomePage()},_setLoginButtonClass(t){const n=document.querySelector("#loginOptionsButton button");n&&(e.removeClass(n,"primary ghost"),e.addClass(n,t))},_searchShader(e){const t=new URL(`${$.getFullPath(!1)}/explore/`);e&&e.trim()?t.searchParams.set("search",e.trim()):t.searchParams.delete("search"),window.location.href=t.toString()},_openPage(e="",t){const n=e.startsWith("docs"),a=`${$.getFullPath(!1)}/${e}`;if(1===t?.button||t?.ctrlKey||t?.metaKey)return t.preventDefault(),void window.open(a,"_blank");n?window.location.href=a:(history.pushState({},"",a),this.router())},_openShader(e,t){const n="new"===e?"/create/":`/view/${D(e)}`,a=`${$.getFullPath(!1)}${n}`;1===t?.button||t?.ctrlKey||t?.metaKey?window.open(a,"_blank"):(history.pushState({},"",a),this.router())},_openUserProfile(e,t){const n=`${$.getFullPath(!1)}/user/${D(e)}`;if(1===t?.button||t?.ctrlKey||t?.metaKey)return t.preventDefault(),void window.open(n,"_blank");history.pushState({},"",n),this.router()},_explorePage(e){const t=new URL(`${$.getFullPath(!1)}/explore/`);e&&e.trim()?t.searchParams.set("page",e.trim()):t.searchParams.delete("page"),history.pushState({},"",t),this.router()},_exploreFeature(e){const t=new URL(window.location.href),n=new URL(`${$.getFullPath(!1)}/explore/`);n.search=t.search;const a=n.searchParams.get("feature")===e,o="all"===e;e&&e.trim()&&!a&&!o?n.searchParams.set("feature",e.trim()):n.searchParams.delete("feature"),n.searchParams.delete("page"),history.pushState({},"",n),this.router()},_exploreOrderBy(e,t){const n=new URL(window.location.href),a=new URL(`${$.getFullPath(!1)}/${t??"explore"}/`);a.search=n.search;const o=a.searchParams.get("order_by")===e;e&&e.trim()&&!o?a.searchParams.set("order_by",e.trim()):a.searchParams.delete("order_by"),a.searchParams.delete("page"),history.pushState({},"",a),this.router()},_makeFooter(t){e.makeContainer(["auto","auto"],"text-foreground text-sm flex flex-row gap-2 self-center items-center text-center place-content-center",`\n            ${e.makeIcon("Github@solid",{svgClass:"lg"}).innerHTML}<a class="text-primary decoration-none hover:underline underline-offset-4" href="https://github.com/upf-gti/ShaderHub">Code on Github</a>`,t)},_clearContent(){this._previewCleanups&&(this._previewCleanups.forEach(e=>e()),this._previewCleanups=[]),this.area.root.innerHTML="",delete this.area.type,this.area.sections=[]},_generateShaderItemSkeleton(t,n){let a="";for(let o=0;o<t;++o){const t=e.makeElement("li",`shader-item ${n&&0===o?"featured":""} lexskeletonpart relative hub-background-blur hover:bg-accent/50 overflow-hidden flex flex-col h-auto`);e.makeElement("img","size-full opacity-0 rounded-t-lg border-none cursor-pointer self-center","",t).src=$.shaderPreviewPath,e.makeContainer(["100%","auto"],"hub-background-blur flex flex-row rounded-b-lg gap-6 p-4 select-none",'\n                <div class="w-full flex flex-row gap-1">\n                    <div class="w-3/4 h-3 lexskeletonpart"></div>\n                    <div class="w-1/2 h-3 lexskeletonpart"></div>\n                </div>',t),a+=t.outerHTML}return a},async renderHomePage(){this._clearContent(),this.currentView="home";var[t,n]=this.area.split({type:"vertical",sizes:["calc(100% - 48px)","48px"],resize:!1});this.area.root.className+=" hub-background",n.root.className+=" items-center content-center",t.root.className+=" flex flex-row hub-background content-area",this._makeFooter(n);let a=e.makeContainer(["auto","100%"],"bg-none flex flex-col p-8 gap-2 overflow-scroll","",t);a.style.minWidth="50%";let o=e.makeContainer(["100%","100%"],"bg-none flex flex-col p-8 place-content-center items-center","",t);{const t=e.makeContainer(["100%","100%"],"hub-background-blur flex flex-col gap-4 rounded-xl py-12 box-shadow box-border justify-evenly overflow-scroll items-center","",o);if(this.fs.user){const n=(await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",this.fs.getUserId())])).documents[0];e.makeContainer(["100%","15%"],"px-8 text-center text-3xl text-card-foreground content-center",`Welcome ${n.display_name??n.user_name}!`,t).id="welcomeMessage"}const n=e.makeContainer([null,"auto"],"flex flex-col px-8 md:px-12 gap-12 text-center items-center place-content-center",`\n                <img src="${$.imagesRootPath}/favicon.png" class="">\n                <span class="text-muted-foreground text-3xl sm:text-4xl font-medium">ShaderHub</span>\n                <span class="text-balanced text-4xl sm:text-5xl font-medium">Create and share shaders using latest WebGPU!</span>\n                <a onclick='ui._openShader("new")' class="flex flex-row gap-1 items-center text-sm p-1 px-4 rounded-full text-secondary-foreground decoration-none hover:bg-secondary cursor-pointer"><span class="flex flex-auto-keep bg-orange-500 w-2 h-2 rounded-full"></span>\n                <span class="flex flex-auto-fill">New WebGL Renderer, New Sound Channel, and New Docs</span>${e.makeIcon("ArrowRight",{svgClass:"flex flex-auto-keep sm"}).innerHTML}</a>\n            `,t);if(!U){const t=e.makeContainer(["auto","auto"],"flex flex-row p-2","",n),a=new e.Button(null,"Create a Shader",()=>this._openShader("new"),{icon:"ChevronRight",iconPosition:"end",buttonClass:"lg primary"});t.appendChild(a.root)}if(!this.fs.user){const n=e.makeContainer(["100%","auto"],"max-w-128 flex flex-col gap-2 p-6 text-center text-card-foreground","Sign in to save your shaders:",t),a={email:{label:"Email",value:"",icon:"AtSign"},password:{label:"Password",icon:"Key",value:"",type:"password"}},o=new e.Form(null,a,async(e,t)=>{await this.fs.login(e.email,e.password,async(e,t)=>{await this.onLogin(e)},e=>{k("❌ Error",e,-1)})},{primaryActionName:"Login"});n.appendChild(o.root);const s=new e.Button(null,"Forgot my password",async()=>{this.openRecoverPasswordDialog()},{buttonClass:"link"});n.appendChild(s.root)}}e.makeContainer(["100%","auto"],"font-medium text-card-foreground","Featured Shaders",a,{fontSize:"2rem"});const s=this._generateShaderItemSkeleton(3,!0),i=new e.Skeleton(s);i.root.classList.add("grid","shader-list-initial","gap-8","justify-center"),a.appendChild(i.root);const r=await this.fs.listDocuments(c.SHADERS_COLLECTION_ID,[I.or([I.equal("public",!0),I.isNull("public")]),I.orderDesc("like_count"),I.limit(3)]),l=await this.fs.listFiles([I.startsWith("name",$.previewNamePrefix),I.endsWith("name",".png"),I.contains("name",r.documents.map(e=>e.$id))]),d=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.contains("user_id",r.documents.map(e=>e.author_id))]);e.doAsync(async()=>{let t=[];for(const e of r.documents){const n=e.name,a=e.$id,o={name:n,uid:a,fileId:e.file_id,backend:e.backend,creationDate:_(e.$createdAt),likeCount:e.like_count??0,viewCount:e.view_count??0,liked:!!this.dbUser&&(this.dbUser.liked_shaders??[]).includes(a)},s=e.author_id;if(s){const e=d.documents.find(e=>e.user_id===s).user_name;o.author=e,o.authorId=s}else o.author=e.author_name,o.anonAuthor=!0;const i=$.getShaderPreviewName(o.uid),r=l.files.find(e=>e.name===i);r?o.preview=await this.fs.getFileUrl(r.$id):console.warn(`Can't find shader preview image for Shader: ${o.name}`),t.push(o)}i.root.querySelectorAll(".lexskeletonpart").forEach(e=>e.classList.remove("lexskeletonpart"));for(let n=0;n<t.length;++n){const a=t[n],o=i.root.children[n],s=o.querySelector("img");s.src=a.preview??$.shaderPreviewPath,s.onload=()=>s.classList.remove("opacity-0"),o.querySelector("div").remove(),e.makeContainer(["100%","auto"],"flex flex-row rounded-b-lg gap-6 px-4 py-3 items-center select-none",`\n                    <div class="flex flex-row w-full items-center gap-2">\n                        <span class="text-base font-medium text-nowrap truncate">${a.name}</span>\n                        <span class="text-base font-light text-muted-foreground flex-auto-keep">by ${a.anonAuthor?"":`<a onclick='ui._openUserProfile("${a.authorId}")' class='hub-link font-medium'>`}<span>${a.author}</span>${a.anonAuthor?"":"</a>"}</span>\n                        <div class="flex flex-row gap-2 items-center ml-auto flex-auto-keep text-sm">\n                            <div class="flex flex-row gap-1 items-center">\n                                ${e.makeIcon("Heart",{svgClass:(a.liked?"text-orange-600 shadow-primary":"text-muted-foreground")+" fill-current"}).innerHTML}\n                                <span class="text-muted-foreground">${a.likeCount??0}</span>\n                            </div>\n                            <div class="flex flex-row gap-1 items-center">\n                                ${e.makeIcon("Eye",{svgClass:"text-muted-foreground fill-current"}).innerHTML}\n                                <span class="text-muted-foreground">${a.viewCount??0}</span>\n                            </div>\n                        </div>\n                    </div>`,o),s.addEventListener("mousedown",e=>e.preventDefault()),s.addEventListener("mouseup",e=>{this._openShader(a.uid,e)});let r=null;if(s.addEventListener("mouseenter",e=>{r&&($.raf=r.frame.bind(r),$.rafId=requestAnimationFrame($.raf))}),s.addEventListener("mouseleave",e=>{r&&$.rafId&&(r.clean(),cancelAnimationFrame($.rafId))}),a.fileId){const t=e.makeElement("div","size-full relative");o.prepend(t);const n=e.makeElement("canvas","absolute inset-0 size-full opacity-0 transition-opacity duration-700 pointer-events-none");t.appendChild(s),t.appendChild(n),r=await $.startShaderPreview(n,a.fileId,a.backend),n.classList.remove("opacity-0")}}0===t.length&&(i.root.innerHTML="",e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","No shaders found.",i.root))},10)},async renderExploreView(){this._clearContent(),this.currentView="explore";const t=new URLSearchParams(document.location.search),s=t.get("feature"),i=t.get("order_by"),r=t.get("page"),l=t.get("search");var[d,u]=this.area.split({type:"vertical",sizes:["calc(100% - 48px)",null],resize:!1});d.root.parentElement.classList.add("hub-background"),d.root.className+=" p-6 overflow-scroll bg-transparent max-w-[1600px] ml-auto mr-auto",u.root.className+=" items-center content-center",e.makeContainer(["100%","auto"],"font-medium text-card-foreground text-4xl text-center mb-2","Explore Shaders",d);const p=e.makeContainer(["100%","auto"],`flex flex-col ${U?"mb-2":"md:flex-row"} font-medium text-card-foreground`,"",d),m=U?"p-1":"p-4";this._makeFooter(u);{const t=new e.Panel({className:`${m} bg-none flex-auto-fill`,height:"auto"});t.sameLine(),t.addLabel("Features",{fit:!0}),t.addSelect(null,n,s?e.toTitleCase(s):"All",e=>{this._exploreFeature(e.toLowerCase())}),t.endLine(),p.appendChild(t.root)}{const t=new e.Panel({className:`${m} bg-none flex-auto-fill`,height:"auto"});t.sameLine(),t.addLabel("Order by",{fit:!0});const n=i??"recent";for(let e of a){const a=e.toLowerCase();t.addButton(null,e,e=>this._exploreOrderBy(e.toLowerCase()),{buttonClass:"xs "+(n===a?"primary":"outline bg-card!")})}t.endLine(),p.appendChild(t.root)}const h=new e.TextInput(null,"0 shaders",null,{disabled:!0,className:`${m} flex-auto-keep`,inputClass:"bg-none"});p.appendChild(h.root);const f=r?parseInt(r):1,g=i?o[i]:o.recent;console.log("Order by:",g);const v=[I.or([I.equal("public",!0),I.isNull("public")]),"asc"===g.direction?I.orderAsc(g.field):I.orderDesc(g.field),I.offset((f-1)*this.pageExploreLimit),I.limit(this.pageExploreLimit)];if(l)if("#"===l[0]){const e=l.substring(1);v.push(I.contains("tags",e))}else v.push(I.or([I.contains("name",l),I.contains("description",l),I.contains("author_name",l)]));s&&v.push(I.contains("features",s));const x=await this.fs.listDocuments(c.SHADERS_COLLECTION_ID,v),b=Math.ceil(x.total/this.pageExploreLimit);h.set(`${x.total} shaders`),this.paginator=new e.Pagination({page:f,pages:b,maxButtons:4,useEllipsis:!0,alwaysShowEdges:!1,allowChangeItemsPerPage:!0,className:"flex-auto-keep "+(U?"p-4":""),itemsPerPage:this.pageExploreLimit,onChange:e=>{this._explorePage(e.toString())},onItemsPerPageChange:e=>{this.pageExploreLimit=e,this._explorePage()}}),p.appendChild(this.paginator.root),this.paginator.setPages(b);const A=$.filterShaders(x.documents,l);if(0===A.length)return void e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","No shaders found.",d);const y=this._generateShaderItemSkeleton(A.length),w=new e.Skeleton(y);e.addClass(w.root,"grid shader-list gap-6 justify-center p-2"),d.attach(w.root);const C=await this.fs.listFiles([I.startsWith("name",$.previewNamePrefix),I.endsWith("name",".png"),I.contains("name",A.map(e=>e.$id)),I.limit(this.pageExploreLimit)]),S=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_name",A.map(e=>e.author_name))]);e.doAsync(async()=>{let t=[];for(const e of A){const n=e.name,a=e.$id,o={name:n,uid:a,creationDate:_(e.$createdAt),likeCount:e.like_count,viewCount:e.view_count,features:(e.features??"").split(","),public:e.public??!0,liked:!!this.dbUser&&(this.dbUser.liked_shaders??[]).includes(a),backend:e.backend??"webgpu"},s=e.author_id;if(s){const e=S.documents.find(e=>e.user_id===s).user_name;o.author=e,o.authorId=s}else o.author=e.author_name,o.anonAuthor=!0;const i=$.getShaderPreviewName(o.uid),r=C.files.find(e=>e.name===i);r?o.preview=await this.fs.getFileUrl(r.$id):console.warn(`Can't find shader preview image for Shader: ${o.name}`),t.push(o)}w.root.querySelectorAll(".lexskeletonpart").forEach(e=>e.classList.remove("lexskeletonpart"));for(let n=0;n<t.length;++n){const a=t[n],o=w.root.children[n],s=o.querySelector("img");s.src=a.preview??$.shaderPreviewPath,s.onload=()=>s.classList.remove("opacity-0"),o.querySelector("div").remove(),"webgl"===a.backend&&e.makeElement("span","absolute m-4 bg-background-blur border-color text-xs px-2 py-1 rounded-xl select-none pointer-events-none","WebGL",o),e.makeContainer(["100%","auto"],"flex flex-row rounded-b-lg gap-6 px-4 py-3 items-center select-none",`\n                    <div class="flex flex-row w-full items-center gap-2">\n                        <span class="text-sm font-medium text-nowrap truncate">${a.name}</span>\n                        <span class="text-sm font-light text-muted-foreground flex-auto-keep">by ${a.anonAuthor?"":`<a onclick='ui._openUserProfile("${a.authorId}")' class='hub-link font-medium'>`}<span>${a.author}</span>${a.anonAuthor?"":"</a>"}</span>\n                        <div class="flex flex-row gap-2 items-center ml-auto flex-auto-keep">\n                            <div class="flex flex-row gap-1 items-center">\n                                ${e.makeIcon("Heart",{svgClass:`shader-like-button ${a.liked?"text-orange-600 shadow-primary":"text-muted-foreground"} fill-current sm hover:text-orange-600 hover:shadow-primary cursor-pointer`}).innerHTML}\n                                <span class="text-xs text-muted-foreground">${a.likeCount??0}</span>\n                            </div>\n                            <div class="flex flex-row gap-1 items-center">\n                                ${e.makeIcon("Eye",{svgClass:"text-muted-foreground fill-current sm"}).innerHTML}\n                                <span class="text-xs text-muted-foreground">${a.viewCount??0}</span>\n                            </div>\n                        </div>\n                    </div>`,o);const i=o.querySelector("svg.shader-like-button"),r=this.fs.user&&a.authorId===this.fs.getUserId();i.addEventListener("click",async t=>{if(t.preventDefault(),this.fs.user){if(!r){const[t,n,o]=await $.onShaderLike(a.uid);i.nextElementSibling.innerHTML=t,e.toggleClass(i,"text-orange-600",n),e.toggleClass(i,"shadow-primary",n)}}else{this._lastOpenedDialog&&this._lastOpenedDialog.close();const t=new e.Dialog(null,n=>{n.root.className=e.mergeClass(n.root.className,"pad-2xl flex flex-col gap-2"),e.makeContainer(["100%","100%"],"text-lg font-medium text-foreground p-2","Login to like this shader.",n),n.addButton(null,"Close",()=>{t.destroy()},{buttonClass:"h-8 ghost"})},{modal:!0});this._lastOpenedDialog=t}}),s.addEventListener("mousedown",e=>e.preventDefault()),s.addEventListener("mouseup",e=>{this._openShader(a.uid,e)})}this.shaderList=t},10)},async renderShaderView(t){this._clearContent(),this.currentView="new"===t?"create":"view",this.area.root.style.height="calc(100dvh - 48px)";const n=await $.getShaderById(t);if(!n)return;n.backend&&"webgpu"!==n.backend&&(e.doAsync(()=>k("Warning","⚠️ GLSL Shader. Fallback to WebGL mode.",-1),50),$.backend=n.backend),this.shader=n;let[a,o]=this.area.split({sizes:["50%","50%"]});o.root.className=o.root.className.replace("bg-background","bg-none p-3 shader-edit-content flex flex-col gap-2"),a.root.className=a.root.className.replace("bg-background","bg-none p-3 flex flex-col gap-2"),this.area.root.parentElement.className=this.area.root.parentElement.className.replace("bg-background","hub-background"),a.root.parentElement.classList.add("hub-background");let s=new e.Area({className:"box-shadow rounded-xl overflow-hidden code-border-default flex-auto-fill h-full",skipAppend:!0}),r=new e.Area({height:"auto",className:"max-h-105 flex flex-col box-shadow rounded-xl overflow-hidden pt-2 bg-card content-center flex-auto-keep",skipAppend:!0});o.attach(s),o.attach(r),this._shaderSettingsArea=r;const l=r.addTabs({parentClass:"p-2 bg-card",contentClass:"bg-card",fit:!0});this.channelsContainer=e.makeContainer(["100%","100%"],"channel-list grid p-2 gap-2 items-center justify-center"),l.add("Channels",this.channelsContainer);const c=e.makeContainer(["100%","100%"],"gap-2 items-center justify-center");l.add("Uniforms",c),this.uniformsContainerPanel=new e.Panel({className:"overflow-scroll"}),this.uniformsContainerPanel.root.classList.remove("scrollbar-hidden"),c.appendChild(this.uniformsContainerPanel.root);const d=e.makeContainer(["100%","100%"],"gap-2 items-center justify-center");l.add("Library",d),this.libraryContainerPanel=new e.Panel({className:"flex flex-col gap-1"}),d.appendChild(this.libraryContainerPanel.root),this.renderShaderLibraryView();const u=e.makeContainer(["100%","100%"],"gap-2 items-center justify-center");if(l.add("Log",u),this.compileLogContainerPanel=new e.Panel({className:"flex flex-col"}),u.appendChild(this.compileLogContainerPanel.root),this.compileLogContainerPanel.refresh=()=>{this.compileLogContainerPanel.clear(),this.compileLogContainerPanel.sameLine(),this.compileLogContainerPanel.addLabel("Shader compile errors and warnings will appear here.",{className:"w-full flex-auto-fill"}),this.compileLogContainerPanel.addButton(null,"Clear Log",()=>{this.compileLogContainerPanel.refresh()},{icon:"Trash2",className:"flex-auto-keep ml-auto self-center",buttonClass:"outline",title:"Clear Log",tooltip:!0}),this.compileLogContainerPanel.endLine()},this.compileLogContainerPanel.refresh(),document.title=`${n.name} (${n.author}) - ShaderHub`,window.ResizeObserver){new ResizeObserver(function(e,t){let n=e[0].contentRect;s.root.style.height=`calc(100% - ${n.height}px)`}).observe(r.root)}const p=async()=>{0!==await $.compileShader(!0,null,!1,!0)||window.onbeforeunload||(window.onbeforeunload=e=>{e.preventDefault(),e.returnValue=""})};if(U)return this.editor=new e.CodeEditor(s),void this.onCodeEditorReady(void 0,a);this.editor=await new e.CodeEditor(s,{allowClosingTabs:!1,allowLoadingFiles:!1,fileExplorer:!1,defaultTab:!1,statusShowEditorIndentation:!1,statusShowEditorLanguage:!1,statusShowEditorFilename:!1,customSuggestions:$.getCurrentSuggestions(),onCreateStatusPanel:this.makeStatusBarButtons.bind(this),onSave:p.bind(this),onRun:p.bind(this),onCreateFile:e=>null,onHoverSymbol:this.onSymbolHovered.bind(this),onContextMenu:(e,t,n)=>{const a=$.currentPass;if("Common"===a.name||!t)return;const o=t.trim().match(/([A-Za-z0-9_]+)/g)[0];if(!o)return;const s=[],r=[...i,...a.uniforms.map(e=>e.name)],l=new RegExp("\\b(?!("+r.join("|")+")\\b)(i[A-Z]\\w*)\\b");return s.push({path:"Create Uniform",disabled:!l.test(o),callback:async()=>{await $.addUniform(o),await $.compileShader(!0,a),this.renderUniformsView(a)}}),s},onNewTab:t=>{const a=0===n.passes.filter(e=>"common"===e.type).length,o=n.passes.filter(e=>"buffer"===e.type||"compute"===e.type).length<4,s=[{name:"Common",icon:"FileText",disabled:!a,callback:e=>$.onShaderPassCreated("common",e)},{name:"Buffer",icon:"Image",disabled:!o,callback:e=>$.onShaderPassCreated("buffer",e)},"webgpu"===$.backend&&{name:"Compute",icon:"Binary",disabled:!o,callback:e=>$.onShaderPassCreated("compute",e)}].filter(Boolean);new e.DropdownMenu(t.target,s,{side:"bottom",align:"start"})},onCodeChange:e=>{this.autoCompile&&p()},onSelectTab:async(e,t)=>{$.onShaderPassSelected(e)},onReady:async e=>{e.root.querySelector(".lexcodearea").firstChild.style.maxHeight="calc(100% - 97px)",await this.onCodeEditorReady(e,a)}})},renderUniformsView(t){const n=this.uniformsContainerPanel;if(n&&(t=t??$.currentPass)&&"common"!==t.type){n.clear(),n.sameLine(),n.addLabel("Uniform names must start with i + Capital letter (e.g. iTime).",{className:"w-full flex-auto-fill"}),n.addButton(null,"AddNewCustomUniform",()=>{$.addUniform()},{icon:"Plus",className:"flex-auto-keep ml-auto self-center",buttonClass:"bg-none",title:"Add New Uniform",tooltip:!0,width:"38px"}),n.endLine();for(let a=0;a<t.uniforms.length;++a){0!==a&&n.addSeparator();const o=t.uniforms[a],s=o.min,r=o.max,l=o.step,c=6,d=["f32","i32","u32"].includes(o.type);n.sameLine();const u=n.addButton(null,"UniformOptionsButton",n=>{const o=e=>{$.updateUniformType(t,a,e)};e.addDropdownMenu(u.root,[{name:"Float",submenu:[{name:"f32",icon:"Cuboid",callback:o.bind(this)},{name:"vec2f",icon:"Cuboid",callback:o.bind(this)},{name:"vec3f",icon:"Cuboid",callback:o.bind(this)},{name:"vec4f",icon:"Cuboid",callback:o.bind(this)}]},{name:"Int",submenu:[{name:"i32",icon:"Cuboid",callback:o.bind(this)},{name:"vec2i",icon:"Cuboid",callback:o.bind(this)},{name:"vec3i",icon:"Cuboid",callback:o.bind(this)},{name:"vec4i",icon:"Cuboid",callback:o.bind(this)}]},{name:"UnsignedInt",submenu:[{name:"u32",icon:"Cuboid",callback:o.bind(this)},{name:"vec2u",icon:"Cuboid",callback:o.bind(this)},{name:"vec3u",icon:"Cuboid",callback:o.bind(this)},{name:"vec4u",icon:"Cuboid",callback:o.bind(this)}]},{name:"Color",submenu:[{name:"color3",icon:"Pipette",callback:o.bind(this)},{name:"color4",icon:"Pipette",callback:o.bind(this)}]},null,{name:"Delete",icon:"Trash2",className:"destructive",callback:()=>{$.removeUniform(t,a)}}],{side:"top",align:"start"}).root.skipFocus=!0},{className:"flex-auto-keep",icon:"Menu",buttonClass:"bg-none"});if(n.addText(null,o.name,e=>{o.name=e,$.compileShader(!0,t)},{className:"flex-auto-keep",inputClass:"w-auto! field-sizing-content",skipReset:!0,pattern:"\\b(?!("+i.join("|")+")\\b)(i[A-Z]\\w*)\\b"}),d){const e=[];e.push(n.addNumber("Min",o.min,n=>{o.min=n,e.forEach(e=>e.setLimits(o.min,o.max,o.step)),t.uniformsDirty=!0},{className:"flex-auto-keep",width:"20%",nameWidth:"35%",skipReset:!0,max:r,step:l,precision:c})),e.push(n.addRange(null,o.value,e=>{o.value=e,t.uniformsDirty=!0},{className:"primary flex-auto-fill",skipReset:!0,min:s,max:r,step:l,precision:c})),e.push(n.addNumber("Max",o.max,n=>{o.max=n,e.forEach(e=>e.setLimits(o.min,o.max,o.step)),t.uniformsDirty=!0},{className:"flex-auto-keep",width:"20%",nameWidth:"35%",skipReset:!0,min:s,step:l,precision:c})),e.push(n.addNumber("Step",o.step,n=>{o.step=n,e.forEach(e=>e.setLimits(o.min,o.max,o.step)),t.uniformsDirty=!0},{className:"flex-auto-keep",width:"20%",nameWidth:"35%",skipReset:!0,step:l,precision:c}))}else if(o.isColor){const a="vec4f"===o.type,s={r:o.value[0],g:o.value[1],b:o.value[2]};a&&(s.a=o.value[3]),n.addColor(null,e.rgbToHex(s),e=>{o.value=[e.r,e.g,e.b],a&&(o.value[3]=e.a),t.uniformsDirty=!0},{className:"flex-auto-fill",skipReset:!0,useRGB:!0})}else{n[`addVector${o.value.length}`](null,o.value,e=>{o.value=e,t.uniformsDirty=!0},{className:"flex-auto-fill",skipReset:!0,step:o.step})}n.endLine()}}},renderShaderLibraryView(){const t=this.libraryContainerPanel;if(!t)return;t.clear(),t.addText(null,"",e=>{const t=e.trim().toLowerCase();if(!t)return o.toggleCollapsed(!1),void this.renderLibraryCategory(n,n[0].name);const a=[];for(const e of n)for(const n of e.snippets){(n.name.toLowerCase().includes(t)||n.description?.toLowerCase().includes(t)||n.author?.toLowerCase().includes(t))&&a.push(n);const e=n.options;if(e)for(const o of e)o.label.toLowerCase().includes(t)&&a.push({snippet:o,parentSnippet:n})}o.collapsed||o.toggleCollapsed(!0),this.renderLibraryCategory(n,null,a)},{className:"w-full",trigger:"input",placeholder:"Search in library..."});const n="webgpu"===$.backend?b:A,a=new e.Area({height:"calc(100% - 38px)",className:"rounded-xl overflow-hidden",skipAppend:!0}),o=a.addSidebar(e=>{n.forEach(t=>{e.add(t.name,{icon:t.icon,callback:()=>{this.renderLibraryCategory(n,t.name)}});const a=t.snippets;a&&a.forEach(a=>{const o=a.options;if(!o)return;const s=`${t.name}/${a.name}`;e.add(s,{callback:()=>{this.renderLibraryCategory(n,t.name,o,a)}})})})},{skipHeader:!0,skipFooter:!0,collapsed:!1,collapsable:!0,displaySelected:!0});t.attach(a);{const t=o.siblingArea;e.addClass(t.root,"p-2"),this.renderLibraryCategory=(n,a,o,s)=>{if(t.root.innerHTML="",a&&s){const o=e.makeElement("div","w-full h-auto flex flex-row gap-2 pl-2 pt-2","",t);o.appendChild(new e.Button(null,"Back",()=>{this.renderLibraryCategory(n,a)},{className:"w-auto",buttonClass:"link",icon:"ArrowLeft",iconPosition:"start"}).root),o.appendChild(new e.TextInput(null,`${a} / ${s.name}`,null,{disabled:!0,inputClass:"font-semibold bg-none"}).root)}const i=t.addPanel({className:"grid grid-cols-2 auto-rows-max p-2 items-center justify-center"});if(i.root.classList.remove("scrollbar-hidden"),!o){const e=n.find(e=>e.name===a);if(!e||!e.snippets)return;o=e.snippets}for(const e of o){let t=e.snippet??e,o=t.label??t.name;e.parentSnippet&&(o=`<span class="text-muted-foreground">${e.parentSnippet.name}</span> / ${o}`);const r=t.author??s?.author,l=t.description??s?.description??"";i.addCard(t.name,{header:{title:o,description:`${l}${r?`<br><span class="italic">by ${r}</span>`:""}`,action:{name:t.options?"Open":"Insert",callback:()=>{if(t.options)this.renderLibraryCategory(n,a,t.options,t);else{const e=this.editor;e&&e.appendText(`${t.code}\n`)}}}},className:"h-full"})}},this.renderLibraryCategory(n,"Constants")}},async onCodeEditorReady(t,n){let[a,o]=n.split({type:"vertical",sizes:["auto","auto"],resize:!1});a.root.className+=" bg-none box-shadow box-border rounded-xl overflow-hidden flex-auto-keep",o.root.className+=" bg-none box-shadow box-border rounded-xl items-center justify-center flex-auto-fill";const s=this.shader,i="EMPTY_ID"===s.uid;this._createShaderDataView=async()=>{const t=this.fs.user&&s.authorId===this.fs.getUserId(),n=s.originalId?await $.getShaderById(s.originalId):null;o.root.innerHTML="";const a=e.makeContainer(["100%","100%"],"p-3 sm:p-6 flex flex-col gap-2 rounded-xl bg-card overflow-scroll overflow-x-hidden","",o),r=e.makeContainer(["100%","auto"],"flex flex-row",`\n                <div class="flex flex-col gap-1 justify-center">\n                    <div class="flex flex-row items-center">\n                        ${t||i?e.makeIcon("Edit",{svgClass:"mr-2 cursor-pointer hover:text-foreground"}).innerHTML:""}\n                        <div class="text-foreground text-lg font-semibold">${s.name}</div>\n                    </div>\n                    ${i?"":`<div class="text-muted-foreground text-sm">Created by ${s.anonAuthor?"":`<a onclick='ui._openUserProfile("${s.authorId}")' class='hub-link font-medium'>`}<span>${s.author}</span>${s.anonAuthor?"":"</a>"} on ${s.creationDate}\n                    ${n?`(remixed from <a onclick='ui._openShader("${s.originalId}")' class='hub-link font-medium'>${n.name}</a> by <a onclick='ui._openUserProfile("${n.authorId}")' class='hub-link font-medium'>${n.author}</a>)`:""} `}\n                    </div>\n                </div>\n            `,a),l=r.querySelector("svg");if(l){const t=async(e,t,n)=>{if(s.name=e.substring(0,64),t.innerText=s.name,n.root.replaceWith(t),this._editingName=!1,i)return;let a=await $.shaderExists();a&&a.name!==s.name&&(await this.fs.updateDocument(c.SHADERS_COLLECTION_ID,a.$id,{name:s.name}),k("✅ Shader updated",`Shader: ${a.name} by ${this.fs.user.name}`))};l.addEventListener("click",n=>{if(this._editingName)return;n.preventDefault();const a=n.target.parentElement.children[1],o=new e.TextInput(null,a.textContent,async e=>{t(e,a,o)},{inputClass:"text-foreground text-lg font-semibold",pattern:e.buildTextPattern({minLength:3})});a.replaceWith(o.root),e.doAsync(()=>o.root.focus()),this._editingName=!0})}const d=e.makeContainer(["auto","auto"],"ml-auto flex flex-row p-1 gap-1 self-start content-center items-center","",r),u=t||i;if(this.fs.user){const t=new e.Button(null,"ShaderOptions",async()=>{const n=await $.shaderExists();let a=[];u?(a.push(U?0:{name:"Save Shader",icon:"Save",callback:()=>$.saveShader(n)},i||U?0:{name:"Settings",icon:"Settings",callback:()=>this.openShaderSettingsDialog(n)}),n&&a.push(U?0:{name:"Update Preview",icon:"ImageUp",callback:()=>$.updateShaderPreview(s.uid,!0)})):a.push(U?0:{name:"Remix Shader",icon:"GitFork",disabled:!(n.remixable??1),callback:()=>$.remixShader()}),a.push(n?{name:"Share",icon:"Share2",callback:()=>this.openShareiFrameDialog(n)}:0),u&&n&&a.push(U?0:null,{name:"Delete Shader",icon:"Trash2",className:"destructive",callback:()=>$.deleteShader()}),a=a.filter(e=>0!==e),a.length&&e.addDropdownMenu(t.root,a,{side:"bottom",align:"end"})},{icon:"Menu"});d.appendChild(t.root)}else e.makeContainer(["144px","auto"],"text-muted-foreground text-sm","Login to Save or Remix",d);if(!i){const n=e.makeContainer(["auto","auto"],"ml-auto flex p-1 gap-1 items-center",`\n                    ${e.makeIcon("Heart",{svgClass:"shader-like-button lg fill-current transition duration-150 ease-in-out"}).innerHTML} <span></span>\n                `);d.prepend(n);const a=n.querySelector("span"),o=d.querySelector("svg.shader-like-button");e.addClass(o,"hover:text-orange-600 hover:shadow-primary cursor-pointer"),e.addSignal("@on_like_changed",(t,n)=>{const[s,i,r]=n;a.innerHTML=s,e.toggleClass(o,"text-orange-600",i),e.toggleClass(o,"shadow-primary",i)}),this.fs.user?t?(o.title="Check Likes",e.asTooltip(o,o.title),o.addEventListener("click",e=>{e.preventDefault(),this.openCurrentShaderLikesDialog(s)})):(o.title="Like Shader",e.asTooltip(o,o.title),o.addEventListener("click",e=>{e.preventDefault(),$.onShaderLike()})):(o.title="Like Shader",e.asTooltip(o,o.title),o.addEventListener("click",t=>{t.preventDefault(),this._lastOpenedDialog&&this._lastOpenedDialog.close();const n=new e.Dialog(null,t=>{t.root.className=e.mergeClass(t.root.className,"pad-2xl flex flex-col gap-2"),e.makeContainer(["100%","100%"],"text-lg font-medium text-foreground p-2","Login to like this shader.",t),t.addButton(null,"Close",()=>{n.destroy()},{buttonClass:"h-8 ghost"})},{modal:!0});this._lastOpenedDialog=n}))}if(u||s.tags.length){const n=new e.Tags(null,"",async e=>{if(s.tags=e,i)return;let t=await $.shaderExists();t&&(await this.fs.updateDocument(c.SHADERS_COLLECTION_ID,t.$id,{tags:s.tags}),k("✅ Shader updated",`Shader: ${t.name} by ${this.fs.user.name}`))},{disabled:!t,tagClass:"items-center text-xs"});n.set(s.tags,!0),a.appendChild(n.root)}const p=async(e,t=!0)=>{if(s.description=t?S(e):e,i)return;let n=await $.shaderExists();n&&n.description!==s.description&&(await this.fs.updateDocument(c.SHADERS_COLLECTION_ID,n.$id,{description:s.description}),k("✅ Shader updated",`Shader: ${n.name} by ${this.fs.user.name}`))};if(t&&i){const t=new e.TextArea(null,s.description,async e=>{p(e,!1)},{resize:!1,placeholder:"Enter your shader description here",className:"w-full",inputClass:"bg-accent/50!",fitHeight:!0});a.appendChild(t.root)}else if(t||(s.description??"").length){const t=e.makeContainer(["auto","auto"],"text-foreground mt-2 flex flex-row items-center",`\n                    <div class="w-auto self-start">${u?e.makeIcon("Edit",{svgClass:"mr-3 cursor-pointer hover:text-foreground"}).innerHTML:""}</div>\n                    <div class="desc-content w-full text-sm break-keep">${s.description}</div>\n                    `,a),n=t.querySelector("svg");n&&n.addEventListener("click",n=>{if(this._editingDescription)return;n.preventDefault();const a=t.querySelector(".desc-content"),o=new e.TextArea(null,a.innerHTML.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/<br\s*\/?>/gi,"\n").replace(/<a\s+[^>]*href=["']([^"']+)["'][^>]*>(.*?)<\/a>/gi,"[$2]($1)").replace(/<b>(.*?)<\/b>/gi,"**$1**").replace(/<i>(.*?)<\/i>/gi,"*$1*").replace(/<u>(.*?)<\/u>/gi,"~~$1~~").trim(),async e=>{p(e),a.innerHTML=s.description,o.root.replaceWith(a),this._editingDescription=!1},{resize:!1,placeholder:"Enter your shader description here",className:"w-full h-full",inputClass:"bg-accent/50! h-full",fitHeight:!0});a.replaceWith(o.root),e.doAsync(()=>o.root.focus()),this._editingDescription=!0})}if(!i){const t=this.fs.user&&!i,n=e.makeContainer(["auto","auto"],"text-foreground mt-2 flex flex-col gap-2","",a),o=async()=>{const a=await this.fs.listDocuments(c.INTERACTIONS_COLLECTION_ID,[I.equal("type",["comment","comment-reply"]),I.equal("shader_id",s.uid),I.limit(300),I.orderDesc("$createdAt")]);if(n.innerHTML=`Comments (${a.total})`,t){const t=new e.Avatar({imgSource:this.dbUser.avatar,fallback:this.dbUser.user_name[0].toUpperCase(),className:"mx-2 flex-auto-keep mt-1"}),a=e.makeContainer(["100%","auto"],"flex flex-row mt-2 p-2 gap-2 bg-muted/75 rounded-lg items-start content-center",`\n                                ${t.root.outerHTML}\n                            `,n),i=new e.TextArea(null,"",null,{placeholder:"Add a comment...",className:"flex w-full flex-auto-fill",inputClass:"bg-background/50!",fitHeight:!0});a.appendChild(i.root);const r=new e.Button(null,"SubmitComment",async()=>{const e=S(i.value().trim());0!==e.length&&(await $.saveComment(s.uid,e),o())},{className:"flex-auto-keep",buttonClass:"primary self-start",icon:"Send",title:"Submit Comment"});a.appendChild(r.root)}if(a.total>0){const i=Array.from(new Set(a.documents.map(e=>e.author_id))),r=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",i)]),l=e.deepCopy(a.documents).reverse();for(const i of a.documents){if("comment"!==i.type)continue;const a=i.author_id,d=r.documents.find(e=>e.user_id===a),u=d.user_name,p=new e.Avatar({imgSource:d.avatar,fallback:u[0].toUpperCase(),className:"mx-2 flex-auto-keep"});let m=i.text??"";const h=/(^|\s)@([a-zA-Z0-9._]+)/g,f=[...m.matchAll(h)];if(f.length)for(const e of f){const t=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_name",e[2])]);0!==t.total&&(m=m.substring(0,e.index)+m.substring(e.index).replace(e[0],` <span onclick='ui._openUserProfile("${t.documents[0].user_id}")' class="hub-mention">${e[0]}</span>`))}const g=new Date(i.$createdAt).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}),v=e.makeContainer(["100%","auto"],"flex flex-col bg-muted/75 rounded-lg","",n),x=e.makeContainer(["100%","auto"],"flex flex-row p-2 gap-2 items-center content-center",`\n                                    ${p.root.outerHTML}\n                                    <div class="flex flex-col gap-1 flex-auto-fill">\n                                        <div class="flex flex-row gap-2 items-center">\n                                            <div class="text-sm font-medium"><a onclick='ui._openUserProfile("${a}")' class='hub-link font-medium'>${u}</a></div>\n                                            <div class="text-xs text-muted-foreground">${g}</div>\n                                        </div>\n                                        <div class="text-sm w-full break-keep">${m}</div>\n                                    </div>\n                                `,v);if(t){const t=new e.Button(null,"ActionsButton",async()=>{const n=[{name:"Reply",icon:"Reply",callback:()=>{document.querySelectorAll(".shader-comment-reply-item").forEach(e=>e.remove());const t=e.makeContainer(["100%","auto"],"shader-comment-reply-item flex flex-row mt-2 p-2 gap-2 bg-muted/75 rounded-lg items-start content-center","",v),n=new e.TextArea(null,"",e=>{0===e.length&&t.remove()},{placeholder:`Replying to ${u}...`,className:"flex w-full flex-auto-fill",inputClass:"bg-background/50!",fitHeight:!0});t.appendChild(n.root);const a=new e.Button(null,"SubmitReply",async()=>{const e=S(n.value().trim());0!==e.length&&(await this.fs.createDocument(c.INTERACTIONS_COLLECTION_ID,{type:"comment-reply",shader_id:s.uid,author_id:this.fs.getUserId(),comment_id:i.$id,text:e}),o())},{buttonClass:"primary self-start",icon:"Send",title:"Submit Reply"});t.appendChild(a.root)}}];this.fs.getUserId()===a&&n.push(null,{name:"Delete",icon:"Trash2",className:"destructive",callback:async()=>{await this.fs.deleteDocument(c.INTERACTIONS_COLLECTION_ID,i.$id),v.remove()}}),e.addDropdownMenu(t.root,n,{side:"bottom",align:"end"})},{buttonClass:"h-7 p-0 ghost self-center ml-auto flex-auto-keep",icon:"EllipsisVertical"});x.appendChild(t.root)}const b=e.makeContainer(["100%","auto"],"flex flex-col bg-accent/50! rounded-b-lg","",v);for(const n of l){if("comment-reply"!==n.type||n.comment_id!==i.$id)continue;let a=n.text??"";const o=/(^|\s)@([a-zA-Z0-9._]+)/g,s=[...a.matchAll(o)];if(s.length)for(const e of s){const t=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_name",e[2])]);0!==t.total&&(a=a.substring(0,e.index)+a.substring(e.index).replace(e[0],` <span onclick='ui._openUserProfile("${t.documents[0].user_id}")' class="hub-mention">${e[0]}</span>`))}const l=n.author_id,d=r.documents.find(e=>e.user_id===l),u=d.user_name,p=new e.Avatar({imgSource:d.avatar,fallback:u[0].toUpperCase(),className:"mx-2 flex-auto-keep"}),m=new Date(n.$createdAt).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}),h=e.makeContainer(["95%","auto"],"flex flex-row p-2 gap-2 items-center content-center ml-auto",`\n                                        ${e.makeIcon("CornerDownRight",{svgClass:"text-muted-foreground"}).innerHTML}\n                                        ${p.root.outerHTML}\n                                        <div class="flex flex-col gap-1 flex-auto-fill">\n                                            <div class="flex flex-row gap-2 items-center">\n                                                <div class="text-sm font-medium"><a onclick='ui._openUserProfile("${l}")' class='hub-link font-medium'>${u}</a></div>\n                                                <div class="text-xs text-muted-foreground">${m}</div>\n                                            </div>\n                                            <div class="text-sm w-full break-keep">${a}</div>\n                                        </div>\n                                    `,b);if(t){const t=new e.Button(null,"ActionsButton",async()=>{const a=[];this.fs.getUserId()===l&&a.push({name:"Delete",icon:"Trash2",className:"destructive",callback:async()=>{await this.fs.deleteDocument(c.INTERACTIONS_COLLECTION_ID,n.$id),h.remove()}}),e.addDropdownMenu(t.root,a,{side:"bottom",align:"end"})},{buttonClass:"h-7 p-0 ghost self-center ml-auto flex-auto-keep",icon:"EllipsisVertical"});h.appendChild(t.root)}}}}};await o()}U&&a.appendChild(new e.Button(null,"Open Code",()=>{window.__currentSheet&&window.__currentSheet.destroy();const t=new e.Area({className:"overflow-scroll"});window.__currentSheet=new e.Sheet("80%",[t],{side:"bottom"}),e.doAsync(()=>{new e.CodeEditor(t,{disableEdition:!0,allowClosingTabs:!1,allowLoadingFiles:!1,fileExplorer:!1,defaultTab:!1,statusShowEditorIndentation:!1,statusShowEditorLanguage:!1,statusShowEditorFilename:!1,statusShowFontSizeZoom:!1,statusShowEditorSelection:!1,onCreateFile:e=>null,onSelectTab:async(e,t)=>{$.onShaderPassSelected(e)},onReady:async e=>{this.shader.passes.forEach((t,n)=>{e.addTab(t.name,{selected:!0,title:t.name,codeLines:t.codeLines.join("\n"),language:"WGSL"})})}})},150)},{icon:"Code",iconPosition:"end",className:"absolute bottom-0 mb-6 self-center mx-auto",buttonClass:"outline"}).root)},await this._createShaderDataView();{let[n,o]=a.split({type:"vertical",sizes:["calc(100% - 48px)",null],resize:!1});n.root.className+=" bg-none",o.root.className+=" px-2 rounded-b-xl bg-card";const i=this.makeGPUCanvas();n.attach(i);const r=o.addPanel({className:"flex flex-row"});if(r.sameLine(),r.addButton(null,"ResetTime",()=>$.onShaderTimeReset(),{className:"flex-auto-keep",icon:"SkipBack",title:"Reset time",tooltip:!0}),r.addButton(null,"PauseTime",()=>$.onShaderTimePaused(),{className:"flex-auto-keep",icon:"Pause",title:"Pause/Resume",tooltip:!0,swap:"Play"}),r.addLabel("0.0",{signal:"@elapsed-time",inputClass:"size-content"}),r.addLabel("0 FPS",{signal:"@fps",inputClass:"size-content"}),r.addLabel("0x0",{signal:"@resolution",inputClass:"size-content"}),r.endLine("items-center h-full"),!U){let t={format:"gif",frames:"120",framerate:"30"};const n=(e,n)=>{t[e]=n};r.sameLine();const a=e.makeContainer(["auto","auto"],"flex flex-row ml-auto");this._recordButton=new e.Button(null,"RecordButton",(n,a)=>{if(this.captureInProgress)return;const o=this._recordButton.root.querySelector("button");o.classList.remove("bg-none","lexbutton"),o.classList.add("bg-destructive","hover:bg-destructive","rounded-lg","border-none"),this.captureInProgress=!0,e.doAsync(()=>$.startCapture(t))},{icon:"Video",className:"p-0",buttonClass:"outline record-button",title:"Record",tooltip:!0}),a.appendChild(this._recordButton.root);const o=new e.Button(null,"RecordSettingsButton",(a,o)=>{const s=o.target;s.Format=t.format,s.Frames=t.frames,s["Frame Rate"]=t.framerate,e.addDropdownMenu(s,[{name:"Format",icon:"FileArchive",submenu:["gif","png","webm"].map(a=>({name:`${t.format===`${a}`?e.makeIcon("Circle",{svgClass:"2xs fill-current inline-flex! mr-2"}).innerHTML:""}${a}`,callback:e=>n("format",e)}))},{name:"Frames",icon:"Film",submenu:[60,120,180,240,300].map(a=>({name:`${t.frames===`${a}`?e.makeIcon("Circle",{svgClass:"2xs fill-current inline-flex! mr-2"}).innerHTML:""}${a}`,callback:e=>n("frames",e)}))},{name:"Frame Rate",icon:"Gauge",submenu:[10,15,30,60].map(a=>({name:`${t.framerate===`${a}`?e.makeIcon("Circle",{svgClass:"2xs fill-current inline-flex! mr-2"}).innerHTML:""}${a}`,callback:e=>n("framerate",e)}))}],{side:"bottom",align:"end"})},{icon:"ChevronDown",className:"p-0",buttonClass:"bg-none"});a.appendChild(o.root),r.addContent(null,a),r.addButton(null,"Fullscreen",()=>$.requestFullscreen(),{icon:"Fullscreen",title:"Fullscreen",tooltip:!0}),r.endLine("items-center h-full ml-auto")}await $.onShaderEditorCreated(s,i),t&&e.doAsync(()=>t.charWidth=t._measureChar(),400)}},async renderUserView(t){this._clearContent(),this.currentView="user";let[n,s]=this.area.split({type:"vertical",sizes:["calc(100% - 48px)",null],resize:!1});n.root.parentElement.classList.add("hub-background"),n.root.className+=" p-6 bg-transparent overflow-scroll max-w-[1600px] ml-auto mr-auto",s.root.className+=" items-center content-center",this._makeFooter(s);const i=this.fs.user&&t===this.fs.getUserId();if(!i){if(0===(await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",t)])).total)return void e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","No user found.",n)}const r=await this.fs.listDocuments(c.USERS_COLLECTION_ID),l=r.documents.find(e=>e.user_id===t),d=l.user_name,u=l.public;document.title=`${d} - ShaderHub`;const p=new URLSearchParams(document.location.search).get("order_by"),m=new e.Avatar({imgSource:l.avatar,fallback:d[0].toUpperCase(),className:"size-12 [&_span]:text-xl [&_span]:leading-12"}),h=e.makeContainer(["100%","auto"],"flex flex-col gap-4 p-2 my-8 justify-center",`\n            <div class="avatar-container flex flex-row gap-3 text-3xl font-bold content-center items-center">\n                ${l.display_name?`${l.display_name} <span class="text-xl font-normal text-muted-foreground">(${d})</span>`:d}\n            </div>\n            <div class="flex flex-row gap-2">\n                <div style="max-width: 600px; overflow-wrap: break-word;" class="desc-content text-lg font-medium text-card-foreground">${l.description??""}</div>\n            </div>\n        `,n);if(h.querySelector(".avatar-container").prepend(m.root),!i&&!u)return void e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","Private user, sorry :(",n);const f=n.addTabs({parentClass:"bg-transparent",sizes:["auto","auto"],contentClass:"p-2 my-2 bg-transparent rounded-xl border-color h-auto!"});{const n=e.makeContainer([null,"auto"],"flex flex-col relative p-1 pt-0 rounded-lg overflow-hidden");f.add("Shaders",n,{selected:!0,onSelect:(e,t)=>{document.title=`${d} - ShaderHub`}});const s=e.makeContainer(["100%","auto"],"flex flex-col sm:flex-row","",n),r=new e.TextInput(null,"",e=>{this._refreshOwnShaders(e)},{placeholder:"Filter shaders...",className:"w-full flex-auto-fill sm:max-w-[25%]"});s.appendChild(r.root);{const t=new e.Panel({className:"p-4 bg-none",height:"auto"});t.sameLine(),t.addLabel("Order by",{fit:!0});const n=p??"recent";for(let e of a){const a=e.toLowerCase();t.addButton(null,e,e=>this._exploreOrderBy(e.toLowerCase(),"user"),{buttonClass:"xs "+(n===a?"primary":"outline bg-card!")})}t.endLine(),s.appendChild(t.root)}const l=new e.Pagination({className:"ml-auto",maxButtons:4,useEllipsis:!0,alwaysShowEdges:!1,xallowChangeItemsPerPage:!0,onChange:e=>{this._refreshOwnShaders(void 0,e.toString())}});s.appendChild(l.root);const u=e.makeContainer(["100%","auto"],"flex p-1 my-2","",n);this._refreshOwnShaders=async(n,a)=>{u.innerHTML="",this._lastFilterSearch=n??"",this._lastFilteredPage=a?parseInt(a):1;const s=p?o[p]:o.recent,r=[I.equal("author_id",t),"asc"===s.direction?I.orderAsc(s.field):I.orderDesc(s.field),I.offset(8*(this._lastFilteredPage-1)),I.limit(8)];if(i||r.push(I.or([I.equal("public",!0),I.isNull("public")])),""!==this._lastFilterSearch)if("#"===this._lastFilterSearch[0]){const e=this._lastFilterSearch.substring(1);r.push(I.contains("tags",e))}else r.push(I.or([I.contains("name",this._lastFilterSearch),I.contains("description",this._lastFilterSearch),I.contains("author_name",this._lastFilterSearch)]));const d=await this.fs.listDocuments(c.SHADERS_COLLECTION_ID,r);l.setPages(Math.ceil(d.total/8)),l.setPage(this._lastFilteredPage);const m=$.filterShaders(d.documents,this._lastFilterSearch);if(0===m.length){const t=e.makeContainer(["100%","auto"],"flex flex-col p-2 justify-center","",u);e.makeContainer(["100%","auto"],"mt-2 text-2xl font-medium justify-center text-center","No shaders found.",t);const n=new e.Button(null,"Create a Shader",()=>this._openShader("new"),{className:"mt-2 place-self-center w-fit!",icon:"ChevronRight",iconPosition:"end",buttonClass:"lg primary"});return void t.appendChild(n.root)}const h=this._generateShaderItemSkeleton(m.length),f=new e.Skeleton(h);f.root.classList.add("grid","shader-list","gap-6","justify-center"),u.appendChild(f.root);const g=await this.fs.listFiles([I.startsWith("name",$.previewNamePrefix),I.endsWith("name",".png"),I.contains("name",m.map(e=>e.$id)),I.limit(8)]);e.doAsync(async()=>{f.root.querySelectorAll(".lexskeletonpart").forEach(e=>e.classList.remove("lexskeletonpart"));for(let t=0;t<m.length;++t){const n=m[t],a=n.$id,o=n.name,s={name:o,uid:a,likeCount:n.like_count??0,public:n.public??!0,url:await this.fs.getFileUrl(n.file_id),liked:!!this.dbUser&&(this.dbUser.liked_shaders??[]).includes(a)},r=$.getShaderPreviewName(s.uid),l=g.files.find(e=>e.name===r);l&&(s.preview=await this.fs.getFileUrl(l.$id));const d=f.root.children[t],u=d.querySelector("img");u.src=s.preview??$.shaderPreviewPath,u.onload=()=>u.classList.remove("opacity-0"),d.querySelector("div").remove();const p=e.makeContainer(["100%","auto"],"flex flex-row rounded-b-lg gap-6 px-4 py-3 items-center select-none",`\n                            <span class="w-full text-sm font-medium text-nowrap truncate">${s.name}</span>\n                            <div class="flex flex-row gap-1 flex-auto-keep items-center shader-prof-opt">\n                                <div class="flex flex-row gap-1 items-center">\n                                    ${e.makeIcon("Heart",{svgClass:(s.liked?"text-orange-600 shadow-primary":"text-muted-foreground")+" fill-current sm"}).innerHTML}\n                                    <span class="text-xs text-muted-foreground">${s.likeCount??0}</span>\n                                </div>\n                                ${i?'<span class="h-4 mx-1 border-right border-color text-muted-foreground self-center items-center"></span>':""}\n                            </div>`,d);p.querySelector(".viz-icon");const h=p.querySelector(".shader-prof-opt");if(h){const t=new e.Button(null,"VisibilityButton",async(e,t)=>{s.public=!s.public,await this.fs.updateDocument(c.SHADERS_COLLECTION_ID,a,{public:s.public})},{icon:s.public?"Eye":"EyeOff",swap:s.public?"EyeOff":"Eye",title:"Toggle Public/Private",tooltip:!0,className:"p-0",buttonClass:"px-1! ghost sm"});h.appendChild(t.root);const n=new e.Button(null,"ExportButton",async(t,n)=>{const a=JSON.parse(await this.fs.requestFile(s.url,"text")).passes.map((e,t)=>{const n=[];return 0!==t&&n.push(""),n.push(`// ${e.name}`,"",...e.codeLines),n.join("\n")}).join("\n");e.downloadFile(`${s.name.replaceAll(" ","")}.wgsl`,a)},{icon:"Download",className:"p-0",buttonClass:"px-1! ghost sm",title:"Export",tooltip:!0});h.appendChild(n.root);const i=new e.Button(null,"DeleteButton",(e,t)=>{$.deleteShader({uid:a,name:o})},{icon:"Trash2",className:"p-0",buttonClass:"px-1! destructive sm",title:"Delete",tooltip:!0});h.appendChild(i.root)}u.addEventListener("mousedown",e=>e.preventDefault()),u.addEventListener("mouseup",e=>{this._openShader(s.uid,e)})}},10)},await this._refreshOwnShaders()}if(i){{let t=!1;const n=e.makeContainer([null,"auto"],"flex flex-col relative p-1 pt-0 rounded-lg overflow-hidden");f.add("Liked",n,{xselected:!0,onSelect:async(a,o)=>{if(document.title=`${d} Liked - ShaderHub`,t)return;t=!0;const s=e.makeContainer(["100%","auto"],"flex flex-col sm:flex-row","",n),i=new e.TextInput(null,"",e=>{this._refreshLikedShaders(e)},{placeholder:"Filter shaders...",className:"w-full flex-auto-fill sm:max-w-[25%]"});s.appendChild(i.root);const u=new e.Pagination({className:"ml-auto",maxButtons:4,useEllipsis:!0,alwaysShowEdges:!1,xallowChangeItemsPerPage:!0,onChange:e=>{this._refreshLikedShaders(void 0,e.toString())}});s.appendChild(u.root);const p=e.makeContainer(["100%","auto"],"flex p-1 my-2","",n);this._refreshLikedShaders=async(t,a)=>{p.innerHTML="",this._lastFilterSearch=t??"",this._lastFilteredPage=a?parseInt(a):1;const o=[I.or([I.equal("public",!0),I.isNull("public")]),I.offset(8*(this._lastFilteredPage-1)),I.limit(8)],s=l.liked_shaders,i=[];if(s.forEach(e=>{i.push(I.equal("$id",e))}),!i.length)return void e.makeContainer(["100%","auto"],"mt-2 text-2xl font-medium justify-center text-center","\n                            No liked shaders found. <br>\n                            Start browsing now to discover new shaders!",n);if(o.push(1===i.length?i[0]:I.or(i)),""!==this._lastFilterSearch)if("#"===this._lastFilterSearch[0]){const e=this._lastFilterSearch.substring(1);o.push(I.contains("tags",e))}else o.push(I.or([I.contains("name",this._lastFilterSearch),I.contains("description",this._lastFilterSearch),I.contains("author_name",this._lastFilterSearch)]));const d=await this.fs.listDocuments(c.SHADERS_COLLECTION_ID,o);u.setPages(Math.ceil(d.total/8)),u.setPage(this._lastFilteredPage);let m=$.filterShaders(d.documents,this._lastFilterSearch);if(0===m.length)return void e.makeContainer(["100%","auto"],"mt-2 text-2xl font-medium justify-center text-center","No shaders found.",p);const h=this._generateShaderItemSkeleton(m.length),f=new e.Skeleton(h);f.root.classList.add("grid","shader-list","gap-6","justify-center"),p.appendChild(f.root);const g=await this.fs.listFiles([I.startsWith("name",$.previewNamePrefix),I.endsWith("name",".png"),I.contains("name",m.map(e=>e.$id)),I.limit(8)]);e.doAsync(async()=>{f.root.querySelectorAll(".lexskeletonpart").forEach(e=>e.classList.remove("lexskeletonpart"));const t=new Map(s.map((e,t)=>[e,t]));m=m.sort((e,n)=>t.get(e)-t.get(n)).reverse();for(let t=0;t<m.length;++t){const n=m[t],a={name:n.name,uid:n.$id,likeCount:n.like_count??0},o=n.author_id;if(o){const e=r.documents.find(e=>e.user_id===o).user_name;a.author=e,a.authorId=o}else a.author=n.author_name,a.anonAuthor=!0;const s=$.getShaderPreviewName(a.uid),i=g.files.find(e=>e.name===s);i&&(a.preview=await this.fs.getFileUrl(i.$id));const l=f.root.children[t],c=l.querySelector("img");c.src=a.preview??$.shaderPreviewPath,c.onload=()=>c.classList.remove("opacity-0"),l.querySelector("div").remove(),e.makeContainer(["100%","auto"],"flex flex-row rounded-b-lg gap-6 px-4 py-3 items-center select-none",`\n                                <div class="flex flex-row w-full items-center gap-2">\n                                   <span class="text-sm font-medium text-nowrap truncate">${a.name}</span>\n                                    <span class="text-sm font-light text-muted-foreground flex-auto-keep">by ${a.anonAuthor?"":`<a onclick='ui._openUserProfile("${a.authorId}")' class='hub-link font-medium'>`}<span>${a.author}</span>${a.anonAuthor?"":"</a>"}</span>\n                                    <div class="flex flex-row gap-1 items-center ml-auto flex-auto-keep">\n                                        ${e.makeIcon("Heart",{svgClass:"text-orange-600 shadow-primary fill-current sm"}).innerHTML}\n                                        <span class="text-sm">${a.likeCount??0}</span>\n                                    </div>\n                                </div>`,l),c.addEventListener("mousedown",e=>e.preventDefault()),c.addEventListener("mouseup",e=>{this._openShader(a.uid,e)})}},10)},await this._refreshLikedShaders()}})}{const t=e.makeContainer([null,"auto"],"flex flex-col relative p-1 pt-0 rounded-lg overflow-hidden");f.add("Preferences",t,{xselected:!0,onSelect:(e,t)=>{document.title=`${d} Preferences - ShaderHub`}});const n=e.makeContainer(["100%","auto"],"flex flex-col lg:flex-row gap-2 p-1 my-2","",t);{let t=!1,a=l.avatar??"",o=l.description??"",s=l.display_name??"",i=l.app_mode??"Auto",r=l.public??!0;const u=new e.Panel({className:"rounded-xl border-color"});u.addTitle("Profile"),u.addToggle("Public",r,e=>{r=e,t=!0},{className:"primary",nameWidth:"70%",skipReset:!0}),u.addText("Avatar",a,e=>{a=e,t=!0},{skipReset:!0,placeholder:"Enter a URL (optional)"}),u.addText("Display Name",s,e=>{s=e,t=!0},{skipReset:!0,placeholder:"Your full name (optional)"}),u.addTextArea("About",o,e=>{o=e,t=!0},{fitHeight:!0,skipReset:!0,inputClass:"bg-secondary!",placeholder:"Tell us something about yourself! (optional)"}),u.addTitle("App"),u.addSelect("Default Mode (Auto, Light, Dark)",["Auto","Light","Dark"],i,async n=>{i=n,t=!0,"Auto"===n?e.setSystemMode():e.setMode(n.toLowerCase())},{nameWidth:"70%",skipReset:!0,overflowContainer:u.root}),u.addSeparator();const p=u.addButton(null,"Save Changes",async()=>{if(!t)return;const n=new e.Spinner;p.root.querySelector("button").prepend(n.root),this.fs.updateDocument(c.USERS_COLLECTION_ID,l.$id,{avatar:a,description:o,display_name:s,app_mode:i,public:r}).then(e=>{e&&(n.destroy(),t=!1,Object.assign(l,e),h.querySelector(".desc-content").innerHTML=o,document.querySelectorAll(".lexavatar img").forEach(e=>e.src=a),k("✅ Settings updated",`User: ${d}`))})},{className:"place-self-center w-fit!",buttonClass:"primary"});n.appendChild(u.root)}{const t=new e.Panel({className:"rounded-xl border-color"});t.addTitle("Notifications"),t.addToggle("Comments",!1,()=>{},{className:"primary",disabled:!0,nameWidth:"70%"}),t.addToggle("Comment Replies",!1,()=>{},{className:"primary",disabled:!0,nameWidth:"70%"}),t.addToggle("Likes",!1,()=>{},{className:"primary",disabled:!0,nameWidth:"70%"}),t.addToggle("New Followers",!1,()=>{},{className:"primary",disabled:!0,nameWidth:"70%"}),t.addToggle("Follower New Shaders",!1,()=>{},{className:"primary",disabled:!0,nameWidth:"70%"}),t.addSeparator(),t.addButton(null,"Save Changes",async()=>{},{disabled:!0,className:"place-self-center w-fit!",buttonClass:"primary"}),n.appendChild(t.root)}{let t="";const a=new e.Panel({className:"rounded-xl border-color"});if(a.addTitle("Account"),this.fs.user?.emailVerification){let t=e.makeIcon("BadgeCheck",{svgClass:"md text-inherit!"}).innerHTML;a.attach(e.badge(t+"Email verified","success m-4 flex place-self-center",{asElement:!0}))}else{let t=e.makeIcon("BadgeX",{svgClass:"md text-inherit!"}).innerHTML;a.attach(e.badge(t+"Email not verified yet","destructive m-4 flex place-self-center",{asElement:!0})),a.addButton(null,"Send email verification",async()=>{const e=new URL(window.location.href);e.search="",await this.fs.account.createEmailVerification({url:e.href+"?verifyEmail=true"})},{className:"place-self-center w-fit!",buttonClass:"primary"})}a.addSeparator(),a.addLabel("Change Password");const o={password:{label:"Password",value:"",type:"password"},newPassword:{label:"New Password",value:"",type:"password",pattern:{minLength:8,digit:!0}},repeatPassword:{label:"Repeat New Password",value:"",type:"password",pattern:{fieldMatchName:"newPassword"}}},s=a.addForm(null,o,async(t,n)=>{if(s.syncInputs(),n.length)return void k("❌ Error",n.map(e=>`${e.entry}: ${e.messages.join("\n")}`).join("\n\n"),-1);const a=new e.Spinner;s.root.querySelector("button").prepend(a.root);try{this.fs.account.updatePassword(t.newPassword,t.password).then(e=>{e&&(a.destroy(),s.root.querySelectorAll("input[type=password]").forEach(e=>e.value=""),s.syncInputs(),k("✅ Password updated!",`User: ${d}`))})}catch(n){console.log(n),k("❌ Error",n,-1)}},{primaryActionName:"Update"});a.addSeparator(),a.addLabel("This action will delete your ShaderHub account. This is irreversible!"),a.addText("Password",t,e=>{t=e},{disabled:!0,type:"password",skipReset:!0}),a.addButton("Delete Account","Delete",async()=>{},{disabled:!0,buttonClass:"destructive"}),n.appendChild(a.root)}}}},onSymbolHovered:(e,t)=>$.getCodeSymbolValue(e.word),async makeStatusBarButtons(t,n){const a="webgpu"===$.backend,o=new e.Panel({className:"flex flex-row items-center",height:"auto"});o.sameLine();const s=(t,n,a)=>{e.makeContainer(["auto","auto"],"p-2 text-card-foreground text-xs "+(a??""),t,n,{wordBreak:"break-word"})},i=o.addButton(null,"MoreButton",async()=>{const t=[];"EMPTY_ID"===this.shader.uid&&t.push({name:"Graphics",icon:"Sparkles",submenu:[{name:"WebGPU",callback:()=>window.location.href=`${window.location.origin}/create`},{name:"WebGL",callback:()=>window.location.search="?r=gl"}]},null);const o=async e=>{const t=$.currentPass;if(!t)return;const o=(a?h:g)[`RENDER_${e.toUpperCase()}_TEMPLATE`],s=Array.isArray(o)?o:o.code,i=Array.isArray(o)?[]:o.channels??[];if(t.codeLines=s,n.setText(s.join("\n")),i.length){for(const e of i)$.addUniformChannel(t,e.index,{id:e.id,category:e.category});await B.updateShaderChannelsView(t)}else t.channels.forEach((e,t)=>{void 0!==e&&$.removeUniformChannel(t)});t.mustCompile=!0};e.addDropdownMenu(i.root,[...t,{name:"Templates",icon:"FolderCode",submenu:[{name:"Main",callback:e=>o(e)},{name:"Texture",callback:e=>o(e)},{name:"Mouse",callback:e=>o(e)},{name:"Animated",callback:e=>o(e)},{name:"Keyboard",callback:e=>o(e)}]},{name:"Quick Help",icon:"CircleQuestionMark",callback:()=>{new e.Dialog("Quick Help",e=>{e.root.classList.add("custom-parameters-panel","help-content","p-2","overflow-y-scroll"),s("ShaderHub is a playground for both WebGPU render and compute shaders. Everything here is written in WGSL, which is WebGPU's native shader language. For up-to-date information on WGSL, please see the <a href='https://www.w3.org/TR/WGSL/'>WGSL draft specification</a>. You can also take a <a href='https://google.github.io/tour-of-wgsl/'>tour of WGSL</a>.",e),e.addTitle("Inputs"),s("ShaderHub allows to use custom values controlled by sliders and provides the following default inputs:",e),s('Mouse input can be accessed from the <span class="text-destructive font-semibold">iMouse</span> struct:',e),s('<span class="text-foreground">iMouse.pos: vec2f</span> <span class="text-muted-foreground">// Mouse move position when pressed</span><br>\n<span class="text-foreground">iMouse.start: vec2f</span> <span class="text-muted-foreground">// Mouse down position</span><br>\n<span class="text-foreground">iMouse.delta: vec2f</span> <span class="text-muted-foreground">// Delta since last mouse move position</span><br>\n<span class="text-foreground">iMouse.press: f32</span> <span class="text-muted-foreground">// Mouse button down (none = -1, left = 0, middle: 1, right = 2)</span><br>\n<span class="text-foreground">iMouse.click: f32</span> <span class="text-muted-foreground">// Mouse button clicked (none = -1, left = 0, middle: 1, right = 2)</span>',e),s("Screen information:",e),s('<span class="text-foreground">iResolution: vec2f</span> <span class="text-muted-foreground">// Viewport resolution</span><br>',e),s("Time information:",e),s('<span class="text-foreground">iTime: f32</span> <span class="text-muted-foreground">// Elapsed time</span><br>\n<span class="text-foreground">iTimeDelta: f32</span> <span class="text-muted-foreground">// Delta time between frames</span><br>\n<span class="text-foreground">iFrame: i32</span> <span class="text-muted-foreground">// Frame number</span>',e),s("Selectable channel textures (with support for different texture samplers):",e),s('<span class="text-foreground">iChannel0...3: texture_2d<f32></span><br>\n<span class="text-muted-foreground">// where sampler can be "nearestSampler", "bilinearSampler", "trilinearSampler",</span><br>\n<span class="text-muted-foreground">// "nearestRepeatSampler", "bilinearRepeatSampler" or "trilinearRepeatSampler"</span><br>\n<span class="text-foreground">textureSample(iChannel0...3, <span class="text-destructive font-semibold">sampler</span>, uv)</span>',e),e.addTitle("Preprocessor"),s("ShaderHub also provides an experimental WGSL preprocessor. It currently allows the use of some directives:",e),s('<ul style="margin-block:0">\n    <li><span class="text-destructive font-semibold">#define NAME VALUE</span> for simple macros (function-like substitution not supported)</li>\n    <li><span class="text-destructive font-semibold">#if #elseif #else #endif</span> for conditional compilation</li>\n    <li><span class="text-destructive font-semibold">SCREEN_WIDTH</span> and <span class="text-destructive font-semibold">SCREEN_HEIGHT</span> are predefined variables for accessing canvas dimensions</li>\n</ul>',e),a&&(s('For <span class="text-destructive font-semibold">compute</span> shaders:',e),s('<ul style="margin-block:0">\n        <li><span class="text-destructive font-semibold">#workgroup_count ENTRYPOINT X Y Z</span> for specifying how many workgroups should be dispatched for an entrypoint</li>\n        <li><span class="text-destructive font-semibold">#dispatch_once ENTRYPOINT</span> for initialization purposes, ensuring the entrypoint is dispatched only once</li>\n        <li><span class="text-destructive font-semibold">#storage NAME TYPE</span> for declaring a storage buffer</li>\n    </ul>',e)),e.addTitle("Examples"),s('<a href="/?shader=68b8931090e336e8a1ad" class="text-foreground decoration-none font-semibold hover:text-card-foreground underline-offset-4 hover:underline cursor-pointer">Custom Uniforms</a>',e),s('<a href="/?shader=68c449875d3a5535bba0" class="text-foreground decoration-none font-semibold hover:text-card-foreground underline-offset-4 hover:underline cursor-pointer">Texture Buffer pass</a>',e),a&&(s('<a href="/?shader=68dac43a64cff0f5fa9d" class="text-foreground decoration-none font-semibold hover:text-card-foreground underline-offset-4 hover:underline cursor-pointer">Simple Compute Pass</a>',e),s('<a href="/?shader=68da7c00ef76c57eb056" class="text-foreground decoration-none font-semibold hover:text-card-foreground underline-offset-4 hover:underline cursor-pointer">Compute Storage usage</a>',e));const t=$.currentPass;if(t){e.addTitle("Shader Code"),s("Here are the current contents of this shader:",e);const n=(t.codeContent??"").replaceAll("    ","&emsp;").split("\n").map(e=>`<span>${e}</span>`);s(n.join(""),e,"flex flex-col p-4 text-muted-foreground select-text")}},{modal:!1,size:["700px","min(calc(100% - 32px), 900px)"]})}}],{side:"top",align:"start"})},{icon:"EllipsisVertical",title:"More",tooltip:!0,buttonClass:"ghost"});o.addButton(null,"CompileShaderButton",async()=>{await $.compileShader(!0,null,!0)},{icon:"Play",title:"Compile",tooltip:!0,buttonClass:"ghost"}),o.addCheckbox(null,this.autoCompile,e=>{this.autoCompile=e},{label:"Auto-compile",title:"Toggle Auto-Compile",className:"primary text-xs text-muted-foreground"}),o.endLine(),t.root.prepend(o.root)},makeGPUCanvas(){const e=document.createElement("canvas");e.className="webgpu-canvas w-full h-full rounded-b-none rounded-t-lg",e.tabIndex="0";{let t=(t,n)=>{e.width=t,e.height=n,$.onShaderCanvasResized(t,n)},n=()=>{let n=window.devicePixelRatio||1,a=0|Math.round(e.offsetWidth*n),o=0|Math.round(e.offsetHeight*n);t(a,o)};if(window.ResizeObserver){this.ro=new ResizeObserver(function(a,o){var s=a[0];if(s.devicePixelContentBoxSize){let e=s.devicePixelContentBoxSize[0];t(e.inlineSize,e.blockSize)}else o.unobserve(e),console.warn("This browser doesn't support ResizeObserver + device-pixel-content-box (2)"),n(),window.addEventListener("resize",n)});try{this.ro.observe(e,{box:["device-pixel-content-box"]})}catch(e){console.warn("This browser doesn't support ResizeObserver + device-pixel-content-box (1)"),n(),window.addEventListener("resize",n)}}else console.warn("This browser doesn't support ResizeObserver."),n(),window.addEventListener("resize",n)}return e.addEventListener("keydown",async e=>{$.onKeyDown(e),e.preventDefault()},!1),e.addEventListener("keyup",async e=>{$.onKeyUp(e),e.preventDefault()},!1),e.addEventListener("mousedown",e=>{$.onMouseDown(e.offsetX,e.offsetY,e.button)}),e.addEventListener("mouseup",e=>{$.onMouseUp(e)}),e.addEventListener("mousemove",e=>{$.onMouseMove(e.offsetX,e.offsetY)}),e.addEventListener("touchstart",t=>{t.preventDefault();const n=t.touches[0],a=e.getBoundingClientRect();$.onMouseDown(n.clientX-a.x,n.clientY-a.y,1)},{passive:!1}),e.addEventListener("touchend",e=>{e.preventDefault();e.changedTouches[0]&&$.onMouseUp(e)},{passive:!1}),e.addEventListener("touchmove",t=>{t.preventDefault();const n=t.touches[0],a=e.getBoundingClientRect();$.onMouseMove(n.clientX-a.x,n.clientY-a.y)},{passive:!1}),e},pushCompilationLog(t,n,a,o,s){const i=this.compileLogContainerPanel.root,r="error"===n,l=e.makeContainer(["100%","auto"],"flex flex-row items-center gap-2 px-3 py-2 rounded-md cursor-pointer text-sm hover:bg-accent transition "+(r?"text-destructive":"text-warning"),`\n            ${e.makeIcon(r?"CircleX":"TriangleAlert",{svgClass:"sm flex-auto-keep"}).innerHTML}\n            <span class="flex-auto-keep font-medium">[${t}] ${o}:${s}</span>\n            <span class="text-muted-foreground flex-1 truncate">${a}</span>\n        `,i);l.title=a,l.addEventListener("click",()=>{const e=this.editor;e&&e.loadTab(t)}),i.scrollTop=i.scrollHeight},async onLogin(e){const t=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",this.fs.getUserId())]);if(!t.documents.length)throw"Something happened onlogin";this.dbUser=t.documents[0];const n=document.querySelector("#loginOptionsButton button");n&&(n.innerHTML=await this.getLoginHtml(e)),document.querySelector("#signupContainer")?.classList.add("hidden"),L(),k("✅ Logged in",`Welcome ${e.email}!`);const a=window.location.pathname;if(a.startsWith("/view")||a.startsWith("/create"))await this._createShaderDataView();else if(a.startsWith("/user")){const e=R("user");if(!e)return;await this.renderUserView(e)}else await this.renderExploreView()},async onLogout(){await this.fs.logout(),this.dbUser=null,e.deleteElement(document.querySelector("#welcomeMessage"));const t=document.querySelector("#loginOptionsButton button");t&&(t.innerHTML=await this.getLoginHtml()),document.querySelector("#signupContainer")?.classList.remove("hidden"),await this.router()},onStopCapture(){const e=this._recordButton.root.querySelector("button");e.classList.remove("bg-destructive","hover:bg-destructive"),e.classList.add("bg-none","lexbutton"),this.captureInProgress=!1},openRecoverPasswordDialog(){this._lastOpenedDialog&&this._lastOpenedDialog.close();const t=new e.Dialog("Recover Password",e=>{e.addForm(null,{email:{label:"Email",value:"",icon:"AtSign"}},async(e,a,o)=>{try{await this.fs.account.createRecovery({email:e.email,url:window.location.href})&&(t.close(),k("✅ Recovery email sent",`Please check your email (${e.email}) for further instructions.`))}catch(e){n.set(`❌ ${e}`)}},{primaryActionName:"Continue",secondaryButtonClass:"ghost",secondaryActionName:"Cancel",secondaryActionCallback:()=>{t.close()}});const n=e.addTextArea(null,"",null,{inputClass:"text-card-foreground",disabled:!0,fitHeight:!0})},{modal:!0});this._lastOpenedDialog=t},openUpdatePasswordRecoverDialog(t,n){this._lastOpenedDialog&&this._lastOpenedDialog.close();const a=new e.Dialog("Update Password",e=>{const o={password:{label:"New password",value:"",type:"password",icon:"Key",pattern:{minLength:8,digit:!0}},confirmPassword:{label:"Confirm new password",value:"",type:"password",icon:"Key",pattern:{fieldMatchName:"password"}}};e.addForm(null,o,async(e,o,s)=>{await this.fs.account.updateRecovery({userId:t,secret:n,password:e.password}),a.close(),k("✅ Password updated","You can now login with your new password.")},{primaryActionName:"Continue",secondaryButtonClass:"ghost",secondaryActionName:"Cancel",secondaryActionCallback:()=>{a.close()}})},{modal:!0});this._lastOpenedDialog=a},openLoginDialog(){this._lastOpenedDialog&&this._lastOpenedDialog.close();const t=new e.Dialog("Login",e=>{const n=e.addForm(null,{email:{label:"Email",value:"",icon:"AtSign"},password:{label:"Password",icon:"Key",value:"",type:"password"}},async(e,a,o)=>{n.syncInputs(),await this.fs.login(e.email,e.password,async(e,n)=>{t.close(),await this.onLogin(e)},e=>{k("❌ Error",e,-1)})},{primaryActionName:"Login",secondaryButtonClass:"ghost",secondaryActionName:"Cancel",secondaryActionCallback:()=>{t.close()}});e.addSeparator(),e.addButton(null,"Forgot my password",async()=>{this.openRecoverPasswordDialog()},{buttonClass:"link"}),e.sameLine(),e.addLabel("Still no account?",{inputClass:"text-center"}),e.addButton(null,"Sign up",async()=>{this.openSignUpDialog()},{buttonClass:"link"}),e.endLine()},{size:["24rem",null],modal:!0});this._lastOpenedDialog=t},openSignUpDialog(){this._lastOpenedDialog&&this._lastOpenedDialog.close();const t=new e.Dialog("Create account",e=>{const n={userName:{label:"Username",value:"",icon:"User",pattern:{minLength:3}},name:{label:"Display Name (optional)",value:""},email:{label:"Email",value:"",icon:"AtSign",pattern:{email:!0}},password:{label:"Password",value:"",type:"password",icon:"Key",pattern:{minLength:8,digit:!0}},confirmPassword:{label:"Confirm password",value:"",type:"password",icon:"Key",pattern:{fieldMatchName:"password"}}};e.addForm(null,n,async(e,n,o)=>{n.length>0?a.set(n.map(e=>`${e.entry}: ${e.messages.join("\n")}`).join("\n\n")):(k("✅ Account created!",`You can now login with your email: ${e.email}`),await this.fs.createAccount(e.email,e.password,e.userName,async n=>{t.close(),L(),k("✅ Account created!",`You can now login with your email: ${e.email}`),await this.fs.createDocument(c.USERS_COLLECTION_ID,{user_id:n.$id,user_name:e.userName,display_name:e.name.length?e.name:void 0}),this.openLoginDialog()},e=>{a.set(`❌ ${e}`)}))},{primaryActionName:"SignUp",secondaryButtonClass:"ghost",secondaryActionName:"Cancel",secondaryActionCallback:()=>{t.close()}});const a=e.addTextArea(null,"",null,{inputClass:"text-card-foreground",disabled:!0,fitHeight:!0})},{modal:!0});this._lastOpenedDialog=t},openShaderSettingsDialog(t){this._lastOpenedDialog&&this._lastOpenedDialog.close();let n=!1;const a=new e.Dialog("Shader Settings",e=>{e.addCheckbox("Public",t.public??!0,e=>{n=!0,t.public=e},{className:"primary"}),e.addCheckbox("Allow Remix",t.remixable??!0,e=>{n=!0,t.remixable=e},{className:"primary"}),e.addSeparator(),e.sameLine(2),e.addButton(null,"Discard Changes",()=>a.close(),{width:"50%",buttonClass:"destructive"}),e.addButton(null,"Save Shader",async()=>{n&&(await this.fs.updateDocument(c.SHADERS_COLLECTION_ID,t.$id,{public:t.public??!0,remixable:t.remixable??!0}),k("✅ Shader updated",`Shader: ${t.name} by ${this.fs.user.name}`),n=!1,a.close())},{width:"50%",buttonClass:"primary"})},{modal:!1});this._lastOpenedDialog=a},async openCurrentShaderLikesDialog(t){this._lastOpenedDialog&&this._lastOpenedDialog.close();const n=await this.fs.listDocuments(c.INTERACTIONS_COLLECTION_ID,[I.equal("type","like"),I.equal("shader_id",t.uid),I.limit(300),I.orderDesc("$createdAt")]);if(0===n.total){const t=new e.Dialog(null,n=>{n.root.className=e.mergeClass(n.root.className,"pad-2xl flex flex-col gap-2"),e.makeContainer(["100%","100%"],"text-lg font-medium text-foreground p-2","This shader doesn't have likes yet.",n),n.addTextArea(null,"Share this shader so other people can check it and leave a like!",null,{disabled:!0,fitHeight:!0,inputClass:"bg-none text-sm text-muted-foreground"}),n.addSeparator(),n.addButton(null,"Close",()=>{t.destroy()},{buttonClass:"h-8 ghost"})},{modal:!0});return void(this._lastOpenedDialog=t)}const a=Array.from(new Set(n.documents.map(e=>e.author_id))),o=await this.fs.listDocuments(c.USERS_COLLECTION_ID,[I.equal("user_id",a)]),s=new e.Dialog(`${n.total} like${n.total>1?"s":""}`,t=>{const a=e.makeContainer(["100%","auto"],"flex flex-col p-2 gap-2 max-h-64 overflow-scroll","",t);for(const t of n.documents){const n=t.author_id,s=o.documents.find(e=>e.user_id===n),i=s.user_name,r=new e.Avatar({imgSource:s.avatar,fallback:i[0].toUpperCase(),className:"mx-2 flex-auto-keep"});e.makeContainer(["100%","auto"],"flex flex-row items-center gap-1",`\n                    ${r.root.outerHTML}\n                    <span>${s.user_name}</span>\n                `,a)}t.addSeparator(),t.addButton(null,"Close",()=>s.close(),{buttonClass:"h-8 ghost"})},{modal:!0});this._lastOpenedDialog=s},openShareiFrameDialog(t){this._lastOpenedDialog&&this._lastOpenedDialog.close();let n=!0;const a=new e.Dialog("Share this Shader",a=>{{a.addTextArea(null,"Direct link - Just copy and paste the URL below:",null,{inputClass:"text-card-foreground",disabled:!0,fitHeight:!0});const n=`${window.location.origin}${window.location.pathname}?shader=${t.$id}`;a.addTextArea(null,n,null,{disabled:!0,fitHeight:!0});const o=a.addButton(null,"Copy Shader URL",async()=>{navigator.clipboard.writeText(n),o.root.querySelector("input[type='checkbox']").style.pointerEvents="none",e.doAsync(()=>{o.swap(!0),o.root.querySelector("input[type='checkbox']").style.pointerEvents="auto"},3e3)},{swap:"Check",icon:"Copy",iconPosition:"start",title:"Copy Shader URL",tooltip:!0});e.addClass(o.root.querySelector(".swap-on svg"),"text-success")}a.addSeparator();{a.addTextArea(null,"iFrame - Copy the code below to embed this shader in your website or blog:",null,{inputClass:"text-card-foreground",disabled:!0,fitHeight:!0}),a.addCheckbox("Show UI",n,e=>{n=e;const a=`<iframe src="${window.location.origin}${window.location.pathname}embed/?shader=${t.$id}${n?"":"&ui=false"}" frameborder="0" width="640" height="405" class="rounded-lg" allowfullscreen></iframe>`;s.set(a)},{className:"primary"});const o=`<iframe src="${window.location.origin}${window.location.pathname}embed/?shader=${t.$id}${n?"":"&ui=false"}" frameborder="0" width="640" height="405" class="rounded-lg" allowfullscreen></iframe>`,s=a.addTextArea(null,o,null,{disabled:!0,fitHeight:!0}),i=a.addButton(null,"Copy iFrame html",async()=>{navigator.clipboard.writeText(s.value()),i.root.querySelector("input[type='checkbox']").style.pointerEvents="none",e.doAsync(()=>{i.swap(!0),i.root.querySelector("input[type='checkbox']").style.pointerEvents="auto"},3e3)},{swap:"Check",icon:"Copy",iconPosition:"start",title:"Copy iFrame html",tooltip:!0});e.addClass(i.root.querySelector(".swap-on svg"),"text-success")}},{modal:!1});this._lastOpenedDialog=a},async openAvailableChannels(t,n){if(this._lastOpenedDialog&&this._lastOpenedDialog.close(),this._dbAssets||(this._dbAssets=await this.fs.listDocuments(c.ASSETS_COLLECTION_ID,[])),0===this._dbAssets.total)return void e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","No data found.",container);const a=async(n,a)=>{const o=this._dbAssets.documents.filter(e=>e.category===n),s=["Keyboard",...$.shader?.passes.map(e=>e.name)??[]];for(const r of o){if("misc"===n&&!s.includes(r.name))continue;const o=e.makeElement("li","relative flex rounded-lg bg-card box-border hover:bg-accent overflow-hidden","",a);o.style.maxHeight="200px";const l=e.makeElement("img","w-full h-full rounded-t-lg bg-card hover:scale-105 transition-transform ease-out border-none cursor-pointer","",o);l.crossOrigin="anonymous";const c=r.file_id;if(c&&this._dbAssetsCache.has(c))l.src=this._dbAssetsCache.get(c);else{const e=r.local_url,t=r.preview,n=e??(t?await this.fs.getFileUrl(t):c?await this.fs.getFileUrl(c):$.shaderPreviewPath),a=new Image;a.crossOrigin="anonymous",a.src=n,a.onload=async()=>{const t=e??URL.createObjectURL(await(await fetch(n)).blob());this._dbAssetsCache.set(c,t),l.src=t}}e.makeContainer(["100%","auto"],"absolute text-xs top-0 p-2 w-full rounded-t-lg bg-background-blur backdrop-blur-xs items-center select-none font-semibold keep-all",`\n                    ${r.name} (uint8)\n                `,o),o.addEventListener("click",async e=>{e.preventDefault(),$.addUniformChannel(t,this._currentChannelIndex,{id:c??r.name,category:n}),await this.updateShaderChannelsView(t,this._currentChannelIndex),i.close()})}},o=new e.Area({skipAppend:!0}),s=o.addTabs({parentClass:"bg-card p-4",sizes:["auto","auto"],contentClass:"bg-card p-4 pt-0"});this.texturesContainer||(this.texturesContainer=e.makeContainer(["100%","100%"],"grid channel-server-list gap-3 p-2 rounded-lg justify-center overflow-scroll")),this.texturesContainer.innerHTML="",await a("texture",this.texturesContainer),this.texturesContainer.style.display="grid",s.add("Textures",this.texturesContainer,{selected:!0}),this.miscContainer||(this.miscContainer=e.makeContainer(["100%","100%"],"grid channel-server-list gap-3 p-2 rounded-lg justify-center overflow-scroll")),this.miscContainer.innerHTML="",await a("misc",this.miscContainer),this.miscContainer.style.display="grid",s.add("Misc",this.miscContainer),this.cubemapsContainer||(this.cubemapsContainer=e.makeContainer(["100%","100%"],"grid channel-server-list gap-3 p-2 rounded-lg justify-center overflow-scroll")),this.cubemapsContainer.innerHTML="",await a("cubemap",this.cubemapsContainer),this.cubemapsContainer.style.display="grid",s.add("Cubemaps",this.cubemapsContainer),this.soundsContainer||(this.soundsContainer=e.makeContainer(["100%","100%"],"grid channel-server-list gap-3 p-2 rounded-lg justify-center overflow-scroll")),this.soundsContainer.innerHTML="",await a("sound",this.soundsContainer),this.soundsContainer.style.display="grid",s.add("Sound",this.soundsContainer),this._currentChannelIndex=n;let i=new e.Dialog(`[${t.name}] Channel${n}`,e=>{e.root.classList.remove("break-all"),e.attach(o)},{modal:!1,close:!0,minimize:!1,size:[`${Math.min(1280,window.innerWidth-64)}px`,"530px"],draggable:!0});this._lastOpenedDialog=i},async updateShaderChannelsView(n,a){n=n??$.currentPass,this.toggleShaderChannelsView("common"===n.type);const o=async a=>{const o=n.channels[a],s=this.channelsContainer.children[a];s&&this.channelsContainer.removeChild(s);const i=e.makeContainer(["100%","100%"],"relative text-center content-center box-shadow box-border rounded-lg bg-card hover:bg-accent cursor-pointer overflow-hidden","");i.style.minHeight="100px",e.insertChildAtIndex(this.channelsContainer,i,a);const r=e.makeElement("img","w-full rounded-lg bg-card hover:bg-accent hover:scale-105 transition-transform ease-out border-none","",i);r.src=t;const l=await $.getChannelMetadata(n,a),c=n?.channels?.[a]?.id;if(c&&!l?.url.includes("base64"))if(this._dbAssetsCache.has(c))r.src=this._dbAssetsCache.get(c);else{const e=new Image;e.crossOrigin="anonymous",e.src=l?.url,e.onload=async()=>{const e=URL.createObjectURL(await(await fetch(l?.url)).blob());this._dbAssetsCache.set(c,e),r.src=e}}if(e.makeContainer(["100%","auto"],"p-2 absolute bg-background-blur backdrop-blur-xs text-xs text-center content-center top-0 rounded-t-lg pointer-events-none",l?.name?`<span class="font-semibold">${l.name}</span> (iChannel${a})`:`iChannel${a}`,i),o){const t=e.makeContainer(["100%","auto"],"flex flex-row absolute bg-background-blur backdrop-blur-xs text-xs text-center content-center justify-end bottom-0 rounded-b-lg","",i),n=new e.Panel({className:"w-fit m-0 p-0"});t.appendChild(n.root),n.sameLine(),"sound"===o.category&&(n.addButton(null,"PlayButton",(e,t)=>$.playSoundUniformChannel(a),{icon:"Pause",swap:"Play",title:"Play/Pause Channel",tooltip:!0,className:"p-0",buttonClass:"sm ghost"}),n.addButton(null,"RewindButton",(e,t)=>$.rewindSoundUniformChannel(a),{icon:"Rewind",title:"Rewind Channel",tooltip:!0,className:"p-0",buttonClass:"sm ghost"}),n.addButton(null,"MuteButton",(e,t)=>$.muteSoundUniformChannel(a),{icon:"Volume2",swap:"VolumeOff",title:"Mute Channel",tooltip:!0,className:"p-0",buttonClass:"sm ghost"})),n.addButton(null,"ChannelOptionsButton",async(t,n)=>{n.preventDefault(),n.stopPropagation(),e.addDropdownMenu(n.target,[{name:"Remove",className:"destructive",callback:async()=>await $.removeUniformChannel(a)}],{side:"top",align:"end"})},{icon:"Settings",title:"Channel Options",tooltip:!0,className:"p-0",buttonClass:"pointer-events-auto sm ghost"}),n.endLine("justify-end")}r.addEventListener("click",async e=>{e.preventDefault(),await this.openAvailableChannels(n,a)})};if(void 0===a){for(let e=0;e<4;e++)await o(e);console.log("Channels view updated.")}else await o(a)},toggleShaderChannelsView(e){this._shaderSettingsArea.root.classList.toggle("hidden",e)}};window.ui=B;const N=new c,O=new class{constructor(){this.frame=0,this.to=0,this.fps=0}reset(){this.frame=0,this.to=0,this.fps=60}get(){return Math.floor(this.fps)}count(e){return this.frame++,e-this.to>500&&(this.fps=1e3*this.frame/(e-this.to),this.frame=0,this.to=e,!0)}},z=Appwrite.Query,$={version:"0.16",keyState:new Map,keyToggleState:new Map,keyPressed:new Map,audioPlaying:{},mousePosition:[0,0],lastMousePosition:[0,0],frameCount:0,lastTime:0,elapsedTime:0,capturer:null,generateKbTexture:!0,timePaused:!1,manualCompile:!1,previewNamePrefix:"_preview_",imagesRootPath:"/images/",async init(){this.audioContext=new AudioContext({sampleRate:48e3}),this.shaderPreviewPath=`${this.imagesRootPath}/shader_preview.png`;const e=new URLSearchParams(window.location.search).get("r");this.backend="gpu"===e?"webgpu":"gl"===e?"webgl":navigator.gpu?"webgpu":"webgl","gpu"!==e||navigator.gpu||(console.warn("WebGPU forced but not available, falling back to WebGL"),this.backend="webgl"),await N.detectAutoLogin(),await B.init(N)},async onFrame(){const t=e.getTime();this.timeDelta=(t-this.lastTime)/1e3,O.count(t),this.timePaused||(this.renderer.updateFrame(this.timeDelta,this.elapsedTime,this.frameCount,this.shader),this.elapsedTime+=this.timeDelta,this.frameCount++,e.emitSignal("@elapsed-time",`${this.elapsedTime.toFixed(2)}s`),e.emitSignal("@fps",`${O.get()} FPS`)),this.renderer.updateResolution(this.resolutionX,this.resolutionY,this.shader);{const e=[this.mousePosition[0],this.mousePosition[1],this.lastMousePosition[0],this.lastMousePosition[1],this.lastMousePosition[0]-this.mousePosition[0],this.lastMousePosition[1]-this.mousePosition[1],this._mouseDown??-1,this._mousePressed??-1];this.renderer.updateMouse(e,this.shader)}this.lastTime=t;for(let e=0;e<this.shader.passes.length;++e){const t=this.shader.passes[e];if("common"!==t.type){for(let e=0;e<t.channels?.length;++e){const n=t.channels[e];if(!n)continue;const a=n.id;this.renderer.gpuTextures[a]||("Keyboard"===a?await this.createKeyboardTexture(e):a.startsWith("Buffer")?await this.loadBufferChannel(t,a,e):await this.createTextureFromFile(a)),t.setChannelTexture(e,this.renderer.gpuTextures[a])}t.uniformsDirty&&t.updateUniforms(),this._lastShaderCompilationWithErrors||this._compilingShader||await t.execute(this.renderer)}}if(this._anyKeyPressed){for(const[e,t]of this.keyPressed)this.keyPressed.set(e,!1);await this.createKeyboardTexture(),this._anyKeyPressed=!1}for(const e in this.audioPlaying){const t=this.audioPlaying[e].audio,n=t.id??"";if(!t.paused)for(let e=0;e<this.shader.passes.length;++e){const a=this.shader.passes[e];if("common"===a.type)continue;a.channels.findIndex(e=>e?.id===n)>-1&&await this.createAudioTexture(null,n,t.name)}}this._mousePressed=void 0,this.capturer&&(this.capturer.capture(this.renderer.canvas),this.captureFrameCount++,this.captureFrameCount==this.exportFramesCount&&this.saveCapture()),requestAnimationFrame(this.onFrame.bind(this))},async onKeyDown(e){this.keyState.set(T(e.code),!0),this.generateKbTexture&&await this.createKeyboardTexture(),this.generateKbTexture=!1},async onKeyUp(e){this.keyState.set(T(e.code),!1),this.keyToggleState.set(T(e.code),!this.keyToggleState.get(T(e.code))),this.keyPressed.set(T(e.code),!0),this._anyKeyPressed=!0,await this.createKeyboardTexture(),this.generateKbTexture=!0},async onMouseDown(e,t,n){this._mouseDown=parseInt(n),this._mousePressed=this._mouseDown,this.mousePosition=[e,this.resolutionY-t],this.lastMousePosition=[...this.mousePosition]},async onMouseUp(e){this._mouseDown=void 0},async onMouseMove(e,t){void 0!==this._mouseDown&&(this.mousePosition=[e,this.resolutionY-t])},async onShaderCanvasResized(t,n){this.resizeBuffers(t,n),this.renderer.updateResolution(t,n,this.shader),e.emitSignal("@resolution",`${t}x${n}`),this.resolutionX=t,this.resolutionY=n},async onShaderEditorCreated(t,n){this.shader=t,await this.initGraphics(n);const a="webgpu"===this.backend?m:f,o="webgpu"===this.backend?h:g;if(this.shader.url){const n=JSON.parse(await N.requestFile(this.shader.url,"text"));console.assert(n,"DB: No JSON Shader data available!"),this.shader._json=e.deepCopy(n);for(const o of n.passes??[]){o.resolutionX=this.resolutionX,o.resolutionY=this.resolutionY,o.uniforms=o.uniforms??[],o.uniforms.forEach(e=>{e.type=e.type??"f32",e.step=e.step??.1});const n=new a(t,this.renderer,o);if("buffer"!==o.type&&"compute"!==o.type||(console.assert(n.textures,"Buffer does not have render target textures"),this.renderer.gpuTextures[o.name]=n.textures),this.shader.passes.push(n),B.editor.addTab(o.name,{selected:!1,title:o.name,text:o.codeLines.join("\n"),language:"WGSL"}),"MainImage"!==o.name){const t=e.makeIcon("X",{iconClass:"ml-2"});e.asTooltip(t,"Delete file"),t.addEventListener("click",this.onShaderPassDeleted.bind(this,o.name)),B.editor.tabs.tabDOMs[o.name].appendChild(t)}}}else{const e={name:"MainImage",type:"image",codeLines:o.RENDER_MAIN_TEMPLATE,resolutionX:this.resolutionX,resolutionY:this.resolutionY},n=new a(t,this.renderer,e);this.shader.passes.push(n),B.editor.addTab(e.name,{selected:!1,title:e.name,text:e.codeLines.join("\n"),language:"WGSL"})}this.currentPass=this.shader.passes.at(-1);const s=await N.listDocuments(c.INTERACTIONS_COLLECTION_ID,[z.equal("type","like"),z.equal("shader_id",this.shader.uid??"")]),i=s.documents.filter(e=>e.author_id===(N.user?N.getUserId():"")),r=(N?.user&&i.length>0)??!1;e.emitSignal("@on_like_changed",[s.total,r]),this.shader.uid&&"EMPTY_ID"!==this.shader.uid&&this.recordShaderView(this.shader.uid),B.editor.loadTab(this.currentPass.name),B.editor.setLanguage(this.renderer.lang)},onShaderPassCreated(t,n){let a=-1;const o=new("webgpu"===this.backend?m:f)(this.shader,this.renderer,{name:n,type:t,resolutionX:this.resolutionX,resolutionY:this.resolutionY}),s=()=>{const e=this.shader.passes.filter(e=>"buffer"===e.type||"compute"===e.type).map(e=>e.name),t=["BufferA","BufferB","BufferC","BufferD"];for(const n of t)if(!e.includes(n))return n;return null};"buffer"===t||"compute"===t?(a=-2,n=o.name=s(),this.shader.passes.splice(this.shader.passes.length-1,0,o),console.assert(o.textures,"Buffer/Compute pass does not have render target textures"),this.renderer.gpuTextures[n]=o.textures):"common"===t&&(a=-(this.shader.passes.length+1),this.shader.passes.splice(0,0,o)),B.editor.addTab(n,{indexOffset:a,language:"WGSL",selected:!0,title:n,text:o.codeLines.join("\n")}),e.doAsync(async()=>{const t=e.makeIcon("X",{iconClass:"ml-2"});e.asTooltip(t,"Delete file"),t.addEventListener("click",this.onShaderPassDeleted.bind(this,n)),B.editor.tabs.tabDOMs[n].appendChild(t),this.onShaderPassSelected(n),await this.compileShader(!1,o)},10)},async onShaderPassSelected(e){this.currentPass=this.shader.passes.find(t=>t.name===e),console.assert(this.currentPass,`Cannot find pass ${e}`),await B.updateShaderChannelsView(),B.renderUniformsView(this.currentPass),this.updateCurrentSuggestions()},async onShaderPassDeleted(e,t){t.preventDefault(),t.stopPropagation(),B.editor.tabs.delete(e),document.body.querySelectorAll(".lextooltip").forEach(e=>e.remove());{const t=this.shader.passes.findIndex(t=>t.name===e),n=this.shader.passes[t];"buffer"===n.type&&delete this.renderer.gpuTextures[n.name],this.shader.passes.splice(t,1),await this.compileShader()}},async onShaderLike(t){t=t??this.shader.uid;const n=N.getUserId(),a=B.dbUser;console.assert(a);const o=a.liked_shaders,s=o.indexOf(t),i=-1!==s;if(i){o.splice(s,1);const e=await N.listDocuments(c.INTERACTIONS_COLLECTION_ID,[z.equal("type","like"),z.equal("author_id",n),z.equal("shader_id",t)]);if(0===e.total)console.warn("Weird, no like interaction found to delete!");else{const t=e?.documents[0];await N.deleteDocument(c.INTERACTIONS_COLLECTION_ID,t.$id)}}else o.push(t),await N.createDocument(c.INTERACTIONS_COLLECTION_ID,{type:"like",author_id:n,shader_id:t});const r=await N.listDocuments(c.INTERACTIONS_COLLECTION_ID,[z.equal("type","like"),z.equal("shader_id",t)]);await N.updateDocument(c.SHADERS_COLLECTION_ID,t,{like_count:r.total}),await N.updateDocument(c.USERS_COLLECTION_ID,a.$id,{liked_shaders:o});const l=[r.total,!i,t];return e.emitSignal("@on_like_changed",l),l},async recordShaderView(e){const t=`viewed_${e}`,n=localStorage.getItem(t);if(!(n&&Date.now()-parseInt(n)<36e5)){localStorage.setItem(t,Date.now());try{const t=await N.getDocument(c.SHADERS_COLLECTION_ID,e);await N.updateDocument(c.SHADERS_COLLECTION_ID,e,{view_count:(t.view_count??0)+1})}catch(e){}}},onShaderTimePaused(){this.timePaused=!this.timePaused;for(const e in this.audioPlaying){const t=this.audioPlaying[e].audio;this.timePaused?t.pause():t.play()}},onShaderTimeReset(){O.reset(),this.frameCount=0,this.elapsedTime=0,this.timeDelta=0,this.renderer.updateFrame(0,0,0,this.shader);{const e=this.resolutionX??this.renderer.canvas.offsetWidth,t=this.resolutionY??this.renderer.canvas.offsetHeight;this.mousePosition=[.5*e,.5*t],this.lastMousePosition=this.mousePosition,this._mouseDown=void 0,this._mousePressed=void 0;const n=[this.mousePosition[0],this.mousePosition[1],this.lastMousePosition[0],this.lastMousePosition[1],this.lastMousePosition[0]-this.mousePosition[0],this.lastMousePosition[1]-this.mousePosition[1],this._mouseDown??-1,this._mousePressed??-1];this.renderer.updateMouse(n,this.shader)}this.currentPass&&this.currentPass.resetExecution(),e.emitSignal("@elapsed-time",`${this.elapsedTime.toFixed(2)}s`)},async getShaderById(t){let n=null;if("new"!==t){let a;try{a=await N.getDocument(c.SHADERS_COLLECTION_ID,t)}catch(t){return void e.makeContainer(["100%","auto"],"mt-8 text-2xl font-medium justify-center text-center","No shader found.",this.area)}n={name:a.name,uid:t,url:await N.getFileUrl(a.file_id),description:a.description??"",creationDate:_(a.$createdAt),originalId:a.original_id,tags:a.tags,backend:a.backend};const o=a.author_id;if(N.user&&o===N.getUserId())n.author=B.dbUser.user_name,n.authorId=B.dbUser.user_id;else if(o){const e=(await N.listDocuments(c.USERS_COLLECTION_ID,[z.equal("user_id",o)])).documents[0].user_name;n.author=e,n.authorId=o}else n.author=a.author_name,n.anonAuthor=!0}else n={name:"New Shader",uid:"EMPTY_ID",author:N.user?.name??"Anonymous",authorId:N.user?N.getUserId():void 0,anonAuthor:!N.user,creationDate:C(),tags:[]};return new("webgpu"===this.backend?h:g)(n)},async getChannelMetadata(e,n){const a=e.channels[n];let o=a?.id,s=null,i=a?.category;if(e){const e=a?.id;if(e)if("Keyboard"===e)s=`${$.imagesRootPath}/keyboard.png`;else if(e.startsWith("Buffer"))s=`${$.imagesRootPath}/buffer.png`;else if(e.startsWith("Compute"))s=`${$.imagesRootPath}/buffer.png`;else{const n=await N.listDocuments(c.ASSETS_COLLECTION_ID,[z.equal("file_id",e)]);if(0==n.total)return;const a=n.documents[0];o=a.name,i=a.category;const r="sound"===i?`${$.imagesRootPath}/sound.png`:a.preview;s=r?r.includes("/")?r:await N.getFileUrl(r):"cubemap"===i||"sound"===i?t:await N.getFileUrl(e)}else s=t}else s=t;return{url:s,name:o,category:i}},resizeBuffers(e,t){for(const n of this.shader.passes)"buffer"!==n.type&&"compute"!==n.type||n.resizeBuffer(e,t)},requestFullscreen(e){null==(e=e??this.renderer.canvas)&&(e=document.documentElement),e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),e.focus&&e.focus()},isFullScreen:()=>document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement,exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},getFullPath:(e=!0)=>window.location.origin+(e?window.location.pathname:""),getCodeSymbolValue(e){const t=e=>`<span class="text-info font-code text-xs">(${l[e]})</span>`,n=e=>`<span class="font-medium">${e}</span>`;if("iTime"==e)return`${t("f32")} ${n(this.elapsedTime.toFixed(3))}`;if("iTimeDelta"==e)return`${t("f32")} ${n(this.timeDelta.toFixed(3))}`;if("iFrame"==e)return`${t("i32")} ${n(this.frameCount.toString())}`;if("iResolution"==e)return`${t("vec2f")} ${n(`${this.resolutionX}, ${this.resolutionY}`)}`;if("iMouse"==e)return[`${t("vec2f")} pos: ${n(`${this.mousePosition[0]}, ${this.mousePosition[1]}`)}`,`${t("vec2f")} start: ${n(`${this.lastMousePosition[0]}, ${this.lastMousePosition[1]}`)}`,`${t("vec2f")} delta: ${n(`${this.lastMousePosition[0]-this.mousePosition[0]}, ${this.lastMousePosition[1]-this.mousePosition[1]}`)}`,`${t("f32")} press: ${n(`${this._mouseDown??-1}`)}`,`${t("f32")} click: ${n(`${this._mousePressed??-1}`)}`].join("<br>");if(!this.currentPass)return null;const a=this.currentPass.uniforms.find(t=>t.name===e);if(a)return`${t(a.type)} ${n(a.value)}`;const o=this.currentPass.defines[e];return void 0!==o?`${n(o)}`:null},getCurrentSuggestions(){const e=[];i.forEach(t=>{t.startsWith("iChannel")?e.push("iChannel"):e.push(t)}),e.push("nearestSampler","bilinearSampler","trilinearSampler","nearestRepeatSampler","bilinearRepeatSampler","trilinearRepeatSampler"),e.push("keyDown","keyPressed","keyState"),this.currentPass&&e.push(...this.currentPass.uniforms.map(e=>e.name));const t="webgpu"===this.backend,n=t?b:A;let a=null;if(t);else{e.push(...y.map(e=>e.name)),e.push(...w.map(e=>e.name));const t=e=>[...e.matchAll(/(?:float|vec[234]|mat[234]|int|uint|void|bool)\s+(\w+)\s*\(/g)],n=e=>{var n;return(null==(n=t(e).pop())?void 0:n[1])??""};a=(e,t,a)=>{const o=n(t.code),s=o?t.label?`${o} (${t.label})`:o:t.label?`${a.name} (${t.label})`:a.name,i=["lib",o,a.name,t.label,e.name].filter(Boolean).join(" ");return{label:`${s}`,detail:a.description,insertText:t.code,icon:"BookOpenText",filterText:i,sortText:`3_${e.name}_${a.name}_${t.label}`}}}if(null!==a){const t=[];for(const e of n)for(const n of e.snippets){const o=n.options??[{label:"",code:n.code??""}];for(const s of o)t.push(a(e,s,n))}e.push(...t)}return e},updateCurrentSuggestions(){B.editor&&B.editor.setCustomSuggestions(this.getCurrentSuggestions())},getShaderPreviewName(e){return`${this.previewNamePrefix}${e}.png`},async saveShaderFiles(t,n){const a={passes:(t?this.shader.passes:this.shader._json?.passes??this.shader.passes).map(e=>({name:e.name,type:e.type,codeLines:e.codeLines,channels:e.channels,uniforms:e.uniforms}))},o=JSON.stringify(a),s=(new TextEncoder).encode(o),i=`${e.toCamelCase(n??this.shader.name)}_${e.guidGenerator()}.json`,r=new File([s],i,{type:"text/plain"});return(await N.createFile(r)).$id},async saveShader(t,n=!0,a=!0){if(!N.user)return void console.warn("Login to save your shader!");if(t)return void this.overrideShader(t,n,a);const o=new e.Dialog("Confirm Shader Data",t=>{let n=this.shader.name,a=!1,s=!0;const i=t.addText("Name",n,e=>{n=e},{pattern:e.buildTextPattern({minLength:3})});t.addSeparator(),t.addCheckbox("Public",a,e=>{a=e},{nameWidth:"50%",className:"primary"}),t.addCheckbox("Allow Remix",s,e=>{s=e},{nameWidth:"50%",className:"primary"}),t.sameLine(2),t.addButton(null,"Cancel",()=>o.close(),{width:"50%",buttonClass:"destructive"}),t.addButton(null,"Confirm",async()=>{if(!n.length||!i.valid(n))return;this.shader.name=n;const e=this.shader.authorId===N.getUserId(),t=await this.saveShaderFiles(e),r=await N.createDocument(c.SHADERS_COLLECTION_ID,{name:n,description:this.shader.description,author_id:N.getUserId(),author_name:this.shader.author??"",file_id:t,like_count:0,features:this.shader.getFeatures(),remixable:s,public:a,tags:this.shader.tags,backend:this.backend});this.shader.uid=r.$id,await this.updateShaderPreview(this.shader.uid,!1),o.close(),k("✅ Shader saved",`Shader: ${n} by ${N.user.name}`)},{width:"50%",buttonClass:"primary"})})},async overrideShader(e,t=!0,n=!0){const a=e.file_id;await N.deleteFile(a);const o=this.shader.authorId===N.getUserId(),s={file_id:await this.saveShaderFiles(o)};o&&(s.name=this.shader.name,s.description=this.shader.description,s.features=this.shader.getFeatures(),t&&await this.updateShaderPreview(this.shader.uid,!1)),await N.updateDocument(c.SHADERS_COLLECTION_ID,this.shader.uid,s),o&&n&&k("✅ Shader updated",`Shader: ${this.shader.name} by ${N.user.name}`)},async deleteShader(t){const n=this.shader?.uid??t?.uid,a=this.shader?.name??t?.name;if(!n||!a)return void console.error("Can't delete shader, uid or name missing.");let o=await this.shaderExists(n);if(!o)return void console.error("Can't delete shader, uid does not exist in DB.");const s=async()=>{await N.deleteDocument(c.SHADERS_COLLECTION_ID,n),await N.deleteFile(o.file_id),o=await N.listFiles([z.equal("name",this.getShaderPreviewName(n))]),o.total>0&&await N.deleteFile(o.files[0].$id),i.destroy(),k("✅ Shader deleted",`Shader: ${a} by ${N.user.name}`)},i=new e.Dialog(`Delete shader: ${a}`,e=>{e.root.classList.add("p-2"),e.addTextArea(null,"Are you sure? This action cannot be undone.",null,{disabled:!0}),e.addSeparator(),e.sameLine(2),e.addButton(null,"Cancel",()=>i.close(),{width:"50%",buttonClass:"destructive"}),e.addButton(null,"Continue",s.bind(this),{width:"50%",buttonClass:"primary"})},{modal:!0})},async remixShader(){const e=this.shader.uid,t=`${this.shader.name}_remix`,n=await this.saveShaderFiles(!1,t),a=await N.createDocument(c.SHADERS_COLLECTION_ID,{name:this.shader.name,author_name:N.user.name,author_id:N.getUserId(),original_id:e,file_id:n,description:this.shader.description,like_count:0,remixable:!0,public:!0});await this.updateShaderPreview(a.$id,!1),B._openShader(a.$id)},filterShaders(e,t){const n=t&&"#"===t[0];return e.map(e=>{let a=0;if(n){const n=t.substring(1);a=(e.tags??[]).includes(n)?1:0}else if(t){const n=e.name.toLowerCase(),o=(e.description||"").toLowerCase(),s=(e.author_name||"").toLowerCase(),i=t.toLowerCase().split(/\s+/);for(const e of i)n.includes(e)&&(a+=6),o.includes(e)&&(a+=3),s.includes(e)&&(a+=1)}return{...e,score:a}}).sort((e,t)=>t.score-e.score)},async updateShaderPreview(e,t=!0){e=e??this.shader.uid;const n=this.getShaderPreviewName(e),a=await N.listFiles([z.equal("name",n)]);if(a.total>0){const e=a.files[0].$id;await N.deleteFile(e)}const o=await this.snapshotCanvas(),s=new File([o],n,{type:"image/png"});await N.createFile(s),t&&k("✅ Shader preview updated",`Shader: ${this.shader.name} by ${N.user.name}`)},async initGraphics(e){const t="webgpu"===this.backend?v:p;this.renderer=new t(e,this.backend),await this.renderer.init(),requestAnimationFrame(this.onFrame.bind(this))},async startShaderPreview(t,n,a){const o="webgpu"!==a||navigator.gpu?a??this.backend:"webgl",s="webgpu"===o?v:p,i="webgpu"===o?m:f,r="webgpu"===o?h:g;t.width=320,t.height=180;const l=new s(t,o);await l.init();const c=await N.getFileUrl(n),d=JSON.parse(await N.requestFile(c,"text"));if(!d?.passes)return null;const u=new r({name:"preview_"+n,uid:"PREVIEW_ID"});u.passes=[];for(const e of d.passes??[]){e.resolutionX=320,e.resolutionY=180,e.uniforms=e.uniforms??[],e.uniforms.forEach(e=>{e.type=e.type??"f32",e.step=e.step??.1});const t=new i(u,l,e);"buffer"!==e.type&&"compute"!==e.type||(console.assert(t.textures,"Buffer does not have render target textures"),l.gpuTextures[e.name]=t.textures),u.passes.push(t)}const x=this;return{fileId:n,timeDelta:0,elapsedTime:0,frameCount:0,lastTime:0,clean:function(){this.mustClean=!0},frame:async function(){x.renderer=l;const t=e.getTime();this.timeDelta=(t-this.lastTime)/1e3,this.mustClean&&(this.timeDelta=0,this.mustClean=!1),l.updateFrame(this.timeDelta,this.elapsedTime,this.frameCount,u),l.updateResolution(320,180,u),this.elapsedTime+=this.timeDelta,this.frameCount++,this.lastTime=t;for(let e=0;e<u.passes.length;++e){const t=u.passes[e];if("common"!==t.type){for(let e=0;e<t.channels?.length;++e){const n=t.channels[e];if(!n)continue;const a=n.id;l.gpuTextures[a]||("Keyboard"===a?await x.createKeyboardTexture(e):a.startsWith("Buffer")?await x.loadBufferChannel(t,a,e):await x.createTextureFromFile(a)),t.setChannelTexture(e,l.gpuTextures[a])}t.uniformsDirty&&t.updateUniforms(),x._lastShaderCompilationWithErrors||x._compilingShader||await t.execute(l)}}x.rafId=requestAnimationFrame(x.raf)}}},async createTextureFromFile(e){const t=await N.listDocuments(c.ASSETS_COLLECTION_ID,[z.equal("file_id",e)]);if(0==t.total)return;const n=await N.getFileUrl(e),a=await N.requestFile(n),o=t.documents[0];let s=null;return s="cubemap"===o.category?await this.renderer.createCubemapTextureFromImage(a,e,o.name):"sound"===o.category?await this.createAudioTexture(a,e,o.name):await this.renderer.createTextureFromImage(a,e,o.name),s},async createKeyboardTexture(e,t=!1){const n=[256,3],a=[];for(let e=0;e<n[0];e++)a.push(255*(!0===this.keyState.get(e)?1:0),0,0,255);for(let e=0;e<n[0];e++)a.push(255*(!0===this.keyToggleState.get(e)?1:0),0,0,255);for(let e=0;e<n[0];e++)a.push(255*(!0===this.keyPressed.get(e)?1:0),0,0,255);const o="Keyboard",s=new ImageData(new Uint8ClampedArray(a),n[0],n[1]),i=await createImageBitmap(s),r=this.renderer.gpuTextures[o]??this.renderer.createTexture({label:"KeyboardTexture",size:[i.width,i.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});this.renderer.gpuTextures[o]=this.renderer.updateTexture(r.texture??r,i);const l=this.currentPass,c=l.channels.findIndex(e=>e?.id===o);void 0===e&&c>-1&&(e=c),void 0!==e&&(l.channels[e]={id:o,category:"misc"},t&&await B.updateShaderChannelsView(l))},async createAudioTexture(e,t,n=""){const a=[512,2];if(!this.audioPlaying[t]){const a=new Blob([e],{type:"audio/mpeg"}),o=URL.createObjectURL(a),s=new Audio;s.src=o,s.crossOrigin="anonymous",s.preload="auto",s.id=t,s.name=n;const i=this.audioContext.createMediaElementSource(s),r=this.audioContext.createAnalyser(),l=this.audioContext.createGain();r.smoothingTimeConstant=.8,i.connect(r),r.connect(l),l.connect(this.audioContext.destination);const c=r.frequencyBinCount,d=new Uint8Array(c),u=new Uint8Array(c);this.audioPlaying[t]={audio:s,analyser:r,source:i,gain:l,freqData:d,timeData:u},s.play()}const o=this.audioPlaying[t];o.analyser.getByteFrequencyData(o.freqData),o.analyser.getByteTimeDomainData(o.timeData);const s=[];for(let e=0;e<a[0];e++){const t=o.freqData[e];s.push(t,t,t,255)}for(let e=0;e<a[0];e++){const t=o.timeData[e];s.push(t,t,t,255)}const i=t,r=new ImageData(new Uint8ClampedArray(s),a[0],a[1]),l=await createImageBitmap(r),c=this.renderer.gpuTextures[i]??this.renderer.createTexture({label:n,size:[l.width,l.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.renderer.gpuTextures[i]=this.renderer.updateTexture(c.texture??c,l),c},setEditorErrorBorder(t=0){B.editor.area.root.parentElement.classList.toggle("code-border-default",0===t),B.editor.area.root.parentElement.classList.toggle("code-border-success",1===t),B.editor.area.root.parentElement.classList.toggle("code-border-error",2===t),this._mustResetBorder||e.doAsync(()=>{this.setEditorErrorBorder(),this._mustResetBorder=!1},2e3),this._mustResetBorder=!0},async compileShader(t=!0,n,a=!1,o=!1){this._lastShaderCompilationWithErrors=!1,this._compilingShader=!0,B.editor._renderAllLines();const s=B.editor._openedTabs,i=n?[n]:this.shader.passes,r="common"===this.currentPass.type;L();for(let n=0;n<i.length;++n){const a=i[n];if(a.codeLines=s[a.name].doc._lines,console.assert(a.codeLines,`No tab with name ${a.name}`),"common"===a.type)continue;const o=await a.compile(this.renderer);if(0!==o)return r||B.editor.loadTab(a.name),e.doAsync(()=>{const n=o.code.split("\n").indexOf(a.codeLines[0]);console.assert(n>0);for(const i of o.messages){let l=0;if(r){const e=o.code.split("\n").indexOf("// Common pass code");l=i.lineNum-e-1}else l=i.lineNum-n;t&&(this.setEditorErrorBorder(2),k(`❌ ${e.toTitleCase(i.type)}: ${l}:${i.linePos}`,i.message,-1),s[a.name].dom.childNodes[l-1]?.classList.add("error"===i.type?"removed":"debug")),B.pushCompilationLog(a.name,i.type,i.message,l,i.linePos)}},10),this._lastShaderCompilationWithErrors=!0,1}return t&&this.setEditorErrorBorder(1),a&&this.renderer.canvas.focus(),this.manualCompile|=o??!1,this._compilingShader=!1,0},async shaderExists(e){try{return await N.getDocument(c.SHADERS_COLLECTION_ID,e??this.shader.uid)}catch(e){}},async loadBufferChannel(e,t,n,a=!1,o=!1){e.channels[n]={id:t,category:"misc"},o&&await this.compileShader(!0,e),a&&await B.updateShaderChannelsView(e)},updateUniformChannelFilter(e,t,n){const a=e.channels[t];a&&(a.filter=n,e.mustCompile=!0)},updateUniformChannelWrap(e,t,n){const a=e.channels[t];a&&(a.wrap=n,e.mustCompile=!0)},closeUniformChannel(e){if(e?.id&&this.renderer.gpuTextures[e.id]&&delete this.renderer.gpuTextures[e.id],"sound"===e.category&&this.audioPlaying[e.id]){const t=this.audioPlaying[e.id];t.audio.pause(),t.source.disconnect(),t.analyser.disconnect(),t.gain.disconnect(),delete this.audioPlaying[e.id]}},addUniformChannel(e,t,n){const a=e.channels[t];a&&this.closeUniformChannel(a),e.channels[t]=n,e.mustCompile=!0},async removeUniformChannel(e){const t=this.currentPass;if("Common"===t.name)return;const n=t.channels[e];this.closeUniformChannel(n),t.channels[e]=void 0,await B.updateShaderChannelsView(t),await this.compileShader(!0,t)},async addUniform(e,t,n,a,o){const s=this.currentPass;if("Common"===s.name)return;const i=e??`iUniform${s.uniforms.length+1}`;s.uniforms.push({name:i,type:"f32",value:t??0,min:n??0,max:a??1,step:o??.1});s.getShaderCode(!1).code.match(new RegExp(`\\b${i}\\b`))&&await this.compileShader(!0,s),this.updateCurrentSuggestions(),B.renderUniformsView(s)},async removeUniform(e,t){const n=e.uniforms[t].name,a=e.getShaderCode(!1).code;e.uniforms.splice(t,1),a.match(new RegExp(`\\b${n}\\b`))&&this.compileShader(!0,e),this.updateCurrentSuggestions(),B.renderUniformsView(e)},async updateUniformType(e,t,n){const a=n.startsWith("color");n=a?`vec${n[5]}f`:n,console.log(n);const o=e.uniforms[t];if(o.type=n,o.isColor=a,n.startsWith("vec")){o.step=o.type.includes("f")?.01:1;const e=h.GetUniformSize(n)/4;o.value=[].concat(o.value);for(let t=0;t<e;++t)o.value[t]=o.value[t]??(a&&3==t?1:0)}else o.step=o.type.includes("f")?.01:1,o.value=[].concat(o.value)[0];e.uniformBuffers.splice(t,1);e.getShaderCode(!1).code.match(new RegExp(`\\b${o.name}\\b`))&&this.compileShader(!0,e),B.renderUniformsView(e)},playSoundUniformChannel(e){const t=this.currentPass.channels[e];if(!t||"sound"!==t.category)return;const n=this.audioPlaying[t.id].audio;n.paused?n.play():n.pause()},rewindSoundUniformChannel(e){const t=this.currentPass.channels[e];if(!t||"sound"!==t.category)return;this.audioPlaying[t.id].audio.currentTime=0},muteSoundUniformChannel(e){const t=this.currentPass.channels[e];if(!t||"sound"!==t.category)return;const n=this.audioPlaying[t.id];n.audio,n.muted=!n.muted,n.gain.gain.value=n.muted?0:1},startCapture(e){switch(this.exportFramesCount=parseInt(e.frames??120),this.captureFrameCount=1,this.format=e.format??"gif",this.format){case"gif":this.mimeType="image/gif";break;case"png":this.mimeType="image/png";break;case"webm":this.mimeType="video/webm"}this.capturer=new CCapture({format:this.format,framerate:parseInt(e.framerate??30),workersPath:"./src/extra/"}),this.capturer.start()},saveCapture(){if(!this.capturer)return;this.capturer.stop();this.capturer.save(e=>(download(e,`${this.shader.name}.${this.format}`,this.mimeType),delete this.capturer,delete this.frameCount,B.onStopCapture(),!1))},async saveComment(e,t){if(await N.createDocument(c.INTERACTIONS_COLLECTION_ID,{type:"comment",shader_id:e,author_id:N.getUserId(),text:t}),!t.includes("@"))return;return!![...t.matchAll(/(^|\s)@([a-zA-Z0-9._]+)/g)].map(e=>e[2]).length||void 0},async snapshotCanvas(e,t){const n=e??640,a=t??360,o=await(()=>new Promise(e=>(this.onFrame(),this.renderer.canvas.toBlob(t=>e(t),"image/png"))))(),s=await createImageBitmap(o),i=document.createElement("canvas");i.width=n,i.height=a;return i.getContext("2d").drawImage(s,0,0,n,a),new Promise(e=>i.toBlob(t=>e(t),"image/png"))},async getCanvasSnapshot(){const e=await this.snapshotCanvas(),t=URL.createObjectURL(e);window.open(t)},async _makeAIPrompt(e){const t=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"x-api-key":localStorage.getItem("ANTHROPIC_KEY"),"Content-Type":"application/json"},body:JSON.stringify(e)});return await t.text()},async _explainLinesAI(e,t){const n={model:"claude-haiku-4-5-20251001",max_tokens:1e3,system:"You are a GLSL shader expert. Explain shader code clearly and concisely.\n                Keep explanations beginner-friendly but technically accurate.\n                When explaining, focus on: what it does visually, what the math means, and why it's written that way.\n                Never explain lines the user didn't select unless it's necessary for context.",messages:[{role:"user",content:`Full shader for context:\n                \`\`\`glsl\n                ${t}\n                \`\`\`\n\n                Explain these selected lines:\n                \`\`\`glsl\n                ${e}\n                \`\`\``}]};return this._makeAIPrompt(n)}};await $.init();export{$ as ShaderHub};
